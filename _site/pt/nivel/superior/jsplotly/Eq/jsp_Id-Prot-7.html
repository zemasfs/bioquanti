<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSPlotly</title>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.20.0/plotly.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.1/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ml-regression@6.0.0/dist/ml-regression.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>    
    <script src="https://cdn.jsdelivr.net/npm/ml-levenberg-marquardt@3.3.0/dist/ml-levenberg-marquardt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.5/jstat.min.js"></script>

 <!---<body style="margin:0; padding:0;">--->


    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { display: flex; justify-content: space-between; align-items: flex-start; }
        #grafico { width: 55%; height: 500px; }
        #editor-container { width: 40%; }
        #editor { width: 100%; height: 350px; border: 1px solid #ccc; }

.header-bar {
    width: 100%;
    height: 30px; 
    background: linear-gradient(to right, #F5F5DC, #EDEAE0); 
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    color: #5a4a42; /
    letter-spacing: 2px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); 
    margin-bottom: 40px;  
}



.license-info {
  font-size: 12px;
  color: gray;
  font-family: Arial, sans-serif;
  opacity: 0.8;
  text-align: center;
  margin: 30px auto 10px auto;
}


#toggleTheme {
  position: relative;
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
  margin: -2px 0 0 10px; /* margem superior e esquerda */
  display: inline-block;
  z-index: 10;
}



.dev-info {
    position: absolute;
    top: 3px; 
    left: 10px; 
    font-size: 13px !important; 
    color: #999; 
    font-family: Arial, sans-serif;
}

.dev-info a {
    text-decoration: none;
    color: #888; 
    font-weight: bold;
}
.dev-info a:hover {
    text-decoration: underline;
    color: #666; /
}

       
.button-container { 
    display: flex; 
    gap: 10px; 
    margin-top: 10px; 

  position: relative;
  z-index: 10;
}

button { 
    padding: 10px; 
    cursor: pointer; 
    border: none; 
    font-size: 14px; 
    border-radius: 5px; 
    transition: background 0.3s ease-in-out; 
}


/* Bot√£o base */
button {
  padding: 10px;
  cursor: pointer;
  font-size: 14px;
  border-radius: 8px;
  border: 2px solid transparent;
  transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
}

.add-btn {
  background: #e2f6e9;
  color: #207a44;
  border-color: #b1e2c3;
}
.add-btn:hover {
  background: #ccf0dd;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(50, 150, 100, 0.3);
}

.remove-btn {
  background: #fff8c6;
  color: #887200;
  border-color: #f0dc7d;
}
.remove-btn:hover {
  background: #fdf2a8;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(200, 180, 20, 0.3);
}

.reset-btn {
  background: #fce1e1;
  color: #b42c2c;
  border-color: #f4b6b6;
}
.reset-btn:hover {
  background: #f8caca;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(200, 50, 50, 0.3);
}

.save-btn {
  background: #fff1db;
  color: #8a4b00;
  border-color: #ffd9a2;
}
.save-btn:hover {
  background: #ffe1ba;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(200, 120, 30, 0.3);
}

.clear-btn {
  background: #f99;
  color: white;
  border-color: #d33;
}
.clear-btn:hover {
  background: #e55;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(255, 80, 80, 0.5);
}

.save-html-btn {
  background: #e6f1fb;
  color: #125a8f;
  border-color: #a8d0f0;
}
.save-html-btn:hover {
  background: #d2e9fc;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(50, 100, 200, 0.3);
}


.author-info { position: absolute; top: 60px; right: 20px; font-size: 14px; color: gray; }
.logo { position: fixed; bottom: 10px; right: 20px; width: 100px; z-index: 10;} 
.ascii-logo {
 position: fixed;
 bottom: 10px;
 right: 20px;
 font-family: monospace;
 font-size: 2px;
 white-space: pre;
 text-align: right;
 z-index: 10; 
 }
 
.save-project-btn {
  background: linear-gradient(to bottom, #f3e6ff, #d3bdf0);
  color: #5e2d91;
  font-weight: normal;
  border: 2px solid #b48ce3;
  border-radius: 8px;
  box-shadow: 0 0 6px rgba(140, 90, 200, 0.4);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.save-project-btn:hover {
  background: linear-gradient(to bottom, #e7d4ff, #c9aee8);
  transform: scale(1.05);
  box-shadow: 0 0 8px rgba(120, 60, 180, 0.5);
}


</style>


<style>
  @media (max-width: 768px) {
    .container {
      flex-direction: column;
      align-items: stretch;
    }

    #grafico {
      width: 100% !important;
      height: 300px !important;
    }

    #editor-container {
      width: 100% !important;
    }

    #editor {
      height: 300px !important;
    }

    .button-container {
      flex-direction: column;
      gap: 8px;
    
  position: relative;
  z-index: 10;
}

    button {
      width: 100%;
      font-size: 16px;
    }

    .header-bar {
      font-size: 16px;
    }

    .popup {
      width: 90%;
    }

    .external-link {
      position: relative;
      top: auto;
      right: auto;
      margin-top: 10px;
      text-align: right;
    }
  }
</style>


<style>
  body.dark-mode {
    background-color: #1e1e1e;
    color: #e0e0e0;
  }

  body.dark-mode .header-bar {
    background: linear-gradient(to right, #2e2e2e, #1a1a1a);
    color: #f0f0f0;
  }

  body.dark-mode .button-container button {
    background: #333 !important;
    color: #ddd !important;
  }

  body.dark-mode .clear-btn {
    background-color: #a71d2a !important;
    color: white !important;
  }

  body.dark-mode #editor {
    background-color: #1e1e1e;
    color: #e0e0e0;
  }

  body.dark-mode .popup {
    background-color: #2b2b2b;
    color: #eee;
  }
  
</style>


</head>


<body>
<div class="header-bar" style="display: flex; align-items: center; justify-content: space-between; padding: 4px 10px;">
  <button id="toggleTheme" onclick="alternarTema()" style="font-size: 18px; background: none; border: none; cursor: pointer;">
    üåô
  </button>

  <div style="flex: 1; text-align: center; font-weight: bold; font-size: 16px;">
    JSPlotly - Interactive Graphics
  </div>

  <div style="width: 30px;"><!-- espa√ßo vazio para equilibrar com o bot√£o da esquerda --></div>
</div>




<div class="external-link">
  <a href="https://bioquanti.netlify.app/" target="_blank">üîó Bioquanti</a>  
</div>


<div class="dev-info">
    Developed with 
    <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript" target="_blank">JavaScript</a> 
    and 
    <a href="https://plotly.com/javascript/" target="_blank">Plotly.js</a>
</div>

<div class="container">

 <div id="grafico"></div>

<div id="popup" class="popup">
    <p>Save as:</p>
    <button onclick="salvarImagem('png')">PNG</button>
    <button onclick="salvarImagem('svg')">SVG</button>
    <button onclick="fecharPopup()">Cancelar</button>
</div>

<style>
.popup {
    display: none;
    position: fixed;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    border: 1px solid #ccc;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    z-index: 1000;
}
.popup button {
    margin: 5px;
    padding: 8px;
}

.external-link {  
  position: absolute;
  top: 30px;
  right: 20px;
  font-size: 14px;
  font-family: Arial, sans-serif;
}

.external-link a {
  color: #333;
  text-decoration: none;
  font-weight: bold;
}

.external-link a:hover {
  text-decoration: underline;
  color: #0077cc;
}

.save-html-btn {
  background: linear-gradient(to bottom, #dff0f7, #add9e6);
  color: #004b66;
  font-weight: normal;
  border: 2px solid #66b8d4;
  border-radius: 8px;
  box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.save-html-btn:hover {
  background: linear-gradient(to bottom, #c4ecff, #8fd3ec);
  transform: scale(1.05);
  box-shadow: 0 0 8px rgba(0, 123, 255, 0.8);
}


</style>

  <div id="editor-container">
  

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
  <input type="file" id="fileInput" accept=".js" onchange="carregarEquacaoAuto(event)">
  
  <span style="font-size: 13px; font-family: Arial, sans-serifbioq; color: #2e7d57; text-align: right;">
    For easy code construction, try 
    <a href="https://chatgpt.com/g/g-6819fbb8d2d08191bf7d50a3dbeadb0d-gsplotly" 
       target="_blank" 
       style="color: #2e7d57 !important; font-weight: bold; text-decoration: underline;">
      GSPlotly
    </a>
  </span>
</div>





       <div id="editor"></div>
       <div class="button-container">
       <button class="add-btn" onclick="adicionarCurva()">add</button>
       <button class="remove-btn" onclick="removerUltimaCurva()">remove</button>
       <button class="clear-btn" onclick="resetarGrafico()">clean</button> 
       <button class="reset-btn" onclick="limparEditor()">delete</button>
     <!---  <button class="save-html-btn" onclick="salvarHTML()">html</button> --->             
       <button class="save-btn" onclick="salvarEquacao()">script</button> 
       <button class="save-html-btn" onclick="salvarProjetoSomenteGrafico()">html</button>
    <!---<button class="save-html-btn" onclick="salvarProjetoCompleto()">save project</button> --->
       <button class="save-project-btn" onclick="salvarCloneJSPlotly()">clone</button>
       
    
  </div>
</div>
    </div>
    
    
<script>
 var curvas = [];
 var cores = ["red", "blue", "green", "purple", "orange", "brown", "pink", "gray"];
 var corIndex = 0;
 var editor = ace.edit("editor");
 editor.setTheme("ace/theme/github");
 editor.session.setMode("ace/mode/javascript");
 editor.session.setUseWrapMode(true);
 editor.setOptions({
  fontSize: "14px",
  wrap: true,
  showPrintMargin: false
});



var customSaveButton = {
    name: 'PNG or SVG',
    icon: Plotly.Icons.disk,
    click: function(gd) {
        abrirPopup();
    }
};


var config = {
  modeBarButtonsToAdd: [
    'toggleSpikelines',
    'hoverCompareCartesian',
    'drawline',
    'drawopenpath',
    'drawrect',
    'drawcircle',
    //'eraseshape',
    customSaveButton,
    {
      name: 'change color',
      icon: Plotly.Icons.camera,
      click: function(gd) {
        const ultima = curvas.length - 1;
        const novaCor = cores[Math.floor(Math.random() * cores.length)];
        Plotly.restyle(gd, { 'line.color': novaCor }, [ultima]);
        curvas[ultima].line.color = novaCor;
      }
    },
  {
  name: 'Adicionar Texto',
  icon: {
    width: 1000,
    height: 1000,
    path: 'M200 800V160h600v80H540v560h-80V240H200z' // √çcone simples em forma de "T"
  },
  click: function(gd) {
    // O clique no bot√£o ativa o modo de anota√ß√£o
    const handler = function(eventData) {
      const x = eventData.points[0].x;
      const y = eventData.points[0].y;
      const texto = prompt("Digite o texto a ser inserido:");
      if (texto) {
        Plotly.relayout(gd, {
          annotations: (gd.layout.annotations || []).concat([{
            x: x,
            y: y,
            text: texto,
            showarrow: true,
            arrowhead: 2
          }])
        });
      }
      gd.removeListener('plotly_click', handler);
    };
    gd.on('plotly_click', handler);
  }
}
  ],
  showEditInChartStudio: true,
  plotlyServerURL: "https://chart-studio.plotly.com",
  displaylogo: false,
  displayModeBar: true,
  responsive: true,
  scrollZoom: true,
  editable: true,
  modeBarButtonsToRemove: [
    'select2d',
    'lasso2d',
    'resetScale2d',
    'zoomOut2d',
    'zoomIn2d',
    'toImage'
  ]
};
 

function executarCodigo() {
    try {
        var codigoUsuario = editor.getValue().trim();
        Plotly.purge('grafico'); 
        eval(codigoUsuario);
    } 

catch (error) {
           
    }
}

function limparGrafico() {
    Plotly.purge('grafico');
}

function carregarEquacaoAuto(event) {
 const file = event.target.files[0];
 if (file) {
   const reader = new FileReader();
         reader.onload = function(e) {
         editor.setValue(e.target.result, -1);
                 };
         reader.readAsText(file);
                 }
           }

function adicionarCurva() {
  const codigoUsuario = editor.getValue();

  let consoleSaida = [];
  const logOriginal = console.log;
  console.log = (...args) => {
    consoleSaida.push(args.map(arg => typeof arg === "object" ? JSON.stringify(arg) : String(arg)).join(" "));
  };

  let resultado;
  try {
    const func = new Function(codigoUsuario + "\nreturn typeof output !== 'undefined' ? output : undefined;");
    resultado = func();
  } catch (e1) {
    try {
      const func = new Function(codigoUsuario);
      resultado = func();
    } catch (e2) {
      console.log = logOriginal;
      alert("Erro ao executar o c√≥digo:\n" + e2.message);
      return;
    }
  }

  console.log = logOriginal;
  if (!resultado) return;

  const texto = consoleSaida.map(l => "> " + l).join("<br>");
  const layout = resultado.layout || {};
  layout.annotations = layout.annotations || [];

  if (texto.trim()) {
    layout.annotations.push({
      text: `<div style="font-family: monospace; font-size: 14px; max-height: 200px; overflow-y: auto; background:#f9f9f9; padding:5px; border:1px solid #ccc;">${texto}</div>`,
      showarrow: false,
      xref: 'paper',
      yref: 'paper',
      x: 0,
      y: 1,
      align: 'left',
      xanchor: 'left',
      yanchor: 'top'
    });
  }

const config = {
  responsive: true,
  displaylogo: false,
  scrollZoom: true,
  editable: true,
  modeBarButtonsToRemove: ['sendDataToCloud'],
  modeBarButtonsToAdd: [
    'toggleSpikelines',
    'hoverCompareCartesian',
    'drawline',
    'drawopenpath',
    'drawrect',
    'drawcircle',
    {
      name: 'Salvar PNG/SVG',
      icon: Plotly.Icons.disk,
      click: () => abrirPopup()
    },
    {
      name: 'Mudar cor',
      icon: Plotly.Icons.camera,
      click: function(gd) {
        const ultima = curvas.length - 1;
        const novaCor = cores[Math.floor(Math.random() * cores.length)];
        Plotly.restyle(gd, { 'line.color': novaCor }, [ultima]);
        curvas[ultima].line.color = novaCor;
      }
    },
    {
      name: 'Adicionar Texto',
      icon: {
        width: 1000,
        height: 1000,
        path: 'M200 800V160h600v80H540v560h-80V240H200z'
      },
      click: function(gd) {
        const handler = function(eventData) {
          const x = eventData.points[0].x;
          const y = eventData.points[0].y;
          const texto = prompt("Digite o texto a ser inserido:");
          if (texto) {
            Plotly.relayout(gd, {
              annotations: (gd.layout.annotations || []).concat([{
                x, y, text: texto, showarrow: true, arrowhead: 2
              }])
            });
          }
          gd.removeListener('plotly_click', handler);
        };
        gd.on('plotly_click', handler);
      }
    }
  ]
};


  let data = [];
  if (resultado.data) {
    data = resultado.data;
  } else if (resultado.trace) {
    data = [resultado.trace];
  } else if (resultado.traces) {
    data = resultado.traces;
  } else if (resultado.x_values && resultado.y_values) {
    data = [{
      x: resultado.x_values,
      y: resultado.y_values,
      type: 'scatter',
      mode: 'lines+markers',
      name: resultado.title || "Curva"
    }];
    if (resultado.x_range) layout.xaxis = { range: resultado.x_range, title: resultado.x_label || "" };
    if (resultado.y_range) layout.yaxis = { range: resultado.y_range, title: resultado.y_label || "" };
    layout.title = resultado.title || "";
  }

  curvas.push(...data);

  Plotly.newPlot("grafico", curvas, layout, config).then(() => {
    if (resultado.frames && resultado.frames.length > 0) {
      Plotly.addFrames("grafico", resultado.frames);
      Plotly.animate("grafico", null, {
        frame: { duration: 80, redraw: true },
        transition: { duration: 0 }
      });
    }
  });
}




function resetarGrafico() {
            curvas = [];
            corIndex = 0;
            Plotly.newPlot('grafico', [], {xaxis: { title: 'X' }, yaxis: {
          zeroline: true,
          zeroline: true, title: 'Y' } });
        }

function salvarEquacao() {
    var blob = new Blob([editor.getValue()], { type: "text/javascript" });
    var a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "script.js";
        document.body.appendChild(a);
        a.click();
            document.body.removeChild(a);
       }

        

function salvarHTML() {
    var plotlyData = JSON.parse(JSON.stringify(curvas));
    var plotlyLayout = document.getElementById('grafico').layout;
    var htmlContent = '<!DOCTYPE html>\n' +
                '<html>\n' +
                '<head>\n' +
                '    <meta charset="UTF-8">\n' +
                '    <title>Gr√°fico Salvo</title>\n' +
                '    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.20.0/plotly.min.js"><\/script>\n' +
                '</head>\n' +////
                '<body>\n' +
                '    <div id="grafico" style="width: 100%; height: 600px;"></div>\n' +
                '    <script>\n' +
                '        var data = ' + JSON.stringify(plotlyData) + ';\n' +
                '        var layout = ' + JSON.stringify(plotlyLayout) + ';\n' +
                '        Plotly.newPlot("grafico", data, layout);\n' +
                '    <\/script>\n' +
                '</body>\n' +
                '</html>';

function salvarAppCompleto() {
  const htmlBase = document.documentElement.outerHTML;
  const blob = new Blob([htmlBase], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "jsplotly_completo.html";
  a.click();
}


var blob = new Blob([htmlContent], { type: 'text/html' });
var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
//    a.download = 'grafico_interativo.html';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
        }

function limparEditor() {
    editor.setValue("", -1); 
    }

function removerUltimaCurva() {
    if (curvas.length > 0) {
    curvas.pop(); 
    atualizarGrafico(); 
        } else {
        alert("No curves to remove!");
      }
    }


function atualizarGrafico() {
    Plotly.newPlot('grafico', curvas, {
        title: 'Gr√°fico Interativo',
        xaxis: { title: 'X' },
        yaxis: {
          zeroline: true,
          zeroline: true, title: 'Y' },
        showlegend: true
    });
}

function abrirPopup() {
    document.getElementById('popup').style.display = 'block';
}

function fecharPopup() {
    document.getElementById('popup').style.display = 'none';
}

function salvarImagem(formato) {
    Plotly.downloadImage('grafico', {format: formato, filename: 'plot'});
    fecharPopup();
}


function limparTudo() {
   editor.setValue("", -1);
     let graficoDiv = document.getElementById("grafico");
     if (graficoDiv) {
            Plotly.newPlot("grafico", [], {
            xaxis: { title: "Eixo X" },
            yaxis: {
          zeroline: true,
          zeroline: true, title: "Eixo Y" }
        });
        graficoDiv.data = [];
    }
}


// Definir a equa√ß√£o quadr√°tica padr√£o
var codigoPadrao = `
// ===== Biomol-ID (bundle v6) ‚Äî peptidio ~ proteina equivalentes =====
// ASCII-free, idempotente, compat JSPlotly2
(function(){
  // reset duro
  try{
    if (window.__BIOMOL_OBS__ && window.__BIOMOL_OBS__.disconnect) window.__BIOMOL_OBS__.disconnect();
    delete window.__BIOMOL_OBS__;
    ['biomol_ui','biomol_msg','biomol_table'].forEach(function(id){
      var n=document.getElementById(id); if(n&&n.parentNode) n.parentNode.removeChild(n);
    });
    delete window.__BIOMOLID__; delete window.codigoPadrao; delete window.uiExtra; delete window.__BIOMOL_fixplot__;
  }catch(e){}

  // core
  var P={purple:'#6a0dad',lightblue:'#87cefa',yellow:'#ffd300',red:'#d32f2f',orange:'#ff9800',wine:'#722f37',brown:'#795548',gray:'#cccccc'};
  var RXN=['Ninhidrina','Biureto','Pauly','Xantoproteica','Sakaguchi','Millon','Enxofre'];
  var AAs=[
    {code:'A',name:'Ala',aromatic:false,tyr:false,his:false,arg:false,cys:false},
    {code:'R',name:'Arg',aromatic:false,tyr:false,his:false,arg:true,cys:false},
    {code:'N',name:'Asn',aromatic:false,tyr:false,his:false,arg:false,cys:false},
    {code:'D',name:'Asp',aromatic:false,tyr:false,his:false,arg:false,cys:false},
    {code:'C',name:'Cys',aromatic:false,tyr:false,his:false,arg:false,cys:true},
    {code:'E',name:'Glu',aromatic:false,tyr:false,his:false,arg:false,cys:false},
    {code:'Q',name:'Gln',aromatic:false,tyr:false,his:false,arg:false,cys:false},
    {code:'G',name:'Gly',aromatic:false,tyr:false,his:false,arg:false,cys:false},
    {code:'H',name:'His',aromatic:false,tyr:false,his:true,arg:false,cys:false},
    {code:'I',name:'Ile',aromatic:false,tyr:false,his:false,arg:false,cys:false},
    {code:'L',name:'Leu',aromatic:false,tyr:false,his:false,arg:false,cys:false},
    {code:'K',name:'Lys',aromatic:false,tyr:false,his:false,arg:false,cys:false},
    {code:'M',name:'Met',aromatic:false,tyr:false,his:false,arg:false,cys:false},
    {code:'F',name:'Phe',aromatic:true,tyr:false,his:false,arg:false,cys:false},
    {code:'P',name:'Pro',aromatic:false,tyr:false,his:false,arg:false,cys:false},
    {code:'S',name:'Ser',aromatic:false,tyr:false,his:false,arg:false,cys:false},
    {code:'T',name:'Thr',aromatic:false,tyr:false,his:false,arg:false,cys:false},
    {code:'W',name:'Trp',aromatic:true,tyr:false,his:false,arg:false,cys:false},
    {code:'Y',name:'Tyr',aromatic:true,tyr:true,his:false,arg:false,cys:false},
    {code:'V',name:'Val',aromatic:false,tyr:false,his:false,arg:false,cys:false}
  ];
  function ri(a,b){return Math.floor(Math.random()*(b-a+1))+a;}
  function pick(l){return l[ri(0,l.length-1)];}
  function hasAny(arr,nm){for(var i=0;i<arr.length;i++) if(nm.indexOf(arr[i])>=0) return true; return false;}

  // presets do gerador (inclui AA simples)
  var PRESETS={
    auto:null,
    so_none:{none:true},
    so_his:{his:true}, so_tyr:{tyr:true,aromatic:true}, so_cys:{cys:true}, so_arom:{aromatic:true,tyr:false}, so_arg:{arg:true},
    mix_his_tyr:{his:true,tyr:true,aromatic:true}, mix_tyr_arg:{tyr:true,arg:true,aromatic:true},
    mix_his_cys:{his:true,cys:true}, mix_tyr_cys:{tyr:true,cys:true,aromatic:true}, mix_his_arg:{his:true,arg:true}
  };

  // >>> SUBSTITUA makeSampleRandom pelo bloco abaixo (v6.2) <<<
function makeSampleRandom(){
  // pesos (ajuste √† vontade):
  //  - AA simples / Mix simples (sem grupos): 25%
  //  - Mix com 1 perfil (S√≥ His/Tyr/Arg/Cys/arom√°tico): 30%
  //  - Mix com 2 perfis (His+Tyr, Tyr+Arg, His+Cys, Tyr+Cys, His+Arg): 25%
  //  - Pept√≠deo: 10%
  //  - Prote√≠na: 10%
  var r = Math.random();

  // helpers
  function mixFromFlags(flags){
    var s={type:'mix',aa:null,peptide_len:0,mix:[],comp:{tyr:false,his:false,arg:false,cys:false,aromatic:false}};
    s.comp.his=!!flags.his; s.comp.tyr=!!flags.tyr; s.comp.arg=!!flags.arg; s.comp.cys=!!flags.cys;
    s.comp.aromatic=!!flags.aromatic || !!flags.tyr;  // Tyr j√° conta como arom√°tico
    // monta r√≥tulo da mistura (decorativo)
    var names=[];
    if(s.comp.his) names.push('His');
    if(s.comp.tyr) names.push('Tyr');
    if(s.comp.arg) names.push('Arg');
    if(s.comp.cys) names.push('Cys');
    if(s.comp.aromatic && !s.comp.tyr) names.push(Math.random()<0.5?'Phe':'Trp'); // arom√°tico sem Tyr
    //if(names.length<2) names.push('Gly'); // garante pelo menos 2 para ‚Äúcara de mistura‚Äù
    s.mix = Array.from(new Set(names));
    return s;
  }

  // 1) AA/Mix ‚Äúsimples‚Äù (sem grupos especiais)
  if (r < 0.25){
    if (Math.random() < 0.5){
      // AA simples
      var pool=AAs.filter(function(a){return !a.his && !a.tyr && !a.arg && !a.cys && !a.aromatic;});
      var aa=pick(pool);
      return {type:'aa',aa:aa,peptide_len:0,mix:[],comp:{tyr:false,his:false,arg:false,cys:false,aromatic:false}};
    } else {
      // Mistura simples (mesma assinatura de AA simples)
      return mixFromFlags({}); // todos falsos
    }
  }

  // 2) Mix com 1 perfil (S√≥ His/Tyr/Cys/Arg/arom√°tico)
  if (r < 0.55){
    var singles=['his','tyr','cys','arg','aromatic'];
    var k = pick(singles);
    var flags={his:false,tyr:false,cys:false,arg:false,aromatic:false};
    flags[k]=true;
    return mixFromFlags(flags);
  }

  // 3) Mix com 2 perfis (as cinco combina√ß√µes solicitadas)
  if (r < 0.80){
    var pairs=[
  ['his','tyr'], ['tyr','arg'], ['his','cys'], ['tyr','cys'], ['his','arg'],
  ['aromatic','arg'] // novo par: arom√°ticos (sem Tyr) + Arg
];

    var pair = pick(pairs);
    var flags={his:false,tyr:false,cys:false,arg:false,aromatic:false};
    flags[pair[0]]=true; flags[pair[1]]=true;
    return mixFromFlags(flags);
  }

  // 4) Pept√≠deo
  if (r < 0.90){
    var s={type:'peptidio',aa:null,peptide_len:ri(4,12),mix:[],comp:{tyr:false,his:false,arg:false,cys:false,aromatic:false}};
    var n=ri(5,10), names=[]; for (var i=0;i<n;i++) names.push(pick(AAs).name);
    s.comp.tyr=names.indexOf('Tyr')>=0; s.comp.his=names.indexOf('His')>=0; s.comp.arg=names.indexOf('Arg')>=0; s.comp.cys=names.indexOf('Cys')>=0;
    s.comp.aromatic = s.comp.tyr || hasAny(names,['Phe','Trp']);
    return s;
  }

  // 5) Prote√≠na
  var s2={type:'proteina',aa:null,peptide_len:ri(80,400),mix:[],comp:{tyr:false,his:false,arg:false,cys:false,aromatic:false}};
  s2.comp.tyr=Math.random()<0.6; s2.comp.his=Math.random()<0.4; s2.comp.arg=Math.random()<0.6; s2.comp.cys=Math.random()<0.5;
  s2.comp.aromatic = s2.comp.tyr || Math.random()<0.7;
  return s2;
}


  function makeSamplePreset(key){
    var p=PRESETS[key]; if(!p) return makeSampleRandom();
    if(p.none){
      var pool=AAs.filter(function(a){return !a.his && !a.tyr && !a.arg && !a.cys && !a.aromatic;});
      var aa=pick(pool);
      return {type:'aa',aa:aa,peptide_len:0,mix:[],comp:{tyr:false,his:false,arg:false,cys:false,aromatic:false}};
    }
    var s={type:'mix',aa:null,peptide_len:0,mix:[],comp:{tyr:false,his:false,arg:false,cys:false,aromatic:false}};
    s.comp.his=!!p.his; s.comp.tyr=!!p.tyr; s.comp.arg=!!p.arg; s.comp.cys=!!p.cys; s.comp.aromatic=!!p.aromatic||!!p.tyr;
    var names=[];
if(s.comp.his) names.push('His');
if(s.comp.tyr) names.push('Tyr');
if(s.comp.arg) names.push('Arg');
if(s.comp.cys) names.push('Cys');
if(s.comp.aromatic && !s.comp.tyr) names.push(Math.random()<0.5?'Phe':'Trp');
// sem preenchimento artificial com Gly
s.mix = Array.from(new Set(names));

    return s;
  }

  function reactionColors(s){
    var c=[]; c.push(P.purple);
    c.push((s.type==='peptidio'||s.type==='proteina')?P.purple:P.lightblue);
    var pa=P.gray; if(s.comp.his&&s.comp.tyr) pa=P.orange; else if(s.comp.tyr) pa=P.red; else if(s.comp.his) pa=P.yellow;
    c.push(pa);
    c.push(s.comp.aromatic?P.yellow:P.gray);
    c.push(s.comp.arg?P.red:P.gray);
    c.push(s.comp.tyr?P.wine:P.gray);
    c.push(s.comp.cys?P.brown:P.gray);
    return c;
  }

  function describeSample(s){
  // tipo "observ√°vel" pelo padr√£o (sem deduzir al√©m do poss√≠vel)
  var isPeptProt = (s.type==='peptidio' || s.type==='proteina');
  if (isPeptProt) return (s.type==='peptidio' ? 'Peptidio (len '+s.peptide_len+')' : 'Proteina');
  if (detectPerfil(s)==='mix_arom_arg') return 'Mistura de AAs (aromaticos sem Tyr + Arg)';


  // perfis detect√°veis pelos testes
  var prof = detectPerfil(s);

  // casos de 1 marcador (ou nenhum): n√£o d√° para distinguir AA de Mistura
  if (prof==='so_none') return 'Amostra com perfil simples (AA ou Mistura)';
  if (prof==='so_his')  return 'Amostra com perfil: So His (AA ou Mistura)';
  if (prof==='so_tyr')  return 'Amostra com perfil: So Tyr (AA ou Mistura)';
  if (prof==='so_cys')  return 'Amostra com perfil: So Cys (AA ou Mistura)';
  if (prof==='so_arg')  return 'Amostra com perfil: So Arg (AA ou Mistura)';
  if (prof==='so_arom') return 'Amostra com perfil: So aromaticos (AA ou Mistura)';

  // perfis de 2 marcadores: aqui sim √© claramente mistura
  if (prof==='mix_his_tyr') return 'Mistura de AAs (contendo His + Tyr)';
  if (prof==='mix_tyr_arg') return 'Mistura de AAs (contendo Tyr + Arg)';
  if (prof==='mix_his_cys') return 'Mistura de AAs (contendo His + Cys)';
  if (prof==='mix_tyr_cys') return 'Mistura de AAs (contendo Tyr + Cys)';
  if (prof==='mix_his_arg') return 'Mistura de AAs (contendo His + Arg)';

  // fallback (n√£o deveria ocorrer)
  if (s.type==='aa' && s.aa) return 'AA: '+s.aa.name;
  return 'Amostra';
}



  function explainReactions(s){
    var parts=[];
    parts.push('Ninhidrina: positivo geral (aminas livres)');
    parts.push('Biureto: '+((s.type==='peptidio'||s.type==='proteina')?'positivo (ligacoes peptidicas)':'azul claro (AAs livres)'));
    var pa=(s.comp.his&&s.comp.tyr)?'laranja (His+Tyr)':(s.comp.tyr?'vermelho (Tyr)':(s.comp.his?'amarelo (His)':'negativo'));
    parts.push('Pauly: '+pa);
    parts.push('Xantoproteica: '+(s.comp.aromatic?'amarelo (aromaticos)':'negativo'));
    parts.push('Sakaguchi: '+(s.comp.arg?'vermelho (Arg)':'negativo'));
    parts.push('Millon: '+(s.comp.tyr?'vinho (Tyr)':'negativo'));
    parts.push('Enxofre: '+(s.comp.cys?'marrom (Cys)':'negativo'));
    return parts.join(' | ');
  }

  // perfil detector
  function detectPerfil(s){
    // arom√°ticos (Phe/Trp) + Arg, explicitamente sem Tyr
if (s.comp.arg && s.comp.aromatic && !s.comp.tyr) return 'mix_arom_arg';

    if(!s.comp.his && !s.comp.tyr && !s.comp.arg && !s.comp.cys && !s.comp.aromatic) return 'so_none';
    if(s.comp.his && s.comp.tyr) return 'mix_his_tyr';
    if(s.comp.tyr && s.comp.arg) return 'mix_tyr_arg';
    if(s.comp.his && s.comp.cys) return 'mix_his_cys';
    if(s.comp.tyr && s.comp.cys) return 'mix_tyr_cys';
    if(s.comp.his && s.comp.arg) return 'mix_his_arg';
    if(!s.comp.tyr && s.comp.aromatic) return 'so_arom';
    if(s.comp.his) return 'so_his';
    if(s.comp.tyr) return 'so_tyr';
    if(s.comp.cys) return 'so_cys';
    if(s.comp.arg) return 'so_arg';
    return 'nenhum';
  }

  // expor API
  window.__BIOMOLID__={
    PALETTE:P, RXN:RXN, AAs:AAs, PRESETS:PRESETS,
    state:{sample:null, score:0, rounds:0, hideLabels:false, shuffle:false, presetKey:'auto'},
    makeSampleRandom:makeSampleRandom, makeSamplePreset:makeSamplePreset,
    reactionColors:reactionColors, describeSample:describeSample, explainReactions:explainReactions, detectPerfil:detectPerfil
  };

  // layout helper (centraliza e puxa mais para a esquerda)
  function fixplot(){
    var g=document.getElementById('grafico'); if(!g) return;
    g.style.minHeight='460px'; g.style.height='460px'; g.style.width='95%';
    g.style.display='block'; g.style.margin='6px auto';
    try{
      Plotly.relayout(g,{
        'margin.l':10,'margin.r':40,'margin.t':36,'margin.b':60,
        'title.font.size':16,'xaxis.automargin':true,'yaxis.automargin':true
      });
      Plotly.Plots.resize(g);
    }catch(e){}
  }
  window.__BIOMOL_fixplot__=fixplot;

  // grafico principal (compat "add")
  window.codigoPadrao=function(){
    var M=window.__BIOMOLID__;
    if(!M.state.sample){
      M.state.sample=(M.state.presetKey && M.state.presetKey!=='auto')?M.makeSamplePreset(M.state.presetKey):M.makeSampleRandom();
    }
    var names=M.RXN.slice(); if(M.state.shuffle) names.sort(function(){return Math.random()-0.5;});
    var colors=M.reactionColors(M.state.sample), map={}; for(var i=0;i<M.RXN.length;i++) map[M.RXN[i]]=colors[i];
    var barColors=names.map(function(n){return map[n];});
    var data=[{type:'bar',x:names,y:names.map(function(){return 1;}),marker:{color:barColors},hoverinfo:'x',text:names,textposition:'none'}];
    var layout={title:'Tubos de ensaio (resultado das reacoes)',showlegend:false,yaxis:{visible:false,range:[0,1.2]},
                xaxis:{tickangle:-15,showticklabels:!M.state.hideLabels},
                bargap:0.25,margin:{l:10,r:40,t:36,b:60},paper_bgcolor:'white',plot_bgcolor:'white'};
    return {data:data,layout:layout,frames:[]};
  };

  // tabela e CSV
  function resultsFor(s){
    var out=[];
    out.push({teste:'Ninhidrina',cor:P.purple,resultado:'positivo (aminas livres)'});
    out.push((s.type==='peptidio'||s.type==='proteina')?{teste:'Biureto',cor:P.purple,resultado:'positivo (ligacoes peptidicas)'}:{teste:'Biureto',cor:P.lightblue,resultado:'AAs livres (azul claro)'});
    if(s.comp.his&&s.comp.tyr) out.push({teste:'Pauly',cor:P.orange,resultado:'His + Tyr (laranja)'}); else
    if(s.comp.tyr) out.push({teste:'Pauly',cor:P.red,resultado:'Tyr (vermelho)'}); else
    if(s.comp.his) out.push({teste:'Pauly',cor:P.yellow,resultado:'His (amarelo)'}); else
      out.push({teste:'Pauly',cor:P.gray,resultado:'negativo'});
    out.push(s.comp.aromatic?{teste:'Xantoproteica',cor:P.yellow,resultado:'aromaticos (amarelo)'}:{teste:'Xantoproteica',cor:P.gray,resultado:'negativo'});
    out.push(s.comp.arg?{teste:'Sakaguchi',cor:P.red,resultado:'Arg (vermelho)'}:{teste:'Sakaguchi',cor:P.gray,resultado:'negativo'});
    out.push(s.comp.tyr?{teste:'Millon',cor:P.wine,resultado:'Tyr (vinho)'}:{teste:'Millon',cor:P.gray,resultado:'negativo'});
    out.push(s.comp.cys?{teste:'Enxofre',cor:P.brown,resultado:'Cys (marrom)'}:{teste:'Enxofre',cor:P.gray,resultado:'negativo'});
    return out;
  }

  function renderTable(){
    var host=document.getElementById('grafico'); if(!host) return;
    var old=document.getElementById('biomol_table'); if(old&&old.parentNode) old.parentNode.removeChild(old);
    var tbl=document.createElement('table'); tbl.id='biomol_table';
    tbl.style.cssText='border-collapse:collapse;margin:10px 0;min-width:520px;font:13px system-ui;';
    var thead=document.createElement('thead'), trh=document.createElement('tr');
    ['Teste','Cor','Resultado'].forEach(function(h){
      var th=document.createElement('th'); th.textContent=h;
      th.style.borderBottom='1px solid #ccc'; th.style.textAlign='left'; th.style.padding='6px 8px'; trh.appendChild(th);
    });
    thead.appendChild(trh); tbl.appendChild(thead);
    var tbody=document.createElement('tbody'), s=window.__BIOMOLID__.state.sample;
    resultsFor(s).forEach(function(r){
      var tr=document.createElement('tr');
      var td1=document.createElement('td'); td1.textContent=r.teste; td1.style.padding='6px 8px'; tr.appendChild(td1);
      var td2=document.createElement('td'); td2.style.padding='6px 8px';
      var sw=document.createElement('span'); sw.style.cssText='display:inline-block;width:14px;height:14px;border-radius:3px;vertical-align:middle;margin-right:6px;background:'+r.cor;
      td2.appendChild(sw); td2.appendChild(document.createTextNode(r.cor)); tr.appendChild(td2);
      var td3=document.createElement('td'); td3.textContent=r.resultado; td3.style.padding='6px 8px'; tr.appendChild(td3);
      tbody.appendChild(tr);
    });
    tbl.appendChild(tbody);
    host.parentNode.insertBefore(tbl, host.nextSibling);
    tbl.scrollIntoView({behavior:'smooth',block:'nearest'});
  }

  function exportCSV(){
    var s=window.__BIOMOLID__.state.sample, rows=resultsFor(s);

    // monta linhas e escapa RFC-4180
    function csvEscape(v){ return '"' + String(v).replace(/"/g,'""') + '"'; }
    var lines=[['Teste','Cor','Hex','Resultado']];
    rows.forEach(function(r){ lines.push([r.teste,'#',r.cor,r.resultado]); });
var csv = lines.map(function(row){
  return row.map(csvEscape).join(',');
}).join('\\r\\n');



    // BOM + CRLF para Excel/LibreOffice
var blob=new Blob([String.fromCharCode(0xFEFF)+csv],{type:"text/csv;charset=utf-8"});
    var a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    var tag=window.__BIOMOLID__.describeSample(s).replace(/[ ():,]/g,'_');
    a.download='biomol_resultados_'+tag+'.csv';
    document.body.appendChild(a); a.click(); setTimeout(function(){URL.revokeObjectURL(a.href); a.remove();},100);
  }

  // UI (tipo OU perfil) + gerador preset
  function mk(tag,attrs,txt){var el=document.createElement(tag); if(attrs)for(var k in attrs)el.setAttribute(k,attrs[k]); if(txt!=null) el.textContent=txt; return el;}
  function setMsg(el,html,kind){ el.innerHTML=html; el.style.fontWeight=(kind==='ok'||kind==='err')?'600':'400'; el.style.color=(kind==='ok')?'#2e7d32':(kind==='err')?'#c62828':'#333'; }

  function buildUI(g){
    ['biomol_ui','biomol_msg','biomol_table'].forEach(function(id){ var n=document.getElementById(id); if(n&&n.parentNode) n.parentNode.removeChild(n); });
    var M=window.__BIOMOLID__, row=mk('div',{id:'biomol_ui'}); row.style.cssText='display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:8px 0';

    // Palpite por tipo
    var lblT=mk('span',null,'Palpite (tipo):');
    var selTipo=mk('select'); // depois
[['aa','AA'],['cadeia','Cadeia (peptidio/proteina)'],['mix','Mistura (AAs)']]
.forEach(function(p){var o=mk('option'); o.value=p[0]; o.textContent=p[1]; selTipo.appendChild(o);});
    var selAA=mk('select'); selAA.style.minWidth='120px'; var o0=mk('option'); o0.value=''; o0.textContent='(AA)'; selAA.appendChild(o0);
    M.AAs.forEach(function(a){var o=mk('option'); o.value=a.name; o.textContent=a.name; selAA.appendChild(o);});
    function toggleAA(){ selAA.style.display=(selTipo.value==='aa')?'inline-block':'none'; } selTipo.addEventListener('change',toggleAA); toggleAA();

    // Palpite por perfil
    var lblP=mk('span',null,'Palpite (perfil):');
    var selPerfil=mk('select');
    [['','(nenhum)'],['so_none','AA simples (nenhum grupo especial)'],
     ['so_his','So His'],['so_tyr','So Tyr'],['so_cys','So Cys'],['so_arom','So AA aromaticos (sem Tyr)'],['so_arg','So Arg'],
     ['mix_his_tyr','Mistura His+Tyr'],['mix_tyr_arg','Mistura Tyr+Arg'],['mix_his_cys','Mistura His+Cys'],['mix_tyr_cys','Mistura Tyr+Cys'],['mix_his_arg','Mistura His+Arg']
     ,['mix_arom_arg','Mistura arom√°ticos + Arg'],

    ].forEach(function(p){var o=mk('option'); o.value=p[0]; o.textContent=p[1]; selPerfil.appendChild(o);});

    // Gerador (professor)
    var lblG=mk('span',null,'Gerar:');
    var selPreset=mk('select');
    [['auto','Aleatorio'],['so_none','AA simples'],
     ['so_his','So His'],['so_tyr','So Tyr'],['so_cys','So Cys'],['so_arom','So AA aromaticos (sem Tyr)'],['so_arg','So Arg'],
     ['mix_his_tyr','His+Tyr'],['mix_tyr_arg','Tyr+Arg'],['mix_arom_arg','Arom√°ticos + Arg'],
,['mix_his_cys','His+Cys'],['mix_tyr_cys','Tyr+Cys'],['mix_his_arg','His+Arg']
    ].forEach(function(p){var o=mk('option'); o.value=p[0]; o.textContent=p[1]; selPreset.appendChild(o);});
    selPreset.value=M.state.presetKey||'auto';
    selPreset.onchange=function(){ M.state.presetKey=selPreset.value; };

    var btnCheck=mk('button',null,'Conferir'), btnNew=mk('button',null,'Nova amostra'), btnShow=mk('button',null,'Explicar');
    var chkHard=mk('input',{type:'checkbox',id:'biomol_hard'}), lblHard=mk('label',{'for':'biomol_hard'},'modo dificil');
    var chkShuf=mk('input',{type:'checkbox',id:'biomol_shuf'}), lblShuf=mk('label',{'for':'biomol_shuf'},'embaralhar');
    var btnTbl=mk('button',null,'Tabela'), btnCsv=mk('button',null,'CSV'); btnTbl.style.marginLeft='8px'; btnCsv.style.marginLeft='4px';
    var score=mk('span'); score.style.marginLeft='8px'; score.style.opacity='0.8';
    function updScore(){ score.textContent='Placar: '+M.state.score+'/'+M.state.rounds; }
    var msg=mk('div',{id:'biomol_msg'}); msg.style.minHeight='1.6em';

    // equivalencia de tipo: peptidio ~ proteina (NOVO)
  function tiposEquivalentes(t1, t2, s){
  // "cadeia" cobre peptidio OU proteina
  if (t1==='cadeia' && (t2==='peptidio' || t2==='proteina')) return true;
  if (t2==='cadeia' && (t1==='peptidio' || t1==='proteina')) return true;

  // AA ~ Mistura quando perfil √© de 0 ou 1 marcador (indistingu√≠vel)
  if ((t1==='aa' && t2==='mix') || (t1==='mix' && t2==='aa')){
    var prof = window.__BIOMOLID__.detectPerfil(s);
    return (prof==='so_none' || prof==='so_his' || prof==='so_tyr' ||
            prof==='so_cys'  || prof==='so_arg' || prof==='so_arom');
  }
  // peptidio ~ proteina ainda vale para retrocompat, caso existam
  if ((t1==='peptidio' && t2==='proteina') || (t1==='proteina' && t2==='peptidio')) return true;

  return t1===t2;
}



function okTipo(s){
  if (!tiposEquivalentes(selTipo.value, s.type, s)) return false;
  if ((s.type==='aa') && selTipo.value==='aa') return selAA.value===s.aa.name;
  return true;
}



    function okPerfil(s){
      var g=selPerfil.value; if(!g) return false;
      if(g==='so_arom') return s.comp.aromatic && !s.comp.tyr;
      if(g==='so_none') return !s.comp.his && !s.comp.tyr && !s.comp.arg && !s.comp.cys && !s.comp.aromatic;
      return (window.__BIOMOLID__.detectPerfil(s)===g);
    }

    btnNew.onclick=function(){
      M.state.sample=(M.state.presetKey && M.state.presetKey!=='auto')?M.makeSamplePreset(M.state.presetKey):M.makeSampleRandom();
      
     // selTipo.value=M.state.sample.type; toggleAA(); if(M.state.sample.type==='aa') selAA.value=M.state.sample.aa.name;
      selTipo.value = (M.state.sample.type==='peptidio' || M.state.sample.type==='proteina') ? 'cadeia'
               : (M.state.sample.type==='mix' ? 'mix' : 'aa');
toggleAA();
if (M.state.sample.type==='aa') selAA.value = M.state.sample.aa.name;

      M.state.rounds+=1; var out=window.codigoPadrao(); Plotly.react('grafico',out.data,out.layout);
      setMsg(msg,'Amostra gerada. Tente identificar por tipo ou por perfil.','hint'); updScore(); fixplot();
    };
    btnCheck.onclick=function(){
      if(!M.state.sample) return;
      var s=M.state.sample, acTipo=okTipo(s), acPerfil=okPerfil(s);
      if(acTipo||acPerfil){ M.state.score+=1; setMsg(msg,'Voce acertou! '+M.describeSample(s)+'.','ok'); }
      else{ setMsg(msg,'Ainda nao. Compare com Pauly/Xantoproteica/Sakaguchi/Millon/Enxofre.','err'); }
      updScore();
    };
    btnShow.onclick=function(){ if(!M.state.sample) return; setMsg(msg,'Solucao: '+M.describeSample(M.state.sample)+' | '+M.explainReactions(M.state.sample),'hint'); };
    chkHard.onchange=function(){ M.state.hideLabels=chkHard.checked; var out=window.codigoPadrao(); Plotly.react('grafico',out.data,out.layout); fixplot(); };
    chkShuf.onchange=function(){ M.state.shuffle=chkShuf.checked; var out=window.codigoPadrao(); Plotly.react('grafico',out.data,out.layout); fixplot(); };
    btnTbl.onclick=renderTable; btnCsv.onclick=exportCSV;

    g.parentNode.insertBefore(row,g);
    g.parentNode.insertBefore(msg,row.nextSibling);
    [lblT,selTipo,selAA,btnCheck,btnNew,btnShow,lblP,selPerfil,lblG,selPreset,chkHard,lblHard,chkShuf,lblShuf,btnTbl,btnCsv,score].forEach(function(n){ row.appendChild(n); });
    updScore(); if(!M.state.sample) btnNew.click();
  }

  // primeiro draw + UI
  var g=document.getElementById('grafico');
  if(g && typeof Plotly!=='undefined'){
    var out=window.codigoPadrao(); Plotly.newPlot('grafico',out.data,out.layout,{responsive:true});
    buildUI(g); fixplot();
  }
  window.__BIOMOL_OBS__=new MutationObserver(function(){
    var g2=document.getElementById('grafico');
    if (g2 && !document.getElementById('biomol_ui')) { buildUI(g2); fixplot(); }
  });
  try{ window.__BIOMOL_OBS__.observe(document.body,{childList:true,subtree:true}); }catch(e){}
})();








`;


window.onload = function() {
    editor.setValue(codigoPadrao, -1);
    resetarGrafico();
};

   
</script>


<div class="license-info">
  <p>
    Licence under 
    <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" style="color: gray; text-decoration: none;">
      CC BY-NC-SA 4.0
    </a>
    ¬© 2025 Jos√© Maur√≠cio Schneedorf FS
  </p>
</div>


</div>

<script>
  function alternarTema() {
  document.body.classList.toggle("dark-mode");

  const isDark = document.body.classList.contains("dark-mode");
  const botao = document.getElementById("toggleTheme");
  botao.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
  editor.setTheme(isDark ? "ace/theme/monokai" : "ace/theme/github");
  const layoutEscuro = {
    plot_bgcolor: "#1e1e1e",
    paper_bgcolor: "#1e1e1e",
    font: { color: "#e0e0e0" },
    xaxis: { color: "#e0e0e0", gridcolor: "#444" },
    yaxis: {
          zeroline: true,
          zeroline: true, color: "#e0e0e0", gridcolor: "#444" }
  };

  const layoutClaro = {
    plot_bgcolor: "#ffffff",
    paper_bgcolor: "#ffffff",
    font: { color: "#000000" },
    xaxis: { color: "#000", gridcolor: "#ccc" },
    yaxis: {
          zeroline: true,
          zeroline: true, color: "#000", gridcolor: "#ccc" }
  };

  const layoutNovo = isDark ? layoutEscuro : layoutClaro;

  Plotly.relayout("grafico", layoutNovo);
}

</script>

<script>
function salvarAppCompleto() {
  const gd = document.getElementById("grafico");
  const curvasAtuais = JSON.stringify(gd.data);
  const layoutAtual = JSON.stringify(gd.layout || {});

  let htmlCompleto = document.documentElement.outerHTML;

  // Script que ser√° injetado no HTML salvo para redesenhar o gr√°fico
  const scriptPlotly = `
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        const data = ${curvasAtuais};
        const layout = ${layoutAtual};
        Plotly.newPlot("grafico", data, layout);
      });
    <\\/script>
  `;

</script>


<script>
function salvarProjetoCompleto() {
  const gd = document.getElementById("grafico");
  const curvasStr = JSON.stringify(gd.data);
  const layoutStr = JSON.stringify(gd.layout || {});
  const codigoStr = JSON.stringify(editor.getValue());
  const temaEscuro = document.body.classList.contains("dark-mode");

  let htmlContent = ''
    + '<!DOCTYPE html>\n'
    + '<html lang="pt">\n'
    + '<head>\n'
    + '  <meta charset="UTF-8">\n'
    + '  <title>JSPlotly Projeto Salvo</title>\n'
    + '  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"><\/script>\n'
    + '  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"><\/script>\n'
    + '  <style>\n'
    + '    body { font-family: Arial, sans-serif; margin: 20px; }\n'
    + '    .container { display: flex; justify-content: space-between; align-items: flex-start; }\n'
    + '    #grafico { width: 55%; height: 500px; }\n'
    + '    #editor-container { width: 40%; }\n'
    + '    #editor { width: 100%; height: 350px; border: 1px solid #ccc; }\n'
    + '  </style>\n'
    + '</head>\n'
    + '<body>\n'
    + '  <h2>JSPlotly - Projeto Salvo</h2>\n'
    + '  <div class="container">\n'
    + '    <div id="grafico"></div>\n'
    + '    <div id="editor-container">\n'
    + '      <div id="editor"></div>\n'
    + '    </div>\n'
    + '  </div>\n'
    + '  <script>\n'
    + '    const curvas = ' + curvasStr + ';\n'
    + '    const layout = ' + layoutStr + ';\n'
    + '    const codigo = ' + codigoStr + ';\n'
    + '    const temaEscuro = ' + JSON.stringify(temaEscuro) + ';\n'
    + '    const editor = ace.edit("editor");\n'
    + '    editor.setTheme(temaEscuro ? "ace/theme/monokai" : "ace/theme/github");\n'
    + '    editor.session.setMode("ace/mode/javascript");\n'
    + '    editor.setValue(codigo, -1);\n'
    + '    layout.editable = true;\n'
    + '    Plotly.newPlot("grafico", curvas, layout);\n'
    + '    document.body.classList.toggle("dark-mode", temaEscuro);\n'
    + '    document.getElementById("grafico").on("plotly_click", function(data) {\n'
    + '      const y = data.points[0].y;\n'
    + '      const ctx = new (window.AudioContext || window.webkitAudioContext)();\n'
    + '      const osc = ctx.createOscillator();\n'
    + '      const gain = ctx.createGain();\n'
    + '      osc.type = "sine";\n'
    + '      osc.frequency.setValueAtTime(y, ctx.currentTime);\n'
    + '      osc.connect(gain);\n'
    + '      gain.connect(ctx.destination);\n'
    + '      osc.start();\n'
    + '      osc.stop(ctx.currentTime + 0.4);\n'
    + '    });\n'
    + '  <\/script>\n'
    + '</body>\n'
    + '</html>';

  const blob = new Blob([htmlContent], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "jsplotly_projeto.html";
  a.click();
}
</script>

<script>
function salvarProjetoSomenteGrafico() {
  const gd = document.getElementById("grafico");
  const curvasStr = JSON.stringify(gd.data);
  const layoutStr = JSON.stringify(gd.layout || {});
  const framesData = gd._transitionData && gd._transitionData._frames;
  const framesStr = JSON.stringify(framesData || []);
  const temaEscuro = document.body.classList.contains("dark-mode");

  let htmlContent = ''
    + '<!DOCTYPE html>\n'
    + '<html lang="pt">\n'
    + '<head>\n'
    + '  <meta charset="UTF-8">\n'
    + '  <title>JSPlotly Gr√°fico Exportado</title>\n'
    + '  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"><\/script>\n'
    + '  <style>\n'
    + '    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: ' + (temaEscuro ? '#1e1e1e' : '#ffffff') + '; color: ' + (temaEscuro ? '#e0e0e0' : '#000000') + '; }\n'
    + '    #grafico { width: 100vw; height: 100vh; }\n'
    + '  </style>\n'
    + '</head>\n'
    + '<body>\n'
    + '  <div id="grafico"></div>\n'
    + '  <script>\n'
    + '    const data = ' + curvasStr + ';\n'
    + '    const layout = ' + layoutStr + ';\n'
    + '    const frames = ' + framesStr + ';\n'
    + '    layout.editable = false;\n'
    + '    Plotly.newPlot("grafico", data, layout).then(function() {\n'
    + '      if (frames && frames.length > 0) {\n'
    + '        Plotly.addFrames("grafico", frames);\n'
    + '        Plotly.animate("grafico", null, { frame: { duration: 500, redraw: true }, transition: { duration: 300 } });\n'
    + '      }\n'
    + '    });\n'
    + '    document.getElementById("grafico").on("plotly_click", function(data) {\n'
    + '      const y = data.points[0].y;\n'
    + '      const ctx = new (window.AudioContext || window.webkitAudioContext)();\n'
    + '      const osc = ctx.createOscillator();\n'
    + '      const gain = ctx.createGain();\n'
    + '      osc.type = "sine";\n'
    + '      osc.frequency.setValueAtTime(y, ctx.currentTime);\n'
    + '      osc.connect(gain);\n'
    + '      gain.connect(ctx.destination);\n'
    + '      osc.start();\n'
    + '      osc.stop(ctx.currentTime + 0.4);\n'
    + '    });\n'
    + '  <\/script>\n'
    + '</body>\n'
    + '</html>';

  const blob = new Blob([htmlContent], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "play.html";
  a.click();
}
</script>




<script>
function salvarCloneJSPlotly() {
  // Captura o c√≥digo do usu√°rio e escapa com seguran√ßa
  const codigoNovo = editor.getValue()
    .replace(/\\/g, '\\\\')
    .replace(/`/g, '\\`')
    .replace(/\$/g, '\\$');

  // Substitui diretamente o valor da vari√°vel codigoPadrao na string
  const novaDefinicao = 'var codigoPadrao = `' + codigoNovo + '`;';
  
  // Extrai o HTML original em partes
  const htmlOriginal = document.documentElement.outerHTML;

  const htmlAtualizado = htmlOriginal.replace(
    /var codigoPadrao = `([\s\S]*?)`;/,
    novaDefinicao
  );

  const blob = new Blob([htmlAtualizado], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "JSPlotly.html";
  a.click();
}
</script>


</body>
</html>


