<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSPlotly</title>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.20.0/plotly.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.1/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ml-regression@6.0.0/dist/ml-regression.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>    
    <script src="https://cdn.jsdelivr.net/npm/ml-levenberg-marquardt@3.3.0/dist/ml-levenberg-marquardt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.5/jstat.min.js"></script>

 <!---<body style="margin:0; padding:0;">--->


    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { display: flex; justify-content: space-between; align-items: flex-start; }
        #grafico { width: 55%; height: 500px; }
        #editor-container { width: 40%; }
        #editor { width: 100%; height: 350px; border: 1px solid #ccc; }

.header-bar {
    width: 100%;
    height: 30px; 
    background: linear-gradient(to right, #F5F5DC, #EDEAE0); 
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    color: #5a4a42; /
    letter-spacing: 2px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); 
    margin-bottom: 40px;  
}



.license-info {
  font-size: 12px;
  color: gray;
  font-family: Arial, sans-serif;
  opacity: 0.8;
  text-align: center;
  margin: 30px auto 10px auto;
}


#toggleTheme {
  position: relative;
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
  margin: -2px 0 0 10px; /* margem superior e esquerda */
  display: inline-block;
  z-index: 10;
}



.dev-info {
    position: absolute;
    top: 3px; 
    left: 10px; 
    font-size: 13px !important; 
    color: #999; 
    font-family: Arial, sans-serif;
}

.dev-info a {
    text-decoration: none;
    color: #888; 
    font-weight: bold;
}
.dev-info a:hover {
    text-decoration: underline;
    color: #666; /
}

       
.button-container { 
    display: flex; 
    gap: 10px; 
    margin-top: 10px; 

  position: relative;
  z-index: 10;
}

button { 
    padding: 10px; 
    cursor: pointer; 
    border: none; 
    font-size: 14px; 
    border-radius: 5px; 
    transition: background 0.3s ease-in-out; 
}


/* Bot√£o base */
button {
  padding: 10px;
  cursor: pointer;
  font-size: 14px;
  border-radius: 8px;
  border: 2px solid transparent;
  transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
}

.add-btn {
  background: #e2f6e9;
  color: #207a44;
  border-color: #b1e2c3;
}
.add-btn:hover {
  background: #ccf0dd;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(50, 150, 100, 0.3);
}

.remove-btn {
  background: #fff8c6;
  color: #887200;
  border-color: #f0dc7d;
}
.remove-btn:hover {
  background: #fdf2a8;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(200, 180, 20, 0.3);
}

.reset-btn {
  background: #fce1e1;
  color: #b42c2c;
  border-color: #f4b6b6;
}
.reset-btn:hover {
  background: #f8caca;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(200, 50, 50, 0.3);
}

.save-btn {
  background: #fff1db;
  color: #8a4b00;
  border-color: #ffd9a2;
}
.save-btn:hover {
  background: #ffe1ba;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(200, 120, 30, 0.3);
}

.clear-btn {
  background: #f99;
  color: white;
  border-color: #d33;
}
.clear-btn:hover {
  background: #e55;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(255, 80, 80, 0.5);
}

.save-html-btn {
  background: #e6f1fb;
  color: #125a8f;
  border-color: #a8d0f0;
}
.save-html-btn:hover {
  background: #d2e9fc;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(50, 100, 200, 0.3);
}


.author-info { position: absolute; top: 60px; right: 20px; font-size: 14px; color: gray; }
.logo { position: fixed; bottom: 10px; right: 20px; width: 100px; z-index: 10;} 
.ascii-logo {
 position: fixed;
 bottom: 10px;
 right: 20px;
 font-family: monospace;
 font-size: 2px;
 white-space: pre;
 text-align: right;
 z-index: 10; 
 }
 
.save-project-btn {
  background: linear-gradient(to bottom, #f3e6ff, #d3bdf0);
  color: #5e2d91;
  font-weight: normal;
  border: 2px solid #b48ce3;
  border-radius: 8px;
  box-shadow: 0 0 6px rgba(140, 90, 200, 0.4);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.save-project-btn:hover {
  background: linear-gradient(to bottom, #e7d4ff, #c9aee8);
  transform: scale(1.05);
  box-shadow: 0 0 8px rgba(120, 60, 180, 0.5);
}


</style>


<style>
  @media (max-width: 768px) {
    .container {
      flex-direction: column;
      align-items: stretch;
    }

    #grafico {
      width: 100% !important;
      height: 300px !important;
    }

    #editor-container {
      width: 100% !important;
    }

    #editor {
      height: 300px !important;
    }

    .button-container {
      flex-direction: column;
      gap: 8px;
    
  position: relative;
  z-index: 10;
}

    button {
      width: 100%;
      font-size: 16px;
    }

    .header-bar {
      font-size: 16px;
    }

    .popup {
      width: 90%;
    }

    .external-link {
      position: relative;
      top: auto;
      right: auto;
      margin-top: 10px;
      text-align: right;
    }
  }
</style>


<style>
  body.dark-mode {
    background-color: #1e1e1e;
    color: #e0e0e0;
  }

  body.dark-mode .header-bar {
    background: linear-gradient(to right, #2e2e2e, #1a1a1a);
    color: #f0f0f0;
  }

  body.dark-mode .button-container button {
    background: #333 !important;
    color: #ddd !important;
  }

  body.dark-mode .clear-btn {
    background-color: #a71d2a !important;
    color: white !important;
  }

  body.dark-mode #editor {
    background-color: #1e1e1e;
    color: #e0e0e0;
  }

  body.dark-mode .popup {
    background-color: #2b2b2b;
    color: #eee;
  }
  
</style>


</head>


<body>
<div class="header-bar" style="display: flex; align-items: center; justify-content: space-between; padding: 4px 10px;">
  <button id="toggleTheme" onclick="alternarTema()" style="font-size: 18px; background: none; border: none; cursor: pointer;">
    üåô
  </button>

  <div style="flex: 1; text-align: center; font-weight: bold; font-size: 16px;">
    JSPlotly - Interactive Graphics
  </div>

  <div style="width: 30px;"><!-- espa√ßo vazio para equilibrar com o bot√£o da esquerda --></div>
</div>



<div class="external-link">
  <a href="https://bioquanti.netlify.app/" target="_blank">üîó Bioquanti</a>  
</div>



<div class="dev-info">
    Developed with 
    <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript" target="_blank">JavaScript</a> 
    and 
    <a href="https://plotly.com/javascript/" target="_blank">Plotly.js</a>
</div>

<div class="container">

 <div id="grafico"></div>

<div id="popup" class="popup">
    <p>Save as:</p>
    <button onclick="salvarImagem('png')">PNG</button>
    <button onclick="salvarImagem('svg')">SVG</button>
    <button onclick="fecharPopup()">Cancelar</button>
</div>

<style>
.popup {
    display: none;
    position: fixed;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    border: 1px solid #ccc;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    z-index: 1000;
}
.popup button {
    margin: 5px;
    padding: 8px;
}

.external-link {  
  position: absolute;
  top: 30px;
  right: 20px;
  font-size: 14px;
  font-family: Arial, sans-serif;
}

.external-link a {
  color: #333;
  text-decoration: none;
  font-weight: bold;
}

.external-link a:hover {
  text-decoration: underline;
  color: #0077cc;
}

.save-html-btn {
  background: linear-gradient(to bottom, #dff0f7, #add9e6);
  color: #004b66;
  font-weight: normal;
  border: 2px solid #66b8d4;
  border-radius: 8px;
  box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.save-html-btn:hover {
  background: linear-gradient(to bottom, #c4ecff, #8fd3ec);
  transform: scale(1.05);
  box-shadow: 0 0 8px rgba(0, 123, 255, 0.8);
}


</style>

  <div id="editor-container">
  

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
  <input type="file" id="fileInput" accept=".js" onchange="carregarEquacaoAuto(event)">
  
  <span style="font-size: 13px; font-family: Arial, sans-serifbioq; color: #2e7d57; text-align: right;">
    For easy code construction, try 
    <a href="https://chatgpt.com/g/g-6819fbb8d2d08191bf7d50a3dbeadb0d-gsplotly" 
       target="_blank" 
       style="color: #2e7d57 !important; font-weight: bold; text-decoration: underline;">
      GSPlotly
    </a>
  </span>
</div>





       <div id="editor"></div>
       <div class="button-container">
       <button class="add-btn" onclick="adicionarCurva()">add</button>
       <button class="remove-btn" onclick="removerUltimaCurva()">remove</button>
       <button class="clear-btn" onclick="resetarGrafico()">clean</button> 
       <button class="reset-btn" onclick="limparEditor()">delete</button>
     <!---  <button class="save-html-btn" onclick="salvarHTML()">html</button> --->             
       <button class="save-btn" onclick="salvarEquacao()">script</button> 
       <button class="save-html-btn" onclick="salvarProjetoSomenteGrafico()">html</button>
    <!---<button class="save-html-btn" onclick="salvarProjetoCompleto()">save project</button> --->
       <button class="save-project-btn" onclick="salvarCloneJSPlotly()">clone</button>
       
    
  </div>
</div>
    </div>
    
    
<script>
 var curvas = [];
 var cores = ["red", "blue", "green", "purple", "orange", "brown", "pink", "gray"];
 var corIndex = 0;
 var editor = ace.edit("editor");
 editor.setTheme("ace/theme/github");
 editor.session.setMode("ace/mode/javascript");
 editor.session.setUseWrapMode(true);
 editor.setOptions({
  fontSize: "14px",
  wrap: true,
  showPrintMargin: false
});



var customSaveButton = {
    name: 'PNG or SVG',
    icon: Plotly.Icons.disk,
    click: function(gd) {
        abrirPopup();
    }
};


var config = {
  modeBarButtonsToAdd: [
    'toggleSpikelines',
    'hoverCompareCartesian',
    'drawline',
    'drawopenpath',
    'drawrect',
    'drawcircle',
    //'eraseshape',
    customSaveButton,
    {
      name: 'change color',
      icon: Plotly.Icons.camera,
      click: function(gd) {
        const ultima = curvas.length - 1;
        const novaCor = cores[Math.floor(Math.random() * cores.length)];
        Plotly.restyle(gd, { 'line.color': novaCor }, [ultima]);
        curvas[ultima].line.color = novaCor;
      }
    },
  {
  name: 'Adicionar Texto',
  icon: {
    width: 1000,
    height: 1000,
    path: 'M200 800V160h600v80H540v560h-80V240H200z' // √çcone simples em forma de "T"
  },
  click: function(gd) {
    // O clique no bot√£o ativa o modo de anota√ß√£o
    const handler = function(eventData) {
      const x = eventData.points[0].x;
      const y = eventData.points[0].y;
      const texto = prompt("Digite o texto a ser inserido:");
      if (texto) {
        Plotly.relayout(gd, {
          annotations: (gd.layout.annotations || []).concat([{
            x: x,
            y: y,
            text: texto,
            showarrow: true,
            arrowhead: 2
          }])
        });
      }
      gd.removeListener('plotly_click', handler);
    };
    gd.on('plotly_click', handler);
  }
}
  ],
  showEditInChartStudio: true,
  plotlyServerURL: "https://chart-studio.plotly.com",
  displaylogo: false,
  displayModeBar: true,
  responsive: true,
  scrollZoom: true,
  editable: true,
  modeBarButtonsToRemove: [
    'select2d',
    'lasso2d',
    'resetScale2d',
    'zoomOut2d',
    'zoomIn2d',
    'toImage'
  ]
};
 

function executarCodigo() {
    try {
        var codigoUsuario = editor.getValue().trim();
        Plotly.purge('grafico'); 
        eval(codigoUsuario);
    } 

catch (error) {
           
    }
}

function limparGrafico() {
    Plotly.purge('grafico');
}

function carregarEquacaoAuto(event) {
 const file = event.target.files[0];
 if (file) {
   const reader = new FileReader();
         reader.onload = function(e) {
         editor.setValue(e.target.result, -1);
                 };
         reader.readAsText(file);
                 }
           }

function adicionarCurva() {
  const codigoUsuario = editor.getValue();

  let consoleSaida = [];
  const logOriginal = console.log;
  console.log = (...args) => {
    consoleSaida.push(args.map(arg => typeof arg === "object" ? JSON.stringify(arg) : String(arg)).join(" "));
  };

  let resultado;
  try {
    const func = new Function(codigoUsuario + "\nreturn typeof output !== 'undefined' ? output : undefined;");
    resultado = func();
  } catch (e1) {
    try {
      const func = new Function(codigoUsuario);
      resultado = func();
    } catch (e2) {
      console.log = logOriginal;
      alert("Erro ao executar o c√≥digo:\n" + e2.message);
      return;
    }
  }

  console.log = logOriginal;
  if (!resultado) return;

  const texto = consoleSaida.map(l => "> " + l).join("<br>");
  const layout = resultado.layout || {};
  layout.annotations = layout.annotations || [];

  if (texto.trim()) {
    layout.annotations.push({
      text: `<div style="font-family: monospace; font-size: 14px; max-height: 200px; overflow-y: auto; background:#f9f9f9; padding:5px; border:1px solid #ccc;">${texto}</div>`,
      showarrow: false,
      xref: 'paper',
      yref: 'paper',
      x: 0,
      y: 1,
      align: 'left',
      xanchor: 'left',
      yanchor: 'top'
    });
  }




  let data = [];
  if (resultado.data) {
    data = resultado.data;
  } else if (resultado.trace) {
    data = [resultado.trace];
  } else if (resultado.traces) {
    data = resultado.traces;
  } else if (resultado.x_values && resultado.y_values) {
    data = [{
      x: resultado.x_values,
      y: resultado.y_values,
      type: 'scatter',
      mode: 'lines+markers',
      name: resultado.title || "Curva"
    }];
    if (resultado.x_range) layout.xaxis = { range: resultado.x_range, title: resultado.x_label || "" };
    if (resultado.y_range) layout.yaxis = { range: resultado.y_range, title: resultado.y_label || "" };
    layout.title = resultado.title || "";
  }

  curvas.push(...data);

  Plotly.newPlot("grafico", curvas, layout, config).then(() => {
    if (resultado.frames && resultado.frames.length > 0) {
      Plotly.addFrames("grafico", resultado.frames);
      Plotly.animate("grafico", null, {
        frame: { duration: 80, redraw: true },
        transition: { duration: 0 }
      });
    }
  });
}




function resetarGrafico() {
            curvas = [];
            corIndex = 0;
            Plotly.newPlot('grafico', [], {xaxis: { title: 'X' }, yaxis: {
          zeroline: true,
          zeroline: true, title: 'Y' } });
        }

function salvarEquacao() {
    var blob = new Blob([editor.getValue()], { type: "text/javascript" });
    var a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "script.js";
        document.body.appendChild(a);
        a.click();
            document.body.removeChild(a);
       }

        

function salvarHTML() {
    var plotlyData = JSON.parse(JSON.stringify(curvas));
    var plotlyLayout = document.getElementById('grafico').layout;
    var htmlContent = '<!DOCTYPE html>\n' +
                '<html>\n' +
                '<head>\n' +
                '    <meta charset="UTF-8">\n' +
                '    <title>Gr√°fico Salvo</title>\n' +
                '    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.20.0/plotly.min.js"><\/script>\n' +
                '</head>\n' +////
                '<body>\n' +
                '    <div id="grafico" style="width: 100%; height: 600px;"></div>\n' +
                '    <script>\n' +
                '        var data = ' + JSON.stringify(plotlyData) + ';\n' +
                '        var layout = ' + JSON.stringify(plotlyLayout) + ';\n' +
                '        Plotly.newPlot("grafico", data, layout);\n' +
                '    <\/script>\n' +
                '</body>\n' +
                '</html>';

function salvarAppCompleto() {
  const htmlBase = document.documentElement.outerHTML;
  const blob = new Blob([htmlBase], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "jsplotly_completo.html";
  a.click();
}


var blob = new Blob([htmlContent], { type: 'text/html' });
var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
//    a.download = 'grafico_interativo.html';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
        }

function limparEditor() {
    editor.setValue("", -1); 
    }

function removerUltimaCurva() {
    if (curvas.length > 0) {
    curvas.pop(); 
    atualizarGrafico(); 
        } else {
        alert("No curves to remove!");
      }
    }


function atualizarGrafico() {
    Plotly.newPlot('grafico', curvas, {
        title: 'Gr√°fico Interativo',
        xaxis: { title: 'X' },
        yaxis: {
          zeroline: true,
          zeroline: true, title: 'Y' },
        showlegend: true
    });
}

function abrirPopup() {
    document.getElementById('popup').style.display = 'block';
}

function fecharPopup() {
    document.getElementById('popup').style.display = 'none';
}

function salvarImagem(formato) {
    Plotly.downloadImage('grafico', {format: formato, filename: 'plot'});
    fecharPopup();
}


function limparTudo() {
   editor.setValue("", -1);
     let graficoDiv = document.getElementById("grafico");
     if (graficoDiv) {
            Plotly.newPlot("grafico", [], {
            xaxis: { title: "Eixo X" },
            yaxis: {
          zeroline: true,
          zeroline: true, title: "Eixo Y" }
        });
        graficoDiv.data = [];
    }
}


// Definir a equa√ß√£o quadr√°tica padr√£o
var codigoPadrao = `
// ===== JSPlotly Sonified Function v1.6.1 (ASCII-free) =====
(function(){
  var PLOT_ID = 'plot';
  var f = function(x){ return Math.sin(x * Math.PI / 180); }; // your function here
  var X0 = 0, X1 = 360, N = 361;
  var PLAY_INTERVAL_MS = 180;

  // base frequency (tone when y=0); slider changes this
  var F_BASE = 550;                       // Hz
  var F_MIN_CLAMP = 80, F_MAX_CLAMP = 4000;

  // graph div
  var gd = document.getElementById(PLOT_ID) || document.querySelector('.js-plotly-plot');
  if(!gd){ console.warn('JSPlotly Sonify: plot not found'); return; }

  // data
  var x = Array.from({length:N}, function(_,i){ return X0 + i*(X1-X0)/(N-1); });
  var y = x.map(function(xi){ var v=f(xi); return isFinite(v)?v:0; });
  var ymin = Math.min.apply(null, y), ymax = Math.max.apply(null, y);
  if(!isFinite(ymin) || !isFinite(ymax) || ymin===ymax){ ymin=-1; ymax=1; }
  var ypad = 0.12 * (Math.abs(ymin)+Math.abs(ymax) || 1);

  // plot
  var trace = { x:x, y:y, type:'scatter', mode:'lines', name:'f(x)' };
  var layout = {
    title: 'f(x) - sonification',
    xaxis: { title:'x', range:[X0, X1] },
    yaxis: { title:'y', range:[ymin-ypad, ymax+ypad] },
    margin:{ l:48, r:12, t:40, b:48 },
    showlegend:false
  };

  Plotly.newPlot(gd, [trace], layout, {displayModeBar:false}).then(function(){
    var cursor = { x:[x[0],x[0]], y:[ymin-ypad,ymax+ypad], mode:'lines',
      line:{dash:'dot',width:2,color:'#d27000'}, hoverinfo:'skip', showlegend:false, name:'cursor' };
    var marker = { x:[x[0]], y:[y[0]], mode:'markers',
      marker:{size:9,color:'#2ca02c'}, hoverinfo:'skip', showlegend:false, name:'point' };
    Plotly.addTraces(gd, [cursor, marker]);
    gd._iCursor = gd.data.length-2;
    gd._iMarker = gd.data.length-1;
    buildUI();
    draw(false);
  });

  // audio (singleton + auto-unlock)
  function getAudio(){
    if(!window.__SONI_AUDIO){
      var AC = window.AudioContext || window.webkitAudioContext;
      var actx = new AC();
      var gain = actx.createGain();
      gain.gain.value = 0.0;
      gain.connect(actx.destination);
      window.__SONI_AUDIO = { actx: actx, gain: gain, osc: null, volume01: 0.5 };
    }
    return window.__SONI_AUDIO;
  }
  async function unlockAudio(){
    var A = getAudio();
    try{ if(A.actx.state === 'suspended'){ await A.actx.resume(); } }catch(e){}
  }
  function setVol01(v01){
    var A = getAudio();
    A.volume01 = v01;
    A.gain.gain.setTargetAtTime(v01, A.actx.currentTime, 0.01);
  }
  async function beep(freq, dur){
    var A = getAudio();
    await unlockAudio();
    if(A.osc){ try{A.osc.stop();}catch(e){} try{A.osc.disconnect();}catch(e){} A.osc=null; }
    var osc = A.actx.createOscillator();
    osc.type = 'sine';
    osc.frequency.value = freq;
    osc.connect(A.gain);
    var now = A.actx.currentTime;
    var d = dur || 0.12;
    var a = Math.max(0.0001, A.volume01*0.35);
    A.gain.gain.cancelScheduledValues(now);
    A.gain.gain.setValueAtTime(0.0001, now);
    A.gain.gain.exponentialRampToValueAtTime(a, now+0.01);
    A.gain.gain.exponentialRampToValueAtTime(0.0001, now+d);
    osc.start(now);
    osc.stop(now + d + 0.02);
    A.osc = osc;
  }

  // musical mapping: y in [-1,1] -> F = F_BASE * 2^y
  function yToFreq(val){
    var fz = F_BASE * Math.pow(2, val);
    if(fz < F_MIN_CLAMP) fz = F_MIN_CLAMP;
    if(fz > F_MAX_CLAMP) fz = F_MAX_CLAMP;
    return fz;
  }

  // interaction
  var idx = 0, timer=null;

  function draw(withBeep){
    var xv = x[idx], yv = y[idx];
    Plotly.restyle(gd, { x:[[xv,xv]], y:[[ymin-ypad, ymax+ypad]] }, [gd._iCursor]);
    Plotly.restyle(gd, { x:[[xv]], y:[[yv]] }, [gd._iMarker]);
    var fz = yToFreq(yv);
    setStatus('x='+round6(xv)+', y='+round6(yv)+', f~'+Math.round(fz)+' Hz (base '+Math.round(F_BASE)+' Hz)');
    if(withBeep){ beep(fz, 0.12); }
  }
  function round6(v){ var s = (Math.abs(v) < 1e-9) ? 0 : v; return Number(s).toFixed(6); }
  function clamp(v,a,b){ return Math.min(Math.max(v,a), b); }

  // UI + export
  function buildUI(){
    var old = document.getElementById('soni-bar');
    if(old && old.parentNode) old.parentNode.removeChild(old);

    var ui = document.createElement('div');
    ui.id = 'soni-bar';
    ui.style.margin = '4px 0 0 0';
    ui.style.fontFamily = 'system-ui, sans-serif';
    ui.style.display = 'flex';
    ui.style.gap = '8px';
    ui.style.alignItems = 'center';
    ui.style.flexWrap = 'wrap';

    ui.innerHTML =
      '<button id="btnAudio">Audio</button>'+
      '<button id="btnPlay">Play</button>'+
      '<button id="btnPause">Pause</button>'+
      '<button id="btnReset">Reset</button>'+
      'Hz base: <input id="hzbase" type="range" min="150" max="1200" value="'+F_BASE+'" step="5" tabindex="-1" style="vertical-align:middle;width:180px">'+
      '<button id="btnHTML">HTML</button>'+
      '<span id="soniStatus" style="margin-left:4px;opacity:.85">Ready</span>';

    gd.insertAdjacentElement('afterend', ui);

    document.getElementById('btnAudio').onclick = async function(){
      await unlockAudio();
      setVol01(getAudio().volume01);
      setStatus('Audio on. Use <- and -> or Space. Adjust Hz base if needed.');
      draw(true);
    };
    document.getElementById('btnPlay').onclick = function(){
      if(timer) return;
      timer = setInterval(function(){ idx=(idx+1)%x.length; draw(true); }, PLAY_INTERVAL_MS);
    };
    document.getElementById('btnPause').onclick = function(){
      if(timer){ clearInterval(timer); timer=null; }
    };
    document.getElementById('btnReset').onclick = function(){
      idx = 0; draw(false);
    };

    var hz = document.getElementById('hzbase');
    hz.onfocus = function(){ this.blur(); }; // avoid stealing arrow keys
    hz.oninput = function(e){
      F_BASE = Math.max(150, Math.min(1200, Number(e.target.value)||550));
      draw(true);
    };
    document.getElementById('btnHTML').onclick = exportHTML;

    // Global key handler (capture) so Ace/editor cannot swallow keys
    function onKey(ev){
      var k = ev.key;
      if(k !== 'ArrowLeft' && k !== 'ArrowRight' && k !== ' ') return;
      ev.preventDefault();
      if(ev.stopImmediatePropagation) ev.stopImmediatePropagation();
      unlockAudio();
      if(k === 'ArrowLeft'){ idx = clamp(idx-1, 0, x.length-1); draw(true); }
      else if(k === 'ArrowRight'){ idx = clamp(idx+1, 0, x.length-1); draw(true); }
      else if(k === ' '){
        if(timer){ clearInterval(timer); timer=null; }
        else { timer = setInterval(function(){ idx=(idx+1)%x.length; draw(true); }, PLAY_INTERVAL_MS); }
      }
    }
    if(window.__SONI_KEY){ window.removeEventListener('keydown', window.__SONI_KEY, true); }
    window.__SONI_KEY = onKey;
    window.addEventListener('keydown', window.__SONI_KEY, true); // capture=true
  }

  function setStatus(msg){
    var el = document.getElementById('soniStatus');
    if(el) el.textContent = msg;
  }

  // export HTML (ASCII-only)
  function exportHTML(){
var fxStr = f.toString()
  .replace(/[]+/g, ' ')  // remove quebras de linha
  .replace(/	+/g, ' ')      // remove TABs
  .replace(/s{2,}/g, ' ');
    var parts = [];
    parts.push('<!DOCTYPE html><html lang="en"><head><meta charset="utf-8">');
    parts.push('<title>f(x) sonified</title><meta name="viewport" content="width=device-width, initial-scale=1">');
    parts.push('<script src="https://cdn.plot.ly/plotly-2.30.0.min.js"><\\/script>');
    parts.push('<style>body{font-family:system-ui,sans-serif;margin:16px}#plot{width:100%;max-width:980px;height:460px}.bar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:4px}.btn{padding:6px 10px;border:1px solid #ccc;border-radius:10px;background:#f7f7f7;cursor:pointer}</style>');
    parts.push('</head><body>');
    parts.push('<h2>f(x) = '+escapeHtml(fxStr)+'</h2>');
    parts.push('<div id="plot"></div>');
    parts.push('<div class="bar">');
    parts.push('<button id="btnAudio" class="btn">Enable audio</button>');
    parts.push('<button id="btnPlay" class="btn">Play</button>');
    parts.push('<button id="btnPause" class="btn">Pause</button>');
    parts.push('<button id="btnReset" class="btn">Reset</button>');
    parts.push('Hz base: <input id="hzbase" type="range" min="150" max="1200" value="'+F_BASE+'" step="5" tabindex="-1" style="width:180px">');
    parts.push('<span id="status" style="opacity:.85;margin-left:6px">Use <- and -> or Space</span>');
    parts.push('</div>');
    parts.push('<script>(function(){');
    parts.push('var f='+fxStr+'; var X0='+X0+', X1='+X1+', N='+N+', STEP='+PLAY_INTERVAL_MS+', F_BASE='+F_BASE+'; var F_MIN=80, F_MAX=4000;');
    parts.push('var x=Array.from({length:N},function(_,i){return X0+i*(X1-X0)/(N-1);});');
    parts.push('var y=x.map(function(xi){var v=f(xi);return isFinite(v)?v:0;});');
    parts.push('var ymin=Math.min.apply(null,y), ymax=Math.max.apply(null,y); if(!isFinite(ymin)||!isFinite(ymax)||ymin===ymax){ymin=-1;ymax=1;}');
    parts.push('var ypad=0.12*(Math.abs(ymin)+Math.abs(ymax)||1);');
    parts.push('var trace={x:x,y:y,type:"scatter",mode:"lines",name:"f(x)"};');
    parts.push('var lay={xaxis:{title:"x",range:[X0,X1]},yaxis:{title:"y",range:[ymin-ypad,ymax+ypad]},margin:{l:48,r:12,t:36,b:48},showlegend:false,title:"f(x) - sonification"};');
    parts.push('Plotly.newPlot("plot",[trace],lay,{displayModeBar:false}).then(function(){');
    parts.push('var c={x:[x[0],x[0]],y:[ymin-ypad,ymax+ypad],mode:"lines",line:{dash:"dot",width:2,color:"#d27000"},hoverinfo:"skip",showlegend:false};');
    parts.push('var m={x:[x[0]],y:[y[0]],mode:"markers",marker:{size:9,color:"#2ca02c"},hoverinfo:"skip",showlegend:false};');
    parts.push('Plotly.addTraces("plot",[c,m]); var iC=1,iM=2;');
    parts.push('var AC=window.AudioContext||window.webkitAudioContext, actx=new AC(); var gain=actx.createGain(); gain.gain.value=0.0; gain.connect(actx.destination); var osc=null, vol=0.5;');
    parts.push('function unlock(){ if(actx.state==="suspended"){ actx.resume(); } }');
    parts.push('function setVol(v){ vol=v; gain.gain.setTargetAtTime(v, actx.currentTime, 0.01);} setVol(0.5);');
    parts.push('function yToF(v){ var fz=F_BASE*Math.pow(2,v); if(fz<F_MIN) fz=F_MIN; if(fz>F_MAX) fz=F_MAX; return fz; }');
    parts.push('function beep(fq,d){ if(osc){try{osc.stop();}catch(e){} try{osc.disconnect();}catch(e){} } osc=actx.createOscillator(); osc.type="sine"; osc.frequency.value=fq; osc.connect(gain); var now=actx.currentTime, dur=d||0.12, a=Math.max(0.0001,vol*0.35); gain.gain.cancelScheduledValues(now); gain.gain.setValueAtTime(0.0001,now); gain.gain.exponentialRampToValueAtTime(a,now+0.01); gain.gain.exponentialRampToValueAtTime(0.0001,now+dur); osc.start(now); osc.stop(now+dur+0.02);}');
    parts.push('var idx=0,timer=null;');
    parts.push('function draw(play){ var xv=x[idx], yv=y[idx], fz=yToF(yv); Plotly.restyle("plot",{x:[[xv,xv]],y:[[ymin-ypad,ymax+ypad]]},[iC]); Plotly.restyle("plot",{x:[[xv]],y:[[yv]]},[iM]); document.getElementById("status").textContent="x="+xv+", y="+yv.toFixed(6)+", f~"+Math.round(fz)+" Hz (base "+Math.round(F_BASE)+" Hz)"; if(play){ beep(fz,0.12);} }');
    parts.push('document.getElementById("btnAudio").onclick=function(){ unlock(); setVol(0.5); this.disabled=true; draw(true); };');
    parts.push('document.getElementById("btnPlay").onclick=function(){ if(timer)return; timer=setInterval(function(){ idx=(idx+1)%x.length; draw(true); }, STEP); };');
    parts.push('document.getElementById("btnPause").onclick=function(){ if(timer){ clearInterval(timer); timer=null; } };');
    parts.push('document.getElementById("btnReset").onclick=function(){ idx=0; draw(false); };');
    parts.push('var hz=document.getElementById("hzbase"); hz.onfocus=function(){ this.blur(); }; hz.oninput=function(e){ F_BASE=Math.max(150, Math.min(1200, Number(e.target.value)||550)); draw(true); };');
    parts.push('function onKey(ev){ var k=ev.key; if(k!=="ArrowLeft" && k!=="ArrowRight" && k!==" ") return; ev.preventDefault(); if(ev.stopImmediatePropagation) ev.stopImmediatePropagation(); unlock(); if(k==="ArrowLeft"){ idx=Math.max(0,idx-1); draw(true);} else if(k==="ArrowRight"){ idx=Math.min(x.length-1,idx+1); draw(true);} else if(k===" "){ if(timer){clearInterval(timer);timer=null;} else {timer=setInterval(function(){ idx=(idx+1)%x.length; draw(true); }, STEP);} } }');
    parts.push('window.addEventListener("keydown", onKey, true);');
    parts.push('draw(false);');
    parts.push('});');
    parts.push('})();<\/script></body></html>');

    var html = parts.join('');
    var blob = new Blob([html], {type:'text/html'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a');
    a.href = url; a.download = 'funcao_sonificada.html';
    a.click();
    URL.revokeObjectURL(url);
  }

  function escapeHtml(s){
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;')
      .replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
  }
})();


`;


window.onload = function() {
    editor.setValue(codigoPadrao, -1);
    resetarGrafico();
};

   
</script>


<div class="license-info">
  <p>
    Licence under 
    <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" style="color: gray; text-decoration: none;">
      CC BY-NC-SA 4.0
    </a>
    ¬© 2025 Jos√© Maur√≠cio Schneedorf FS
  </p>
</div>


</div>

<script>
  function alternarTema() {
  document.body.classList.toggle("dark-mode");

  const isDark = document.body.classList.contains("dark-mode");
  const botao = document.getElementById("toggleTheme");
  botao.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
  editor.setTheme(isDark ? "ace/theme/monokai" : "ace/theme/github");
  const layoutEscuro = {
    plot_bgcolor: "#1e1e1e",
    paper_bgcolor: "#1e1e1e",
    font: { color: "#e0e0e0" },
    xaxis: { color: "#e0e0e0", gridcolor: "#444" },
    yaxis: {
          zeroline: true,
          zeroline: true, color: "#e0e0e0", gridcolor: "#444" }
  };

  const layoutClaro = {
    plot_bgcolor: "#ffffff",
    paper_bgcolor: "#ffffff",
    font: { color: "#000000" },
    xaxis: { color: "#000", gridcolor: "#ccc" },
    yaxis: {
          zeroline: true,
          zeroline: true, color: "#000", gridcolor: "#ccc" }
  };

  const layoutNovo = isDark ? layoutEscuro : layoutClaro;

  Plotly.relayout("grafico", layoutNovo);
}

</script>

<script>
function salvarAppCompleto() {
  const gd = document.getElementById("grafico");
  const curvasAtuais = JSON.stringify(gd.data);
  const layoutAtual = JSON.stringify(gd.layout || {});

  let htmlCompleto = document.documentElement.outerHTML;

  // Script que ser√° injetado no HTML salvo para redesenhar o gr√°fico
  const scriptPlotly = `
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        const data = ${curvasAtuais};
        const layout = ${layoutAtual};
        Plotly.newPlot("grafico", data, layout);
      });
    <\\/script>
  `;

</script>


<script>
function salvarProjetoCompleto() {
  const gd = document.getElementById("grafico");
  const curvasStr = JSON.stringify(gd.data);
  const layoutStr = JSON.stringify(gd.layout || {});
  const codigoStr = JSON.stringify(editor.getValue());
  const temaEscuro = document.body.classList.contains("dark-mode");

  let htmlContent = ''
    + '<!DOCTYPE html>\n'
    + '<html lang="pt">\n'
    + '<head>\n'
    + '  <meta charset="UTF-8">\n'
    + '  <title>JSPlotly Projeto Salvo</title>\n'
    + '  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"><\/script>\n'
    + '  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"><\/script>\n'
    + '  <style>\n'
    + '    body { font-family: Arial, sans-serif; margin: 20px; }\n'
    + '    .container { display: flex; justify-content: space-between; align-items: flex-start; }\n'
    + '    #grafico { width: 55%; height: 500px; }\n'
    + '    #editor-container { width: 40%; }\n'
    + '    #editor { width: 100%; height: 350px; border: 1px solid #ccc; }\n'
    + '  </style>\n'
    + '</head>\n'
    + '<body>\n'
    + '  <h2>JSPlotly - Projeto Salvo</h2>\n'
    + '  <div class="container">\n'
    + '    <div id="grafico"></div>\n'
    + '    <div id="editor-container">\n'
    + '      <div id="editor"></div>\n'
    + '    </div>\n'
    + '  </div>\n'
    + '  <script>\n'
    + '    const curvas = ' + curvasStr + ';\n'
    + '    const layout = ' + layoutStr + ';\n'
    + '    const codigo = ' + codigoStr + ';\n'
    + '    const temaEscuro = ' + JSON.stringify(temaEscuro) + ';\n'
    + '    const editor = ace.edit("editor");\n'
    + '    editor.setTheme(temaEscuro ? "ace/theme/monokai" : "ace/theme/github");\n'
    + '    editor.session.setMode("ace/mode/javascript");\n'
    + '    editor.setValue(codigo, -1);\n'
    + '    layout.editable = true;\n'
    + '    Plotly.newPlot("grafico", curvas, layout);\n'
    + '    document.body.classList.toggle("dark-mode", temaEscuro);\n'
    + '    document.getElementById("grafico").on("plotly_click", function(data) {\n'
    + '      const y = data.points[0].y;\n'
    + '      const ctx = new (window.AudioContext || window.webkitAudioContext)();\n'
    + '      const osc = ctx.createOscillator();\n'
    + '      const gain = ctx.createGain();\n'
    + '      osc.type = "sine";\n'
    + '      osc.frequency.setValueAtTime(y, ctx.currentTime);\n'
    + '      osc.connect(gain);\n'
    + '      gain.connect(ctx.destination);\n'
    + '      osc.start();\n'
    + '      osc.stop(ctx.currentTime + 0.4);\n'
    + '    });\n'
    + '  <\/script>\n'
    + '</body>\n'
    + '</html>';

  const blob = new Blob([htmlContent], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "jsplotly_projeto.html";
  a.click();
}
</script>

<script>
function salvarProjetoSomenteGrafico() {
  const gd = document.getElementById("grafico");
  const curvasStr = JSON.stringify(gd.data);
  const layoutStr = JSON.stringify(gd.layout || {});
  const framesData = gd._transitionData && gd._transitionData._frames;
  const framesStr = JSON.stringify(framesData || []);
  const temaEscuro = document.body.classList.contains("dark-mode");

  let htmlContent = ''
    + '<!DOCTYPE html>\n'
    + '<html lang="pt">\n'
    + '<head>\n'
    + '  <meta charset="UTF-8">\n'
    + '  <title>JSPlotly Gr√°fico Exportado</title>\n'
    + '  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"><\/script>\n'
    + '  <style>\n'
    + '    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: ' + (temaEscuro ? '#1e1e1e' : '#ffffff') + '; color: ' + (temaEscuro ? '#e0e0e0' : '#000000') + '; }\n'
    + '    #grafico { width: 100vw; height: 100vh; }\n'
    + '  </style>\n'
    + '</head>\n'
    + '<body>\n'
    + '  <div id="grafico"></div>\n'
    + '  <script>\n'
    + '    const data = ' + curvasStr + ';\n'
    + '    const layout = ' + layoutStr + ';\n'
    + '    const frames = ' + framesStr + ';\n'
    + '    layout.editable = false;\n'
    + '    Plotly.newPlot("grafico", data, layout).then(function() {\n'
    + '      if (frames && frames.length > 0) {\n'
    + '        Plotly.addFrames("grafico", frames);\n'
    + '        Plotly.animate("grafico", null, { frame: { duration: 500, redraw: true }, transition: { duration: 300 } });\n'
    + '      }\n'
    + '    });\n'
    + '    document.getElementById("grafico").on("plotly_click", function(data) {\n'
    + '      const y = data.points[0].y;\n'
    + '      const ctx = new (window.AudioContext || window.webkitAudioContext)();\n'
    + '      const osc = ctx.createOscillator();\n'
    + '      const gain = ctx.createGain();\n'
    + '      osc.type = "sine";\n'
    + '      osc.frequency.setValueAtTime(y, ctx.currentTime);\n'
    + '      osc.connect(gain);\n'
    + '      gain.connect(ctx.destination);\n'
    + '      osc.start();\n'
    + '      osc.stop(ctx.currentTime + 0.4);\n'
    + '    });\n'
    + '  <\/script>\n'
    + '</body>\n'
    + '</html>';

  const blob = new Blob([htmlContent], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "play.html";
  a.click();
}
</script>




<script>
function salvarCloneJSPlotly() {
  // Captura o c√≥digo do usu√°rio e escapa com seguran√ßa
  const codigoNovo = editor.getValue()
    .replace(/\\/g, '\\\\')
    .replace(/`/g, '\\`')
    .replace(/\$/g, '\\$');

  // Substitui diretamente o valor da vari√°vel codigoPadrao na string
  const novaDefinicao = 'var codigoPadrao = `' + codigoNovo + '`;';
  
  // Extrai o HTML original em partes
  const htmlOriginal = document.documentElement.outerHTML;

  const htmlAtualizado = htmlOriginal.replace(
    /var codigoPadrao = `([\s\S]*?)`;/,
    novaDefinicao
  );

  const blob = new Blob([htmlAtualizado], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "JSPlotly.html";
  a.click();
}

function abrirNoChartStudio() {
  const gd = document.getElementById('grafico');
  if (!gd || !gd.data || gd.data.length === 0) {
    alert("N√£o h√° gr√°fico para enviar. Clique em 'add' primeiro.");
    return;
  }

  const dataStr   = JSON.stringify(gd.data || []);
  const layoutStr = JSON.stringify(gd.layout || {});

  // Tenta GET quando o payload √© pequeno (URLs muito grandes podem falhar)
  const urlBase = "https://chart-studio.plotly.com/create/";
  const urlGET  = urlBase
    + "?plotlyData="   + encodeURIComponent(dataStr)
    + "&plotlyLayout=" + encodeURIComponent(layoutStr);

  if ((dataStr.length + layoutStr.length) < 1500) {
    window.open(urlGET, "_blank");
    return;
  }

  // Fallback: POST via form oculto (evita limite de URL)
  const form = document.createElement("form");
  form.method = "POST";
  form.action = urlBase;     // Editor do Chart Studio
  form.target = "_blank";

  const inpData = document.createElement("input");
  inpData.type = "hidden";
  inpData.name = "plotlyData";
  inpData.value = dataStr;

  const inpLayout = document.createElement("input");
  inpLayout.type = "hidden";
  inpLayout.name = "plotlyLayout";
  inpLayout.value = layoutStr;

  form.appendChild(inpData);
  form.appendChild(inpLayout);
  document.body.appendChild(form);
  form.submit();
  document.body.removeChild(form);
}


</script>



</body>
</html>


