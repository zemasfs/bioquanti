<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSPlotly</title>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.20.0/plotly.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.1/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ml-regression@6.0.0/dist/ml-regression.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>    
    <script src="https://cdn.jsdelivr.net/npm/ml-levenberg-marquardt@3.3.0/dist/ml-levenberg-marquardt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.5/jstat.min.js"></script>

 <!---<body style="margin:0; padding:0;">--->


    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { display: flex; justify-content: space-between; align-items: flex-start; }
        #grafico { width: 55%; height: 500px; }
        #editor-container { width: 40%; }
        #editor { width: 100%; height: 350px; border: 1px solid #ccc; }

.header-bar {
    width: 100%;
    height: 30px; 
    background: linear-gradient(to right, #F5F5DC, #EDEAE0); 
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    color: #5a4a42; /
    letter-spacing: 2px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); 
    margin-bottom: 40px;  
}



.license-info {
  font-size: 12px;
  color: gray;
  font-family: Arial, sans-serif;
  opacity: 0.8;
  text-align: center;
  margin: 30px auto 10px auto;
}


#toggleTheme {
  position: relative;
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
  margin: -2px 0 0 10px; /* margem superior e esquerda */
  display: inline-block;
  z-index: 10;
}



.dev-info {
    position: absolute;
    top: 3px; 
    left: 10px; 
    font-size: 13px !important; 
    color: #999; 
    font-family: Arial, sans-serif;
}

.dev-info a {
    text-decoration: none;
    color: #888; 
    font-weight: bold;
}
.dev-info a:hover {
    text-decoration: underline;
    color: #666; /
}

       
.button-container { 
    display: flex; 
    gap: 10px; 
    margin-top: 10px; 

  position: relative;
  z-index: 10;
}

button { 
    padding: 10px; 
    cursor: pointer; 
    border: none; 
    font-size: 14px; 
    border-radius: 5px; 
    transition: background 0.3s ease-in-out; 
}


/* BotÃ£o base */
button {
  padding: 10px;
  cursor: pointer;
  font-size: 14px;
  border-radius: 8px;
  border: 2px solid transparent;
  transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
}

.add-btn {
  background: #e2f6e9;
  color: #207a44;
  border-color: #b1e2c3;
}
.add-btn:hover {
  background: #ccf0dd;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(50, 150, 100, 0.3);
}

.remove-btn {
  background: #fff8c6;
  color: #887200;
  border-color: #f0dc7d;
}
.remove-btn:hover {
  background: #fdf2a8;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(200, 180, 20, 0.3);
}

.reset-btn {
  background: #fce1e1;
  color: #b42c2c;
  border-color: #f4b6b6;
}
.reset-btn:hover {
  background: #f8caca;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(200, 50, 50, 0.3);
}

.save-btn {
  background: #fff1db;
  color: #8a4b00;
  border-color: #ffd9a2;
}
.save-btn:hover {
  background: #ffe1ba;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(200, 120, 30, 0.3);
}

.clear-btn {
  background: #f99;
  color: white;
  border-color: #d33;
}
.clear-btn:hover {
  background: #e55;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(255, 80, 80, 0.5);
}

.save-html-btn {
  background: #e6f1fb;
  color: #125a8f;
  border-color: #a8d0f0;
}
.save-html-btn:hover {
  background: #d2e9fc;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(50, 100, 200, 0.3);
}


.author-info { position: absolute; top: 60px; right: 20px; font-size: 14px; color: gray; }
.logo { position: fixed; bottom: 10px; right: 20px; width: 100px; z-index: 10;} 
.ascii-logo {
 position: fixed;
 bottom: 10px;
 right: 20px;
 font-family: monospace;
 font-size: 2px;
 white-space: pre;
 text-align: right;
 z-index: 10; 
 }
 
.save-project-btn {
  background: linear-gradient(to bottom, #f3e6ff, #d3bdf0);
  color: #5e2d91;
  font-weight: normal;
  border: 2px solid #b48ce3;
  border-radius: 8px;
  box-shadow: 0 0 6px rgba(140, 90, 200, 0.4);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.save-project-btn:hover {
  background: linear-gradient(to bottom, #e7d4ff, #c9aee8);
  transform: scale(1.05);
  box-shadow: 0 0 8px rgba(120, 60, 180, 0.5);
}


</style>


<style>
  @media (max-width: 768px) {
    .container {
      flex-direction: column;
      align-items: stretch;
    }

    #grafico {
      width: 100% !important;
      height: 300px !important;
    }

    #editor-container {
      width: 100% !important;
    }

    #editor {
      height: 300px !important;
    }

    .button-container {
      flex-direction: column;
      gap: 8px;
    
  position: relative;
  z-index: 10;
}

    button {
      width: 100%;
      font-size: 16px;
    }

    .header-bar {
      font-size: 16px;
    }

    .popup {
      width: 90%;
    }

    .external-link {
      position: relative;
      top: auto;
      right: auto;
      margin-top: 10px;
      text-align: right;
    }
  }
</style>


<style>
  body.dark-mode {
    background-color: #1e1e1e;
    color: #e0e0e0;
  }

  body.dark-mode .header-bar {
    background: linear-gradient(to right, #2e2e2e, #1a1a1a);
    color: #f0f0f0;
  }

  body.dark-mode .button-container button {
    background: #333 !important;
    color: #ddd !important;
  }

  body.dark-mode .clear-btn {
    background-color: #a71d2a !important;
    color: white !important;
  }

  body.dark-mode #editor {
    background-color: #1e1e1e;
    color: #e0e0e0;
  }

  body.dark-mode .popup {
    background-color: #2b2b2b;
    color: #eee;
  }
  
</style>


</head>


<body>
<div class="header-bar" style="display: flex; align-items: center; justify-content: space-between; padding: 4px 10px;">
  <button id="toggleTheme" onclick="alternarTema()" style="font-size: 18px; background: none; border: none; cursor: pointer;">
    ðŸŒ™
  </button>

  <div style="flex: 1; text-align: center; font-weight: bold; font-size: 16px;">
    JSPlotly - Interactive Graphics
  </div>

  <div style="width: 30px;"><!-- espaÃ§o vazio para equilibrar com o botÃ£o da esquerda --></div>
</div>



<div class="external-link">
  <a href="https://bioquanti.netlify.app/" target="_blank">ðŸ”— Bioquanti</a>  
</div>



<div class="dev-info">
    Developed with 
    <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript" target="_blank">JavaScript</a> 
    and 
    <a href="https://plotly.com/javascript/" target="_blank">Plotly.js</a>
</div>

<div class="container">

 <div id="grafico"></div>

<div id="popup" class="popup">
    <p>Save as:</p>
    <button onclick="salvarImagem('png')">PNG</button>
    <button onclick="salvarImagem('svg')">SVG</button>
    <button onclick="fecharPopup()">Cancelar</button>
</div>

<style>
.popup {
    display: none;
    position: fixed;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    border: 1px solid #ccc;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    z-index: 1000;
}
.popup button {
    margin: 5px;
    padding: 8px;
}

.external-link {  
  position: absolute;
  top: 30px;
  right: 20px;
  font-size: 14px;
  font-family: Arial, sans-serif;
}

.external-link a {
  color: #333;
  text-decoration: none;
  font-weight: bold;
}

.external-link a:hover {
  text-decoration: underline;
  color: #0077cc;
}

.save-html-btn {
  background: linear-gradient(to bottom, #dff0f7, #add9e6);
  color: #004b66;
  font-weight: normal;
  border: 2px solid #66b8d4;
  border-radius: 8px;
  box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.save-html-btn:hover {
  background: linear-gradient(to bottom, #c4ecff, #8fd3ec);
  transform: scale(1.05);
  box-shadow: 0 0 8px rgba(0, 123, 255, 0.8);
}


</style>

  <div id="editor-container">
  

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
  <input type="file" id="fileInput" accept=".js" onchange="carregarEquacaoAuto(event)">
  
  <span style="font-size: 13px; font-family: Arial, sans-serifbioq; color: #2e7d57; text-align: right;">
    For easy code construction, try 
    <a href="https://chatgpt.com/g/g-6819fbb8d2d08191bf7d50a3dbeadb0d-gsplotly" 
       target="_blank" 
       style="color: #2e7d57 !important; font-weight: bold; text-decoration: underline;">
      GSPlotly
    </a>
  </span>
</div>





       <div id="editor"></div>
       <div class="button-container">
       <button class="add-btn" onclick="adicionarCurva()">add</button>
       <button class="remove-btn" onclick="removerUltimaCurva()">remove</button>
       <button class="clear-btn" onclick="resetarGrafico()">clean</button> 
       <button class="reset-btn" onclick="limparEditor()">delete</button>
     <!---  <button class="save-html-btn" onclick="salvarHTML()">html</button> --->             
       <button class="save-btn" onclick="salvarEquacao()">script</button> 
       <button class="save-html-btn" onclick="salvarProjetoSomenteGrafico()">html</button>
    <!---<button class="save-html-btn" onclick="salvarProjetoCompleto()">save project</button> --->
       <button class="save-project-btn" onclick="salvarCloneJSPlotly()">clone</button>
       
    
  </div>
</div>
    </div>
    
    
<script>
 var curvas = [];
 var cores = ["red", "blue", "green", "purple", "orange", "brown", "pink", "gray"];
 var corIndex = 0;
 var editor = ace.edit("editor");
 editor.setTheme("ace/theme/github");
 editor.session.setMode("ace/mode/javascript");
 editor.session.setUseWrapMode(true);
 editor.setOptions({
  fontSize: "14px",
  wrap: true,
  showPrintMargin: false
});



var customSaveButton = {
    name: 'PNG or SVG',
    icon: Plotly.Icons.disk,
    click: function(gd) {
        abrirPopup();
    }
};


var config = {
  modeBarButtonsToAdd: [
    'toggleSpikelines',
    'hoverCompareCartesian',
    'drawline',
    'drawopenpath',
    'drawrect',
    'drawcircle',
    //'eraseshape',
    customSaveButton,
    {
      name: 'change color',
      icon: Plotly.Icons.camera,
      click: function(gd) {
        const ultima = curvas.length - 1;
        const novaCor = cores[Math.floor(Math.random() * cores.length)];
        Plotly.restyle(gd, { 'line.color': novaCor }, [ultima]);
        curvas[ultima].line.color = novaCor;
      }
    },
  {
  name: 'Adicionar Texto',
  icon: {
    width: 1000,
    height: 1000,
    path: 'M200 800V160h600v80H540v560h-80V240H200z' // Ãcone simples em forma de "T"
  },
  click: function(gd) {
    // O clique no botÃ£o ativa o modo de anotaÃ§Ã£o
    const handler = function(eventData) {
      const x = eventData.points[0].x;
      const y = eventData.points[0].y;
      const texto = prompt("Digite o texto a ser inserido:");
      if (texto) {
        Plotly.relayout(gd, {
          annotations: (gd.layout.annotations || []).concat([{
            x: x,
            y: y,
            text: texto,
            showarrow: true,
            arrowhead: 2
          }])
        });
      }
      gd.removeListener('plotly_click', handler);
    };
    gd.on('plotly_click', handler);
  }
}
  ],
  showEditInChartStudio: true,
  plotlyServerURL: "https://chart-studio.plotly.com",
  displaylogo: false,
  displayModeBar: true,
  responsive: true,
  scrollZoom: true,
  editable: true,
  modeBarButtonsToRemove: [
    'select2d',
    'lasso2d',
    'resetScale2d',
    'zoomOut2d',
    'zoomIn2d',
    'toImage'
  ]
};
 

function executarCodigo() {
    try {
        var codigoUsuario = editor.getValue().trim();
        Plotly.purge('grafico'); 
        eval(codigoUsuario);
    } 

catch (error) {
           
    }
}

function limparGrafico() {
    Plotly.purge('grafico');
}

function carregarEquacaoAuto(event) {
 const file = event.target.files[0];
 if (file) {
   const reader = new FileReader();
         reader.onload = function(e) {
         editor.setValue(e.target.result, -1);
                 };
         reader.readAsText(file);
                 }
           }

function adicionarCurva() {
  const codigoUsuario = editor.getValue();

  let consoleSaida = [];
  const logOriginal = console.log;
  console.log = (...args) => {
    consoleSaida.push(args.map(arg => typeof arg === "object" ? JSON.stringify(arg) : String(arg)).join(" "));
  };

  let resultado;
  try {
    const func = new Function(codigoUsuario + "\nreturn typeof output !== 'undefined' ? output : undefined;");
    resultado = func();
  } catch (e1) {
    try {
      const func = new Function(codigoUsuario);
      resultado = func();
    } catch (e2) {
      console.log = logOriginal;
      alert("Erro ao executar o cÃ³digo:\n" + e2.message);
      return;
    }
  }

  console.log = logOriginal;
  if (!resultado) return;

  const texto = consoleSaida.map(l => "> " + l).join("<br>");
  const layout = resultado.layout || {};
  layout.annotations = layout.annotations || [];

  if (texto.trim()) {
    layout.annotations.push({
      text: `<div style="font-family: monospace; font-size: 14px; max-height: 200px; overflow-y: auto; background:#f9f9f9; padding:5px; border:1px solid #ccc;">${texto}</div>`,
      showarrow: false,
      xref: 'paper',
      yref: 'paper',
      x: 0,
      y: 1,
      align: 'left',
      xanchor: 'left',
      yanchor: 'top'
    });
  }




  let data = [];
  if (resultado.data) {
    data = resultado.data;
  } else if (resultado.trace) {
    data = [resultado.trace];
  } else if (resultado.traces) {
    data = resultado.traces;
  } else if (resultado.x_values && resultado.y_values) {
    data = [{
      x: resultado.x_values,
      y: resultado.y_values,
      type: 'scatter',
      mode: 'lines+markers',
      name: resultado.title || "Curva"
    }];
    if (resultado.x_range) layout.xaxis = { range: resultado.x_range, title: resultado.x_label || "" };
    if (resultado.y_range) layout.yaxis = { range: resultado.y_range, title: resultado.y_label || "" };
    layout.title = resultado.title || "";
  }

  curvas.push(...data);

  Plotly.newPlot("grafico", curvas, layout, config).then(() => {
    if (resultado.frames && resultado.frames.length > 0) {
      Plotly.addFrames("grafico", resultado.frames);
      Plotly.animate("grafico", null, {
        frame: { duration: 80, redraw: true },
        transition: { duration: 0 }
      });
    }
  });
}




function resetarGrafico() {
            curvas = [];
            corIndex = 0;
            Plotly.newPlot('grafico', [], {xaxis: { title: 'X' }, yaxis: {
          zeroline: true,
          zeroline: true, title: 'Y' } });
        }

function salvarEquacao() {
    var blob = new Blob([editor.getValue()], { type: "text/javascript" });
    var a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "script.js";
        document.body.appendChild(a);
        a.click();
            document.body.removeChild(a);
       }

        

function salvarHTML() {
    var plotlyData = JSON.parse(JSON.stringify(curvas));
    var plotlyLayout = document.getElementById('grafico').layout;
    var htmlContent = '<!DOCTYPE html>\n' +
                '<html>\n' +
                '<head>\n' +
                '    <meta charset="UTF-8">\n' +
                '    <title>GrÃ¡fico Salvo</title>\n' +
                '    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.20.0/plotly.min.js"><\/script>\n' +
                '</head>\n' +
                '<body>\n' +
                '    <div id="grafico" style="width: 100%; height: 600px;"></div>\n' +
                '    <script>\n' +
                '        var data = ' + JSON.stringify(plotlyData) + ';\n' +
                '        var layout = ' + JSON.stringify(plotlyLayout) + ';\n' +
                '        Plotly.newPlot("grafico", data, layout);\n' +
                '    <\/script>\n' +
                '</body>\n' +
                '</html>';

function salvarAppCompleto() {
  const htmlBase = document.documentElement.outerHTML;
  const blob = new Blob([htmlBase], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "jsplotly_completo.html";
  a.click();
}


var blob = new Blob([htmlContent], { type: 'text/html' });
var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
//    a.download = 'grafico_interativo.html';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
        }

function limparEditor() {
    editor.setValue("", -1); 
    }

function removerUltimaCurva() {
    if (curvas.length > 0) {
    curvas.pop(); 
    atualizarGrafico(); 
        } else {
        alert("No curves to remove!");
      }
    }


function atualizarGrafico() {
    Plotly.newPlot('grafico', curvas, {
        title: 'GrÃ¡fico Interativo',
        xaxis: { title: 'X' },
        yaxis: {
          zeroline: true,
          zeroline: true, title: 'Y' },
        showlegend: true
    });
}

function abrirPopup() {
    document.getElementById('popup').style.display = 'block';
}

function fecharPopup() {
    document.getElementById('popup').style.display = 'none';
}

function salvarImagem(formato) {
    Plotly.downloadImage('grafico', {format: formato, filename: 'plot'});
    fecharPopup();
}


function limparTudo() {
   editor.setValue("", -1);
     let graficoDiv = document.getElementById("grafico");
     if (graficoDiv) {
            Plotly.newPlot("grafico", [], {
            xaxis: { title: "Eixo X" },
            yaxis: {
          zeroline: true,
          zeroline: true, title: "Eixo Y" }
        });
        graficoDiv.data = [];
    }
}


// Definir a equaÃ§Ã£o quadrÃ¡tica padrÃ£o
var codigoPadrao = `
// Quadro de Giz Digital (v1.16-responsive)
// Base: v1.15-touch + melhorias de layout (desktop e mobile)
//  - BotÃ£o "tela" (fullscreen) e "sair" (para sair do fullscreen)
//  - CSS responsivo para smartphone (botÃµes compactos)
//  - Safe-area para iOS, 100svh/dvh no modo tela cheia
//  - MantÃ©m: patches anti-duplicaÃ§Ã£o e ocultar plot do mesmo contÃªiner
(function () {
  var CONFIG = {
    TARGET_SELECTOR:
      (document.currentScript && document.currentScript.getAttribute('data-target')) ||
      '#grafico, #plot',
    INSERT_MODE: 'prepend',
    SCROLL_INTO_VIEW: true,
    HIDE_HOST_CHILDREN: true,
    SINGLETON_PER_HOST: true
  };

  var BOARD = '#2b5441';
  var CHALK_NOISE = true;
  var GRID_STEP = 40;

  var host =
    document.querySelector(CONFIG.TARGET_SELECTOR) ||
    (document.currentScript && document.currentScript.parentElement) ||
    document.body;

  if (CONFIG.SINGLETON_PER_HOST) {
    var existing = host.querySelector('.qg_wrap');
    if (existing) {
      try { if (CONFIG.SCROLL_INTO_VIEW) existing.scrollIntoView({block:'center', behavior:'smooth'}); } catch(_){}
      return;
    }
  }

  var uid = 'qg_' + Math.random().toString(36).slice(2, 8);

  var style = document.createElement('style');
  style.textContent =
    ".qg_wrap{position:relative;display:block;height:100%;min-height:60vh}" +
    ".qg_board{position:relative;padding-bottom:var(--tools-h,44px);user-select:none;-webkit-user-select:none;touch-action:none;-ms-touch-action:none;overscroll-behavior:contain}" +
    ".qg_canvas{display:block;width:100%;height:100%;background:" + BOARD + ";touch-action:none;-ms-touch-action:none}" +
    ".qg_overlay{position:absolute;inset:0;pointer-events:none}" +
    ".qg_tools{position:absolute;left:0;right:0;bottom:0;z-index:4;display:flex;align-items:center;gap:6px;flex-wrap:nowrap;overflow-x:auto;padding:6px 8px;padding-bottom:calc(env(safe-area-inset-bottom,0) + 6px);background:rgba(0,0,0,.35);border-top:1px solid rgba(255,255,255,.2);backdrop-filter:blur(6px)}" +
    ".qg_tools::-webkit-scrollbar{height:6px}.qg_tools::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:4px}.qg_tools{scrollbar-width:thin}" +
    ".qg_hint{position:absolute;left:10px;bottom:calc(var(--tools-h,44px) + 10px);z-index:3;color:#e6f2eb;opacity:.85;font:500 11px/1.2 ui-sans-serif,system-ui;white-space:nowrap;pointer-events:none;text-shadow:0 1px 1px rgba(0,0,0,.35)}" +
    ".qg_btn{appearance:none;border:1px solid rgba(255,255,255,.2);color:#f1f5f9;background:rgba(255,255,255,.06);font:600 11px/1 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu;padding:5px 7px;border-radius:8px;cursor:pointer}" +
    ".qg_btn:active{transform:translateY(1px)}" +
    ".qg_swatch{width:18px;height:18px;border-radius:999px;border:1.5px solid rgba(255,255,255,.6);cursor:pointer;display:inline-block}" +
    ".qg_swatch[aria-current='true']{outline:2px solid #fff;outline-offset:2px}" +
    ".qg_group{display:flex;gap:4px;align-items:center;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.2);padding:3px 5px;border-radius:8px}" +
    ".qg_toggle[aria-pressed='true']{background:rgba(255,255,255,.2)}" +
    ".qg_host-mute > :not(.qg_wrap){display:none!important}" +
    // fullscreen
    ".qg_wrap.qg_fs{position:fixed!important;inset:0!important;z-index:9999!important;background:#0b0f0e}" +
    ".qg_wrap.qg_fs .qg_board{min-height:100svh}" +
    "@supports (height:100dvh){.qg_wrap.qg_fs .qg_board{min-height:100dvh}}" +
    ".qg_wrap.qg_fs .qg_tools{padding-bottom:calc(env(safe-area-inset-bottom,0) + 10px)}" +
    "html.qg_noscroll, body.qg_noscroll{overflow:hidden!important}" +
    // compact on small screens
    "@media (max-width:520px){.qg_btn{font-size:10px;padding:3px 6px;border-radius:7px}.qg_group{gap:3px;padding:2px 3px}.qg_swatch{width:16px;height:16px}.qg_hint{font-size:10px}}";
  document.head.appendChild(style);

  var wrap = document.createElement('div');
  wrap.className = 'qg_wrap';
  wrap.setAttribute('data-uid', uid);

  var board = document.createElement('div'); board.className = 'qg_board';
  var canvas = document.createElement('canvas'); canvas.className = 'qg_canvas';
  var overlay = document.createElement('canvas'); overlay.className = 'qg_overlay';
  var tools = document.createElement('div'); tools.className = 'qg_tools';
  var hint = document.createElement('div'); hint.className = 'qg_hint';
  hint.textContent = "Dica: Z desfaz, X limpa, E=borracha (segure), L=laser (segure), H salva HTML";

  try { board.style.touchAction = 'none'; canvas.style.touchAction = 'none'; overlay.style.touchAction = 'none'; } catch(_) {}

  board.appendChild(canvas);
  board.appendChild(overlay);
  board.appendChild(hint);
  board.appendChild(tools);
  wrap.appendChild(board);

  if (CONFIG.INSERT_MODE === 'prepend' && host.firstElementChild) host.insertBefore(wrap, host.firstElementChild);
  else host.appendChild(wrap);
  if (CONFIG.HIDE_HOST_CHILDREN) host.classList.add('qg_host-mute');

  var THEMES = {"Verde":"#2b5441","Verde claro":"#3a7156","ArdÃ³sia":"#2b3238","Quadro preto":"#111214"};
  function currentThemeName(){ for (var n in THEMES) if (THEMES[n]===BOARD) return n; return "Verde"; }
  var selTheme = document.createElement('select'); selTheme.className='qg_select qg_btn'; selTheme.title='Plano de fundo'; selTheme.setAttribute('data-role','theme');
  Object.keys(THEMES).forEach(function(name){ var o=document.createElement('option'); o.value=name; o.textContent=name; selTheme.appendChild(o); });
  selTheme.value = currentThemeName(); tools.appendChild(selTheme);
  function applyTheme(nameOrColor){ var c = THEMES[nameOrColor] || nameOrColor; BOARD = c; canvas.style.background = c; redraw(); }
  selTheme.onchange = function(){ applyTheme(this.value); };

  var colors = ['#f8fafc','#fde047','#f97316','#ef4444','#22c55e','#3b82f6','#a855f7'];
  function swatch(color, selected){
    var s = document.createElement('span');
    s.className = 'qg_swatch';
    s.style.background = color;
    s.setAttribute('data-color', color);
    s.setAttribute('aria-current', selected ? 'true' : 'false');
    s.addEventListener('click', function(){
      [].forEach.call(tools.querySelectorAll('.qg_swatch'), function(el){ el.setAttribute('aria-current','false'); });
      s.setAttribute('aria-current','true');
      currentColor=color;
      setLaser(false);
    });
    return s;
  }
  var gSw = document.createElement('div'); gSw.className='qg_group';
  colors.forEach(function(c,i){ gSw.appendChild(swatch(c, i===0)); });
  tools.appendChild(gSw);

  function addToggle(label, role){ var b=document.createElement('button'); b.className='qg_btn qg_toggle'; b.textContent=label; if(role) b.setAttribute('data-role',role); return b; }
  var gSize=document.createElement('div'); gSize.className='qg_group'; tools.appendChild(gSize);
  var b1=addToggle('1x','w1'), b2=addToggle('2x','w2'), b4=addToggle('4x','w4'); gSize.appendChild(b1); gSize.appendChild(b2); gSize.appendChild(b4);

  var gELG=document.createElement('div'); gELG.className='qg_group'; tools.appendChild(gELG);
  var btnErase=addToggle('erase','erase'), btnLaser=addToggle('laser','laser'), btnGrid=addToggle('grid','grid');
  btnErase.title='Alternar borracha'; btnLaser.title='Marcador laser'; btnGrid.title='Mostrar/ocultar grade';
  gELG.appendChild(btnErase); gELG.appendChild(btnLaser); gELG.appendChild(btnGrid);

  var gAct=document.createElement('div'); gAct.className='qg_group'; tools.appendChild(gAct);
  function addBtn(label, role, title){ var b=document.createElement('button'); b.className='qg_btn'; b.textContent=label; if(role) b.setAttribute('data-role',role); if(title) b.title=title; return b; }
  var btnPNG=addBtn('png','png','Exportar PNG');
  var btnUndo=addBtn('undo','undo','Desfazer (Z)');
  var btnClean=addBtn('clean','clean','Limpar (X)');
  var btnHTML=addBtn('html','html','Salvar HTML (H)');
  var btnFULL=addBtn('tela','full','Tela cheia (alternar)');
  var btnEXIT=addBtn('sair','exit','Sair da tela cheia');
  gAct.appendChild(btnPNG); gAct.appendChild(btnUndo); gAct.appendChild(btnClean); gAct.appendChild(btnHTML); gAct.appendChild(btnFULL); gAct.appendChild(btnEXIT);

  var currentColor = colors[0], baseWidth=4, widthMul=1;
  var showGrid=false;
  var strokes = Array.isArray(window.__INITIAL_STROKES__) ? window.__INITIAL_STROKES__ : [];
  var cur=null, drawing=false, erasing=false, eraseHold=false, laserHold=false;

  var dpr=Math.max(1, window.devicePixelRatio||1), W=0,H=0;
  var ctx=canvas.getContext('2d'), octx=overlay.getContext('2d');

  function setToolsHeight(){ try{ var th=Math.ceil(tools.getBoundingClientRect().height||44); board.style.setProperty('--tools-h', th+'px'); }catch(_){ board.style.setProperty('--tools-h','44px'); } }
  function setSize(){
    var r = board.getBoundingClientRect();
    W = Math.max(200, Math.floor(r.width));
    H = Math.max(200, Math.floor(Math.max(r.height, window.innerHeight*0.6)));
    [canvas, overlay].forEach(function(cv){
      cv.width = Math.floor(W*dpr); cv.height = Math.floor(H*dpr);
      cv.style.width = W+'px'; cv.style.height = H+'px';
    });
    ctx.setTransform(dpr,0,0,dpr,0,0);
    octx.setTransform(dpr,0,0,dpr,0,0);
    setToolsHeight();
    redraw();
  }
  window.addEventListener('resize', function(){ setToolsHeight(); setSize(); }, {passive:true});
  try{ new ResizeObserver(function(){ setToolsHeight(); }).observe(tools); }catch(_){}
  setSize();

  if (CONFIG.SCROLL_INTO_VIEW) { try { wrap.scrollIntoView({block:'center', behavior:'smooth'}); } catch(_){} }

  function setMul(m){
    widthMul=m;
    [b1,b2,b4].forEach(function(b){ b.setAttribute('aria-pressed','false'); });
    ({1:b1,2:b2,4:b4}[m]||b1).setAttribute('aria-pressed','true');
  }
  setMul(1);
  b1.onclick=function(){setMul(1)}; b2.onclick=function(){setMul(2)}; b4.onclick=function(){setMul(4)};

  btnGrid.onclick=function(){ showGrid=!showGrid; this.setAttribute('aria-pressed', String(showGrid)); redraw(); };
  btnErase.onclick=function(){ var v=this.getAttribute('aria-pressed')==='true'; this.setAttribute('aria-pressed', String(!v)); setLaser(false); };

  function setLaser(on){ btnLaser.setAttribute('aria-pressed', String(!!on)); }
  btnLaser.onclick=function(){ setLaser(!(this.getAttribute('aria-pressed')==='true')); };
  function laserActive(){ return (btnLaser.getAttribute('aria-pressed')==='true') || laserHold; }
  var laserFadeRunning=false, fadeTail=0;
  function startLaserFade(){
    fadeTail = 12;
    if (laserFadeRunning) return;
    laserFadeRunning = true;
    (function tick(){
      octx.globalCompositeOperation='destination-out';
      octx.fillStyle='rgba(0,0,0,0.06)';
      octx.fillRect(0,0,W,H);
      octx.globalCompositeOperation='source-over';
      if (laserActive()) fadeTail = 12;
      if (laserActive() || --fadeTail > 0) requestAnimationFrame(tick);
      else laserFadeRunning = false;
    })();
  }
  function laserDot(x,y){
    octx.globalCompositeOperation='source-over';
    octx.fillStyle='rgba(255,60,60,0.95)';
    octx.beginPath(); octx.arc(x,y,6,0,Math.PI*2); octx.fill();
    startLaserFade();
  }

  function noise(){ return (Math.random()-0.5)*2; }
  function drawSeg(s,a,b){
    var w=(s.width*(0.6+((b.p||0.5))*0.8));
    ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle=s.color; ctx.lineWidth=w;
    ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();
    if(CHALK_NOISE){
      ctx.globalAlpha=0.22; ctx.lineWidth=w*1.35;
      ctx.beginPath(); ctx.moveTo(a.x+noise(),a.y+noise()); ctx.lineTo(b.x+noise(),b.y+noise()); ctx.stroke();
      ctx.lineWidth=Math.max(1,w*0.5);
      ctx.beginPath(); ctx.moveTo(a.x+noise(),a.y-noise()); ctx.lineTo(b.x-noise(),b.y+noise()); ctx.stroke();
      ctx.globalAlpha=1;
    }
  }
  function dust(){
    if(!CHALK_NOISE) return;
    var n=Math.floor((W*H)/30000);
    ctx.save(); ctx.globalAlpha=0.05; ctx.fillStyle='rgba(255,255,255,1)';
    for(var i=0;i<n;i++){ var r=Math.random()*1.1; ctx.beginPath(); ctx.arc(Math.random()*W,Math.random()*H,r,0,Math.PI*2); ctx.fill(); }
    ctx.restore();
  }
  function redraw(){
    ctx.fillStyle=BOARD; ctx.fillRect(0,0,W,H);
    if(showGrid){
      ctx.save(); ctx.globalAlpha=0.25; ctx.strokeStyle='rgba(255,255,255,.25)'; ctx.lineWidth=1;
      for(var x=0;x<=W;x+=GRID_STEP){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
      for(var y=0;y<=H;y+=GRID_STEP){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }
      ctx.restore();
    }
    for(var k=0;k<strokes.length;k++){ var s=strokes[k],p=s.points; if(!p||p.length<2) continue; for(var i=1;i<p.length;i++){ drawSeg(s,p[i-1],p[i]); } }
    octx.clearRect(0,0,W,H); dust();
  }
  function pt(ev){ var rc=canvas.getBoundingClientRect(); return {x:ev.clientX-rc.left, y:ev.clientY-rc.top, p:(typeof ev.pressure==='number'&&ev.pressure>0)?ev.pressure:0.5}; }

  ['touchstart','touchmove','touchend','gesturestart','gesturechange','gestureend'].forEach(function(type){
    board.addEventListener(type, function(e){ e.preventDefault(); }, {passive:false});
  });

  canvas.addEventListener('contextmenu', function(e){ e.preventDefault(); });

  function beginDraw(ev){
    ev.preventDefault(); canvas.setPointerCapture(ev.pointerId);
    var rightBtn=(ev.button===2)||((typeof ev.buttons==='number')&&((ev.buttons&2)===2));
    var fixedErase = btnErase.getAttribute('aria-pressed')==='true';
    erasing = rightBtn || eraseHold || fixedErase;
    var p=pt(ev);
    if(laserActive()){ laserDot(p.x,p.y); drawing=false; return; }
    drawing=true; cur={ color:(erasing?BOARD:currentColor), width:baseWidth*widthMul, mode:erasing?'erase':'draw', points:[p] };
    strokes.push(cur);
    ctx.fillStyle=cur.color; var r=(cur.width*(0.6+p.p*0.8))/2; ctx.beginPath(); ctx.arc(p.x,p.y,r,0,Math.PI*2); ctx.fill();
  }

  function feedMove(ev){
    var list = (typeof ev.getCoalescedEvents === 'function') ? ev.getCoalescedEvents() : [ev];
    for (var j=0; j<list.length; j++){
      var e = list[j];
      var p=pt(e);
      if(laserActive()){ laserDot(p.x,p.y); continue; }
      if(!drawing) continue;
      ev.preventDefault();
      var a=cur.points[cur.points.length-1]; cur.points.push(p);
      var dx=p.x-a.x, dy=p.y-a.y, dist=Math.sqrt(dx*dx+dy*dy), steps=Math.max(1,Math.floor(dist/4));
      for(var i=1;i<=steps;i++){ var t=i/steps; drawSeg(cur,a,{x:a.x+dx*t,y:a.y+dy*t,p:p.p}); }
    }
  }

  function endDraw(ev){
    if(laserActive()){ try{canvas.releasePointerCapture(ev.pointerId);}catch(_){} return; }
    if(!drawing) return;
    ev.preventDefault();
    drawing=false;
    try{ canvas.releasePointerCapture(ev.pointerId); }catch(_){}
  }

  canvas.addEventListener('pointerdown', beginDraw, {passive:false});
  canvas.addEventListener('pointermove', feedMove, {passive:false});
  canvas.addEventListener('pointerrawupdate', feedMove, {passive:false});
  canvas.addEventListener('pointerup', endDraw, {passive:false});
  canvas.addEventListener('pointercancel', endDraw, {passive:false});

  window.addEventListener('keydown', function(e){
    if(e.key==='e'||e.key==='E'){ eraseHold=true; setLaser(false); }
    if(e.key==='l'||e.key==='L'){ laserHold=true; }
    if(e.key==='f'||e.key==='F'){ toggleFull(); }
    if(e.key==='z'||e.key==='Z'){ e.preventDefault(); if(strokes.length){strokes.pop();redraw();} }
    if(e.key==='x'||e.key==='X'){ e.preventDefault(); strokes.length=0; redraw(); }
    if(e.key==='h'||e.key==='H'){ e.preventDefault(); saveAsHTML(); }
  });
  window.addEventListener('keyup', function(e){
    if(e.key==='e'||e.key==='E'){ eraseHold=false; }
    if(e.key==='l'||e.key==='L'){ laserHold=false; }
  });

  function toggleFull(force){
    var on = (force!==undefined)? !!force : !wrap.classList.contains('qg_fs');
    wrap.classList.toggle('qg_fs', on);
    (on?document.documentElement.classList.add:document.documentElement.classList.remove)('qg_noscroll');
    (on?document.body.classList.add:document.body.classList.remove)('qg_noscroll');
    btnEXIT.style.display = on ? 'inline-block' : 'none';
    setTimeout(setSize, 0);
  }
  btnFULL.addEventListener('click', function(){ toggleFull(); });
  btnEXIT.addEventListener('click', function(){ toggleFull(false); });
  btnEXIT.style.display = 'none';

  function savePNG(){
    try{
      var a=document.createElement('a'); a.href=canvas.toDataURL('image/png');
      var ts=new Date().toISOString().replace(/[:.]/g,'-'); a.download='quadro-giz-'+ts+'.png';
      document.body.appendChild(a); a.click(); a.remove();
    }catch(err){ alert('Falha ao salvar PNG: '+err.message); }
  }

  function saveAsHTML(){
    try{
      var css = "<style>"+style.textContent+"</style>";
      var htmlUI = wrap.cloneNode(true).outerHTML;

      var RUNTIME = "(function(){"+
        "var wrap=document.querySelector('.qg_wrap'), board=wrap.querySelector('.qg_board');"+
        "var canvas=wrap.querySelector('.qg_canvas'), overlay=wrap.querySelector('.qg_overlay'), tools=wrap.querySelector('.qg_tools');"+
        "var ctx=canvas.getContext('2d'), octx=overlay.getContext('2d');"+
        "var dpr=Math.max(1,window.devicePixelRatio||1), W=0, H=0;"+
        "var GRID_STEP="+GRID_STEP+", CHALK_NOISE="+(CHALK_NOISE?'true':'false')+";"+
        "var strokes=(Array.isArray(window.__INITIAL_STROKES__)?window.__INITIAL_STROKES__:[]);"+
        "var BOARD='"+BOARD.replace(/'/g,"\\'")+"', showGrid="+(showGrid?'true':'false')+", currentColor='#f8fafc', baseWidth=4, widthMul=1;"+
        "function setToolsHeight(){try{var th=Math.ceil(tools.getBoundingClientRect().height||44);board.style.setProperty('--tools-h',th+'px');}catch(_){board.style.setProperty('--tools-h','44px');}}"+
        "function setSize(){var r=board.getBoundingClientRect();W=Math.max(200,Math.floor(r.width));H=Math.max(200,Math.floor(Math.max(r.height,window.innerHeight*0.6)));[canvas,overlay].forEach(function(cv){cv.width=Math.floor(W*dpr);cv.height=Math.floor(H*dpr);cv.style.width=W+'px';cv.style.height=H+'px';});ctx.setTransform(dpr,0,0,dpr,0,0);octx.setTransform(dpr,0,0,dpr,0,0);setToolsHeight();redraw();}"+
        "window.addEventListener('resize',function(){setToolsHeight();setSize();},{passive:true}); try{new ResizeObserver(function(){setToolsHeight();}).observe(tools);}catch(_){ }"+
        "function noise(){return (Math.random()-0.5)*2;}"+
        "function drawSeg(s,a,b){var w=s.width*(0.6+((b.p||0.5))*0.8);ctx.lineCap='round';ctx.lineJoin='round';ctx.strokeStyle=s.color;ctx.lineWidth=w;ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.stroke(); if(CHALK_NOISE){ctx.globalAlpha=0.22;ctx.lineWidth=w*1.35;ctx.beginPath();ctx.moveTo(a.x+noise(),a.y+noise());ctx.lineTo(b.x+noise(),b.y+noise());ctx.stroke();ctx.lineWidth=Math.max(1,w*0.5);ctx.beginPath();ctx.moveTo(a.x+noise(),a.y-noise());ctx.lineTo(b.x-noise(),b.y+noise());ctx.stroke();ctx.globalAlpha=1;}}"+
        "function dust(){if(!CHALK_NOISE)return;var n=Math.floor((W*H)/30000);ctx.save();ctx.globalAlpha=0.05;ctx.fillStyle='rgba(255,255,255,1)';for(var i=0;i<n;i++){var r=Math.random()*1.1;ctx.beginPath();ctx.arc(Math.random()*W,Math.random()*H,r,0,Math.PI*2);ctx.fill();}ctx.restore();}"+
        "function redraw(){ctx.fillStyle=BOARD;ctx.fillRect(0,0,W,H);if(showGrid){ctx.save();ctx.globalAlpha=0.25;ctx.strokeStyle='rgba(255,255,255,.25)';ctx.lineWidth=1;for(var x=0;x<=W;x+="+GRID_STEP+"){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,H);ctx.stroke();}for(var y=0;y<=H;y+="+GRID_STEP+"){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(W,y);ctx.stroke();}ctx.restore();}for(var k=0;k<strokes.length;k++){var s=strokes[k],p=s.points;if(!p||p.length<2)continue;for(var i=1;i<p.length;i++){drawSeg(s,p[i-1],p[i]);}}octx.clearRect(0,0,W,H);dust();}"+
        "function pt(ev){var rc=canvas.getBoundingClientRect();return {x:ev.clientX-rc.left,y:ev.clientY-rc.top,p:(typeof ev.pressure==='number'&&ev.pressure>0)?ev.pressure:0.5};}"+
        "var btnPNG=tools.querySelector('[data-role=png]'),btnUndo=tools.querySelector('[data-role=undo]'),btnClean=tools.querySelector('[data-role=clean]'),btnHTML=tools.querySelector('[data-role=html]'),btnFULL=tools.querySelector('[data-role=full]'),btnEXIT=tools.querySelector('[data-role=exit]');"+
        "var btnErase=tools.querySelector('[data-role=erase]'),btnLaser=tools.querySelector('[data-role=laser]'),btnGrid=tools.querySelector('[data-role=grid]');"+
        "var b1=tools.querySelector('[data-role=w1]'),b2=tools.querySelector('[data-role=w2]'),b4=tools.querySelector('[data-role=w4]');"+
        "var selTheme=tools.querySelector('[data-role=theme]');"+
        "var swatches=[].slice.call(tools.querySelectorAll('.qg_swatch'));"+
        "function pickColor(el){swatches.forEach(function(x){x.setAttribute('aria-current','false');});el.setAttribute('aria-current','true');currentColor=el.getAttribute('data-color')||getComputedStyle(el).backgroundColor;if(btnLaser)btnLaser.setAttribute('aria-pressed','false');}"+
        "swatches.forEach(function(el){el.addEventListener('click',function(){pickColor(el);});});"+
        "var selected=tools.querySelector('.qg_swatch[aria-current=\\\"true\\\"]')||swatches[0]; if(selected) currentColor=selected.getAttribute('data-color')||getComputedStyle(selected).backgroundColor;"+
        "function setMul(m){widthMul=m;[b1,b2,b4].forEach(function(b){b&&b.setAttribute('aria-pressed','false');});({1:b1,2:b2,4:b4}[m]||b1).setAttribute('aria-pressed','true');} setMul(1);"+
        "if(b1)b1.addEventListener('click',function(){setMul(1)}); if(b2)b2.addEventListener('click',function(){setMul(2)}); if(b4)b4.addEventListener('click',function(){setMul(4)});"+
        "if(selTheme) selTheme.addEventListener('change', function(){ var T={'Verde':'#2b5441','Verde claro':'#3a7156','ArdÃ³sia':'#2b3238','Quadro preto':'#111214'}; BOARD=T[this.value]||this.value; canvas.style.background=BOARD; redraw(); });"+
        "if(btnGrid){btnGrid.addEventListener('click',function(){showGrid=!showGrid; this.setAttribute('aria-pressed', String(showGrid)); redraw();}); btnGrid.setAttribute('aria-pressed', String(showGrid));}"+
        "if(btnErase) btnErase.addEventListener('click',function(){var v=this.getAttribute('aria-pressed')==='true'; this.setAttribute('aria-pressed', String(!v)); if(btnLaser) btnLaser.setAttribute('aria-pressed','false');});"+
        "function laserActive(){return (btnLaser && btnLaser.getAttribute('aria-pressed')==='true') || laserHold;}"+
        "if(btnLaser) btnLaser.addEventListener('click',function(){this.setAttribute('aria-pressed', String(!(this.getAttribute('aria-pressed')==='true')));});"+
        "var drawing=false,cur=null,laserHold=false,laserFadeRunning=false,fadeTail=0;"+
        "function startLaserFade(){fadeTail=12; if(laserFadeRunning) return; laserFadeRunning=true; (function tick(){octx.globalCompositeOperation='destination-out';octx.fillStyle='rgba(0,0,0,0.06)';octx.fillRect(0,0,W,H);octx.globalCompositeOperation='source-over'; if(laserActive()) fadeTail=12; if(laserActive()||--fadeTail>0) requestAnimationFrame(tick); else laserFadeRunning=false;})();}"+
        "function laserDot(x,y){octx.globalCompositeOperation='source-over';octx.fillStyle='rgba(255,60,60,0.95)';octx.beginPath();octx.arc(x,y,6,0,Math.PI*2);octx.fill();startLaserFade();}"+
        "canvas.addEventListener('contextmenu',function(e){e.preventDefault();});"+
        "function feedMove(ev){var list=(ev.getCoalescedEvents?ev.getCoalescedEvents():[ev]);for(var j=0;j<list.length;j++){var e=list[j];var rc=canvas.getBoundingClientRect();var p={x:e.clientX-rc.left,y:e.clientY-rc.top,p:(typeof e.pressure==='number'&&e.pressure>0)?e.pressure:0.5}; if(laserActive()){laserDot(p.x,p.y);continue;} if(!drawing) continue; ev.preventDefault(); var a=cur.points[cur.points.length-1]; cur.points.push(p); var dx=p.x-a.x,dy=p.y-a.y,dist=Math.sqrt(dx*dx+dy*dy),steps=Math.max(1,Math.floor(dist/4)); for(var i=1;i<=steps;i++){ var t=i/steps; var b={x:a.x+dx*t,y:a.y+dy*t,p:p.p}; var w=4*widthMul*(0.6+((b.p||0.5))*0.8); ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle=cur.color; ctx.lineWidth=w; ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke(); }}}"+
        "function endDraw(ev){if(!drawing) return; ev.preventDefault(); drawing=false; try{canvas.releasePointerCapture(ev.pointerId);}catch(_){}}"+
        "function beginDraw(ev){ev.preventDefault();canvas.setPointerCapture(ev.pointerId);var rightBtn=(ev.button===2)||((typeof ev.buttons==='number')&&((ev.buttons&2)===2));var fixedErase=btnErase&&(btnErase.getAttribute('aria-pressed')==='true');var erasing=rightBtn||fixedErase;var rc=canvas.getBoundingClientRect();var p={x:ev.clientX-rc.left,y:ev.clientY-rc.top,p:(typeof ev.pressure==='number'&&ev.pressure>0)?ev.pressure:0.5}; if(laserActive()){laserDot(p.x,p.y);drawing=false;return;} drawing=true;cur={color:(erasing?BOARD:currentColor),width:4*widthMul,mode:erasing?'erase':'draw',points:[p]};strokes.push(cur);ctx.fillStyle=cur.color;var r=(cur.width*(0.6+p.p*0.8))/2;ctx.beginPath();ctx.arc(p.x,p.y,r,0,Math.PI*2);ctx.fill();}"+
        "if(btnFULL||btnEXIT){function toggleFull(force){var on=(force!==undefined)?!!force:!wrap.classList.contains('qg_fs');wrap.classList.toggle('qg_fs',on);(on?document.documentElement.classList.add:document.documentElement.classList.remove)('qg_noscroll');(on?document.body.classList.add:document.body.classList.remove)('qg_noscroll'); if(btnEXIT) btnEXIT.style.display=on?'inline-block':'none'; setTimeout(setSize,0);} if(btnFULL) btnFULL.addEventListener('click',function(){toggleFull();}); if(btnEXIT) {btnEXIT.addEventListener('click',function(){toggleFull(false);}); btnEXIT.style.display='none';}}"+
        "canvas.addEventListener('pointerdown',beginDraw,{passive:false});canvas.addEventListener('pointermove',feedMove,{passive:false});canvas.addEventListener('pointerrawupdate',feedMove,{passive:false});canvas.addEventListener('pointerup',endDraw,{passive:false});canvas.addEventListener('pointercancel',endDraw,{passive:false});"+
        "if(btnPNG) btnPNG.addEventListener('click',function(){try{var a=document.createElement('a');a.href=canvas.toDataURL('image/png');var ts=new Date().toISOString().replace(/[:.]/g,'-');a.download='quadro-giz-'+ts+'.png';document.body.appendChild(a);a.click();a.remove();}catch(e){alert('Falha ao salvar PNG: '+e.message);}});"+
        "if(btnUndo) btnUndo.addEventListener('click',function(){if(strokes.length){strokes.pop();redraw();}});"+
        "if(btnClean) btnClean.addEventListener('click',function(){strokes.length=0;redraw();});"+
        "window.addEventListener('keydown',function(e){if(e.key==='z'||e.key==='Z'){e.preventDefault();if(strokes.length){strokes.pop();redraw();}} if(e.key==='x'||e.key==='X'){e.preventDefault();strokes.length=0;redraw();} if(e.key==='f'||e.key==='F'){var t=(btnFULL||btnEXIT); if(t&&typeof toggleFull==='function') toggleFull();}});"+
        "setSize();"+
      "})();";

      var html = "<!DOCTYPE html><html lang='pt-br'><head><meta charset='utf-8'><meta name='viewport' content='width=device-width, initial-scale=1'>"+
                 "<title>Quadro de Giz</title>"+css+"</head><body>"+htmlUI+
                 "<script>window.__INITIAL_STROKES__="+JSON.stringify(strokes)+"<\/script>"+
                 "<script>"+RUNTIME+"<\/script></body></html>";

      var blob=new Blob([html], {type:'text/html'});
      var a=document.createElement('a'); a.href=URL.createObjectURL(blob);
      var ts=new Date().toISOString().replace(/[:.]/g,'-'); a.download="quadro-giz-"+ts+".html";
      document.body.appendChild(a); a.click(); a.remove();
      setTimeout(function(){URL.revokeObjectURL(a.href);},1500);
    }catch(err){ alert('Falha ao salvar HTML: '+err.message); }
  }

  btnPNG.addEventListener('click', savePNG);
  btnUndo.addEventListener('click', function(){ if(strokes.length){ strokes.pop(); redraw(); } });
  btnClean.addEventListener('click', function(){ strokes.length=0; redraw(); } );
  btnHTML.addEventListener('click', function(){ saveAsHTML(); } );

  setTimeout(function(){
    try{
      var els=(host||document).querySelectorAll('button, a, [role=\"button\"]');
      for(var i=0;i<els.length;i++){
        var b=els[i];
        if (wrap && wrap.contains(b)) continue;
        var t=(b.textContent||'').trim().toLowerCase();
        if (t==='html' || t==='salvar html' || t==='save html'){ b.addEventListener('click', function(){ try{ saveAsHTML(); }catch(_e){} }); }
      }
      document.addEventListener('jsplotly:save-html', function(){ saveAsHTML(); });
      document.addEventListener('jsplotly-html', function(){ saveAsHTML(); });
    }catch(_){}
  },0);
})();

  `;
  
  // coloca o cÃ³digo no Ace e plota ao abrir
editor.setValue(codigoPadrao, -1);
resetarGrafico();  // opcional, sÃ³ pra garantir estado inicial
adicionarCurva();  // executa e desenha


</script>


<script>
function salvarProjetoCompleto() {
  const gd = document.getElementById("grafico");
  const curvasStr = JSON.stringify(gd.data);
  const layoutStr = JSON.stringify(gd.layout || {});
  const codigoStr = JSON.stringify(editor.getValue());
  const temaEscuro = document.body.classList.contains("dark-mode");

  let htmlContent = ''
    + '<!DOCTYPE html>\n'
    + '<html lang="pt">\n'
    + '<head>\n'
    + '  <meta charset="UTF-8">\n'
    + '  <title>JSPlotly Projeto Salvo</title>\n'
    + '  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"><\/script>\n'
    + '  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"><\/script>\n'
    + '  <style>\n'
    + '    body { font-family: Arial, sans-serif; margin: 20px; }\n'
    + '    .container { display: flex; justify-content: space-between; align-items: flex-start; }\n'
    + '    #grafico { width: 55%; height: 500px; }\n'
    + '    #editor-container { width: 40%; }\n'
    + '    #editor { width: 100%; height: 350px; border: 1px solid #ccc; }\n'
    + '  </style>\n'
    + '</head>\n'
    + '<body>\n'
    + '  <h2>JSPlotly - Projeto Salvo</h2>\n'
    + '  <div class="container">\n'
    + '    <div id="grafico"></div>\n'
    + '    <div id="editor-container">\n'
    + '      <div id="editor"></div>\n'
    + '    </div>\n'
    + '  </div>\n'
    + '  <script>\n'
    + '    const curvas = ' + curvasStr + ';\n'
    + '    const layout = ' + layoutStr + ';\n'
    + '    const codigo = ' + codigoStr + ';\n'
    + '    const temaEscuro = ' + JSON.stringify(temaEscuro) + ';\n'
    + '    const editor = ace.edit("editor");\n'
    + '    editor.setTheme(temaEscuro ? "ace/theme/monokai" : "ace/theme/github");\n'
    + '    editor.session.setMode("ace/mode/javascript");\n'
    + '    editor.setValue(codigo, -1);\n'
    + '    layout.editable = true;\n'
    + '    Plotly.newPlot("grafico", curvas, layout);\n'
    + '    document.body.classList.toggle("dark-mode", temaEscuro);\n'
    + '    document.getElementById("grafico").on("plotly_click", function(data) {\n'
    + '      const y = data.points[0].y;\n'
    + '      const ctx = new (window.AudioContext || window.webkitAudioContext)();\n'
    + '      const osc = ctx.createOscillator();\n'
    + '      const gain = ctx.createGain();\n'
    + '      osc.type = "sine";\n'
    + '      osc.frequency.setValueAtTime(y, ctx.currentTime);\n'
    + '      osc.connect(gain);\n'
    + '      gain.connect(ctx.destination);\n'
    + '      osc.start();\n'
    + '      osc.stop(ctx.currentTime + 0.4);\n'
    + '    });\n'
    + '  <\/script>\n'
    + '</body>\n'
    + '</html>';

  const blob = new Blob([htmlContent], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "jsplotly_projeto.html";
  a.click();
}
</script>

<script>
function salvarProjetoSomenteGrafico() {
  const gd = document.getElementById("grafico");
  const curvasStr = JSON.stringify(gd.data);
  const layoutStr = JSON.stringify(gd.layout || {});
  const framesData = gd._transitionData && gd._transitionData._frames;
  const framesStr = JSON.stringify(framesData || []);
  const temaEscuro = document.body.classList.contains("dark-mode");

  let htmlContent = ''
    + '<!DOCTYPE html>\n'
    + '<html lang="pt">\n'
    + '<head>\n'
    + '  <meta charset="UTF-8">\n'
    + '  <title>JSPlotly GrÃ¡fico Exportado</title>\n'
    + '  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"><\/script>\n'
    + '  <style>\n'
    + '    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: ' + (temaEscuro ? '#1e1e1e' : '#ffffff') + '; color: ' + (temaEscuro ? '#e0e0e0' : '#000000') + '; }\n'
    + '    #grafico { width: 100vw; height: 100vh; }\n'
    + '  </style>\n'
    + '</head>\n'
    + '<body>\n'
    + '  <div id="grafico"></div>\n'
    + '  <script>\n'
    + '    const data = ' + curvasStr + ';\n'
    + '    const layout = ' + layoutStr + ';\n'
    + '    const frames = ' + framesStr + ';\n'
    + '    layout.editable = false;\n'
    + '    Plotly.newPlot("grafico", data, layout).then(function() {\n'
    + '      if (frames && frames.length > 0) {\n'
    + '        Plotly.addFrames("grafico", frames);\n'
    + '        Plotly.animate("grafico", null, { frame: { duration: 500, redraw: true }, transition: { duration: 300 } });\n'
    + '      }\n'
    + '    });\n'
    + '    document.getElementById("grafico").on("plotly_click", function(data) {\n'
    + '      const y = data.points[0].y;\n'
    + '      const ctx = new (window.AudioContext || window.webkitAudioContext)();\n'
    + '      const osc = ctx.createOscillator();\n'
    + '      const gain = ctx.createGain();\n'
    + '      osc.type = "sine";\n'
    + '      osc.frequency.setValueAtTime(y, ctx.currentTime);\n'
    + '      osc.connect(gain);\n'
    + '      gain.connect(ctx.destination);\n'
    + '      osc.start();\n'
    + '      osc.stop(ctx.currentTime + 0.4);\n'
    + '    });\n'
    + '  <\/script>\n'
    + '</body>\n'
    + '</html>';

  const blob = new Blob([htmlContent], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "play.html";
  a.click();
}
</script>




<script>
function salvarCloneJSPlotly() {
  // Captura o cÃ³digo do usuÃ¡rio e escapa com seguranÃ§a
  const codigoNovo = editor.getValue()
    .replace(/\\/g, '\\\\')
    .replace(/`/g, '\\`')
    .replace(/\$/g, '\\$');

  // Substitui diretamente o valor da variÃ¡vel codigoPadrao na string
  const novaDefinicao = 'var codigoPadrao = `' + codigoNovo + '`;';
  
  // Extrai o HTML original em partes
  const htmlOriginal = document.documentElement.outerHTML;

  const htmlAtualizado = htmlOriginal.replace(
    /var codigoPadrao = `([\s\S]*?)`;/,
    novaDefinicao
  );

  const blob = new Blob([htmlAtualizado], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "JSPlotly.html";
  a.click();
}

function abrirNoChartStudio() {
  const gd = document.getElementById('grafico');
  if (!gd || !gd.data || gd.data.length === 0) {
    alert("NÃ£o hÃ¡ grÃ¡fico para enviar. Clique em 'add' primeiro.");
    return;
  }

  const dataStr   = JSON.stringify(gd.data || []);
  const layoutStr = JSON.stringify(gd.layout || {});

  // Tenta GET quando o payload Ã© pequeno (URLs muito grandes podem falhar)
  const urlBase = "https://chart-studio.plotly.com/create/";
  const urlGET  = urlBase
    + "?plotlyData="   + encodeURIComponent(dataStr)
    + "&plotlyLayout=" + encodeURIComponent(layoutStr);

  if ((dataStr.length + layoutStr.length) < 1500) {
    window.open(urlGET, "_blank");
    return;
  }

  // Fallback: POST via form oculto (evita limite de URL)
  const form = document.createElement("form");
  form.method = "POST";
  form.action = urlBase;     // Editor do Chart Studio
  form.target = "_blank";

  const inpData = document.createElement("input");
  inpData.type = "hidden";
  inpData.name = "plotlyData";
  inpData.value = dataStr;

  const inpLayout = document.createElement("input");
  inpLayout.type = "hidden";
  inpLayout.name = "plotlyLayout";
  inpLayout.value = layoutStr;

  form.appendChild(inpData);
  form.appendChild(inpLayout);
  document.body.appendChild(form);
  form.submit();
  document.body.removeChild(form);
}


</script>



</body>
</html>


