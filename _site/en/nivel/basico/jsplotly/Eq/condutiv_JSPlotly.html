<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Condutividade em Tempo Real (TDS)</title>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 20px; background: #f4f4f4; }
    #grafico { width: 100%; height: 500px; }
    button {
      margin-top: 10px;
      padding: 10px 16px;
      background-color: #1976D2;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>Condutividade (TDS) em Tempo Real</h2>
  <div id="grafico"></div>
  <button onclick="conectarArduino()">Conectar Arduino</button>

  <script>
    const dados = [];
    let tempo = 0;

    Plotly.newPlot("grafico", [{
      x: [],
      y: [],
      mode: "lines",
      line: { color: "purple" },
      name: "TDS (ppm)"
    }], {
      title: "Leitura de Condutividade (TDS)",
      xaxis: { title: "Tempo (s)" },
      yaxis: { title: "TDS (ppm)", range: [0, 2000] }
    });

    async function conectarArduino() {
      try {
        const porta = await navigator.serial.requestPort();
        await porta.open({ baudRate: 115200 });

        const decoder = new TextDecoderStream();
        const readableStreamClosed = porta.readable.pipeTo(decoder.writable);
        const reader = decoder.readable.getReader();

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          if (value) {
            const match = value.match(/TDS Value:(\d+)/);
            if (match) {
              const tds = parseInt(match[1]);
              tempo += 1;
              dados.push({ x: tempo, y: tds });
              if (dados.length > 100) dados.shift();
              Plotly.update("grafico", {
                x: [dados.map(p => p.x)],
                y: [dados.map(p => p.y)]
              });
            }
          }
        }
      } catch (erro) {
        console.error("Erro ao conectar:", erro);
        alert("Erro ao conectar: " + erro);
      }
    }
  </script>
</body>
</html>
