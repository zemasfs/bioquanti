---
title: "nlFitNR - Ajuste não-linear por Newton-Raphson e modelo de Michaelis-Menten"
format: html
toc: true
toc-depth: 3
number-sections: true
lang: pt
---

|   O programa permite uma regressão não linear por método de mínimos quadrados por equação introduzida pelo usuário. Envolve um processo iterativo a partir de uma *série de Taylor* truncada na primeira derivada, e solução de vetor de parâmetros deslocado pra reduzir a soma dos quadrados dos resíduos. 

|   A lógico do *algoritmo de Newton-Raphson* engloba as etapas de 1) cálculo da derivada simbólica da equação para cada parâmetro, 2) sua determinação numérica a partir de sementes introduzidas, 3) construção da *matriz Jacobiana* de derivadas totais decorrente, cálculo da solução $\Delta$a entre parâmetro calculado e semente, bem como de erros.

|   Este programa assemelha-se ao programa [nlFIT](https://www.hpcalc.org/search.php?query=nlFIT) depositado no portal [hpcalc.org](https://www.hpcalc.org), mas difere desse 1) por utilizar algoritmo distinto e 2) com tamanho 30% menor, 3) permitir uma iteração por vez (frente à lentidão de cálculos da calculadora física para o ajuste por RPL), 4) não incluir critério de terminação, 5) saída de parâmetros e erros associados em cada iteração, e 6) programa separado para plotagem após iterações suficientes decididas pelo usuário. Em síntese, algoritmo e código distinto, e com maior controle de execução. Foi desenvolvido tendo por base o algoritmo NLWIK adaptado de Wickes (1991).

## Equação


$$
\phi(x,a)-\phi(x,a_0) = \frac{\delta \phi_{x,a_0}}{\delta aj}*\Delta a
$$
*Onde:*

*$\phi(x,a)$ = equação do ajuste;

*aj* = parâmetros do ajuste; 

*$\phi(x,a$_0$)$* = solução da equação com sementes dos parâmetros ou da iteração *i*


\

|   Perceba que a equação acima possui o formato:

$$
y = X * a
$$
\

|   Isso permite que o algoritmo resolva uma equação não linear nos parâmetros por um procedimento de mínimos quadrados linear na variação da função sobre os parâmetros. Nesse caso, *X* representa a matriz Jacobiana, tal que:

$$
X= \frac{\delta \phi}{\delta aj_{(xi,a_0)}} 
$$
\


##  Arquivos e exemplo de uso

1. [Programas nlFitNR e PLT, e exemplo](nlFitNR.zip)
2. [Código](nlFitNR.pdf)
\

|   O programa roda de forma independente, com gráfico final de pontos e linha de ajuste em programa separado (*PLT*). Para seu uso, o programa requer a entrada dos seguintes dados na sequência da pilha:
\

```{r, eval=FALSE}

# Entrada de dados

1. lista de valores de xi: {x1 x2...xn};
2. lista de valores de yi: {y1 y2 y3, ...yn};
3. lista de pesos: {w1, w2, w3, ...wn}. Obs: não havendo pesos, introduz-se uma
     lista unitária - {1 1 1...};
4. função para ajuste (ex: Vm*x/(Km+x); equação para cinética enzimática de 
     Michelis-Mentem). Obs: variável independente como "x";
5. lista de parâmetros: {p1 p2}. Obs: no exemplo, p1 = Vm e p2 = Km.
6. lista de sementes dos parâmetros.

```
\

|   Os dados do exemplo referem-se ao dataset *L.minor* de captação de nitrogênio por macrófitas, tal como apresentado no pacote `nlstools` do programa de computação estatística [R](https://cran.r-project.org/).


\
```{r, eval = FALSE}
# Uso do programa

1. Clique em EVAL no arquivo de exemplo para liberar as listas necessárias de input;
2. Clique em "nlFitNR" para executar o programa;
3. O programa fornece os dados de:
  a. parâmetros da regressão na pilha;
  b. "sd-RSE" - variância do ajuste;
  c. "+/- se" - erro padrão dos parâmetros;
  d. "Chi2" - valor de Chi-quadrado do ajuste;

4. Se estiver satisfeito com os resultados, basta interromper o programa (KILL) e observar o gráfico resultante. Se não estiver satisfeito, rode mais uma iteração clicando em "CONT".

OBS: Para dados de usuário, basta substituir as listas.
```


## Resultados

::: {#fig-nlFitNR layout-ncol=3}

![Entrada de dados. O exemplo que acompanha requer EVAL para abrir a lista.](dados.jpeg){#fig-result}

![Resultados obtidos na 1a. iteração do programa.](result.jpeg){#fig-result}

![Gráfico de pontos e linha de ajuste sobreposta após a 1a. iteração do algoritmo de Newton-Raphson.](plot.jpeg){#fig-plot}

Programa *nlFitNR* pela versão Android de HP50G ([Go49gp](https://sites.google.com/site/olivier2smet2/home/go49gp)), exibindo entrada de dados, resultados estatísticos do ajuste não linear, e gráfico de pontos e sobreposição de linha de regressão. 

:::


|   Os resultados da regressão aproximam-se dos obtidos pelo software estatístico `R`, conforme tabela abaixo, já na 1a. iteração do algoritmo, e com valor de erro ($\chi$$^{2}$) reduzido à metade. Iterações subsquentes reduzem o erro associado aos parâmetros mas elevam o do ajuste global. Valores coincidentes aos obtidos pelo programa `R` foram atingidas na 3a. iteração.  


| Parâmetro | nlFIT               | R                  |
|-----------|---------------------|--------------------|
| Km        | 12.01 ± 0.71      | 17.079 ± 2.953     |
| Vm        | 117.51 ± 3.17     | 126.033 ± 7.173    |
| Iterações | 1                   | 7                  |
| $\chi$$^{2}$       | 124.29             | 234.375            |


## Referências {.unnumbered}

1. Wickes, W.C. Hp 48 Insights: 1. Principles and Programming of the Hp 48 (Hp 48G/Gx Edition), Larken Pub., 1991.

