<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSPlotly</title>
  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.20.0/plotly.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script> 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.1/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-statistics@7.8.3/dist/simple-statistics.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ml-regression@6.0.0/dist/ml-regression.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>    
    <script src="https://cdn.jsdelivr.net/npm/ml-levenberg-marquardt@3.3.0/dist/ml-levenberg-marquardt.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.9.5/jstat.min.js"></script>

 <!---<body style="margin:0; padding:0;">--->


    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { display: flex; justify-content: space-between; align-items: flex-start; }
        #grafico { width: 55%; height: 500px; }
        #editor-container { width: 40%; }
        #editor { width: 100%; height: 350px; border: 1px solid #ccc; }

.header-bar {
    width: 100%;
    height: 30px; 
    background: linear-gradient(to right, #F5F5DC, #EDEAE0); 
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 20px;
    font-weight: bold;
    color: #5a4a42; /
    letter-spacing: 2px;
    box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.1); 
    margin-bottom: 40px;  
}



.license-info {
  font-size: 12px;
  color: gray;
  font-family: Arial, sans-serif;
  opacity: 0.8;
  text-align: center;
  margin: 30px auto 10px auto;
}


#toggleTheme {
  position: relative;
  background: none;
  border: none;
  font-size: 22px;
  cursor: pointer;
  margin: -2px 0 0 10px; /* margem superior e esquerda */
  display: inline-block;
  z-index: 10;
}



.dev-info {
    position: absolute;
    top: 3px; 
    left: 10px; 
    font-size: 13px !important; 
    color: #999; 
    font-family: Arial, sans-serif;
}

.dev-info a {
    text-decoration: none;
    color: #888; 
    font-weight: bold;
}
.dev-info a:hover {
    text-decoration: underline;
    color: #666; /
}

       
.button-container { 
    display: flex; 
    gap: 10px; 
    margin-top: 10px; 

  position: relative;
  z-index: 10;
}

button { 
    padding: 10px; 
    cursor: pointer; 
    border: none; 
    font-size: 14px; 
    border-radius: 5px; 
    transition: background 0.3s ease-in-out; 
}


/* Bot√£o base */
button {
  padding: 10px;
  cursor: pointer;
  font-size: 14px;
  border-radius: 8px;
  border: 2px solid transparent;
  transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
}

.add-btn {
  background: #e2f6e9;
  color: #207a44;
  border-color: #b1e2c3;
}
.add-btn:hover {
  background: #ccf0dd;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(50, 150, 100, 0.3);
}

.remove-btn {
  background: #fff8c6;
  color: #887200;
  border-color: #f0dc7d;
}
.remove-btn:hover {
  background: #fdf2a8;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(200, 180, 20, 0.3);
}

.reset-btn {
  background: #fce1e1;
  color: #b42c2c;
  border-color: #f4b6b6;
}
.reset-btn:hover {
  background: #f8caca;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(200, 50, 50, 0.3);
}

.save-btn {
  background: #fff1db;
  color: #8a4b00;
  border-color: #ffd9a2;
}
.save-btn:hover {
  background: #ffe1ba;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(200, 120, 30, 0.3);
}

.clear-btn {
  background: #f99;
  color: white;
  border-color: #d33;
}
.clear-btn:hover {
  background: #e55;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(255, 80, 80, 0.5);
}

.save-html-btn {
  background: #e6f1fb;
  color: #125a8f;
  border-color: #a8d0f0;
}
.save-html-btn:hover {
  background: #d2e9fc;
  transform: scale(1.05);
  box-shadow: 0 0 6px rgba(50, 100, 200, 0.3);
}


.author-info { position: absolute; top: 60px; right: 20px; font-size: 14px; color: gray; }
.logo { position: fixed; bottom: 10px; right: 20px; width: 100px; z-index: 10;} 
.ascii-logo {
 position: fixed;
 bottom: 10px;
 right: 20px;
 font-family: monospace;
 font-size: 2px;
 white-space: pre;
 text-align: right;
 z-index: 10; 
 }
 
.save-project-btn {
  background: linear-gradient(to bottom, #f3e6ff, #d3bdf0);
  color: #5e2d91;
  font-weight: normal;
  border: 2px solid #b48ce3;
  border-radius: 8px;
  box-shadow: 0 0 6px rgba(140, 90, 200, 0.4);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.save-project-btn:hover {
  background: linear-gradient(to bottom, #e7d4ff, #c9aee8);
  transform: scale(1.05);
  box-shadow: 0 0 8px rgba(120, 60, 180, 0.5);
}


</style>


<style>
  @media (max-width: 768px) {
    .container {
      flex-direction: column;
      align-items: stretch;
    }

    #grafico {
      width: 100% !important;
      height: 300px !important;
    }

    #editor-container {
      width: 100% !important;
    }

    #editor {
      height: 300px !important;
    }

    .button-container {
      flex-direction: column;
      gap: 8px;
    
  position: relative;
  z-index: 10;
}

    button {
      width: 100%;
      font-size: 16px;
    }

    .header-bar {
      font-size: 16px;
    }

    .popup {
      width: 90%;
    }

    .external-link {
      position: relative;
      top: auto;
      right: auto;
      margin-top: 10px;
      text-align: right;
    }
  }
</style>


<style>
  body.dark-mode {
    background-color: #1e1e1e;
    color: #e0e0e0;
  }

  body.dark-mode .header-bar {
    background: linear-gradient(to right, #2e2e2e, #1a1a1a);
    color: #f0f0f0;
  }

  body.dark-mode .button-container button {
    background: #333 !important;
    color: #ddd !important;
  }

  body.dark-mode .clear-btn {
    background-color: #a71d2a !important;
    color: white !important;
  }

  body.dark-mode #editor {
    background-color: #1e1e1e;
    color: #e0e0e0;
  }

  body.dark-mode .popup {
    background-color: #2b2b2b;
    color: #eee;
  }
  
</style>


</head>


<body>
<div class="header-bar" style="display: flex; align-items: center; justify-content: space-between; padding: 4px 10px;">
  <button id="toggleTheme" onclick="alternarTema()" style="font-size: 18px; background: none; border: none; cursor: pointer;">
    üåô
  </button>

  <div style="flex: 1; text-align: center; font-weight: bold; font-size: 16px;">
    JSPlotly - Interactive Graphics
  </div>

  <div style="width: 30px;"><!-- espa√ßo vazio para equilibrar com o bot√£o da esquerda --></div>
</div>



<div class="external-link">
  <a href="https://bioquanti.netlify.app/" target="_blank">üîó Bioquanti</a>  
</div>



<div class="dev-info">
    Developed with 
    <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript" target="_blank">JavaScript</a> 
    and 
    <a href="https://plotly.com/javascript/" target="_blank">Plotly.js</a>
</div>

<div class="container">

 <div id="grafico"></div>

<div id="popup" class="popup">
    <p>Save as:</p>
    <button onclick="salvarImagem('png')">PNG</button>
    <button onclick="salvarImagem('svg')">SVG</button>
    <button onclick="fecharPopup()">Cancelar</button>
</div>

<style>
.popup {
    display: none;
    position: fixed;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: white;
    border: 1px solid #ccc;
    padding: 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
    z-index: 1000;
}
.popup button {
    margin: 5px;
    padding: 8px;
}

.external-link {  
  position: absolute;
  top: 30px;
  right: 20px;
  font-size: 14px;
  font-family: Arial, sans-serif;
}

.external-link a {
  color: #333;
  text-decoration: none;
  font-weight: bold;
}

.external-link a:hover {
  text-decoration: underline;
  color: #0077cc;
}

.save-html-btn {
  background: linear-gradient(to bottom, #dff0f7, #add9e6);
  color: #004b66;
  font-weight: normal;
  border: 2px solid #66b8d4;
  border-radius: 8px;
  box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}
.save-html-btn:hover {
  background: linear-gradient(to bottom, #c4ecff, #8fd3ec);
  transform: scale(1.05);
  box-shadow: 0 0 8px rgba(0, 123, 255, 0.8);
}


</style>

  <div id="editor-container">
  

<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
  <input type="file" id="fileInput" accept=".js" onchange="carregarEquacaoAuto(event)">
  
  <span style="font-size: 13px; font-family: Arial, sans-serifbioq; color: #2e7d57; text-align: right;">
    For easy code construction, try 
    <a href="https://chatgpt.com/g/g-6819fbb8d2d08191bf7d50a3dbeadb0d-gsplotly" 
       target="_blank" 
       style="color: #2e7d57 !important; font-weight: bold; text-decoration: underline;">
      GSPlotly
    </a>
  </span>
</div>





       <div id="editor"></div>
       <div class="button-container">
       <button class="add-btn" onclick="adicionarCurva()">add</button>
       <button class="remove-btn" onclick="removerUltimaCurva()">remove</button>
       <button class="clear-btn" onclick="resetarGrafico()">clean</button> 
       <button class="reset-btn" onclick="limparEditor()">delete</button>
     <!---  <button class="save-html-btn" onclick="salvarHTML()">html</button> --->             
       <button class="save-btn" onclick="salvarEquacao()">script</button> 
       <button class="save-html-btn" onclick="salvarProjetoSomenteGrafico()">html</button>
    <!---<button class="save-html-btn" onclick="salvarProjetoCompleto()">save project</button> --->
       <button class="save-project-btn" onclick="salvarCloneJSPlotly()">clone</button>
       
    
  </div>
</div>
    </div>
    
    
<script>
 var curvas = [];
 var cores = ["red", "blue", "green", "purple", "orange", "brown", "pink", "gray"];
 var corIndex = 0;
 var editor = ace.edit("editor");
 editor.setTheme("ace/theme/github");
 editor.session.setMode("ace/mode/javascript");
 editor.session.setUseWrapMode(true);
 editor.setOptions({
  fontSize: "14px",
  wrap: true,
  showPrintMargin: false
});



var customSaveButton = {
    name: 'PNG or SVG',
    icon: Plotly.Icons.disk,
    click: function(gd) {
        abrirPopup();
    }
};


var config = {
  modeBarButtonsToAdd: [
    'toggleSpikelines',
    'hoverCompareCartesian',
    'drawline',
    'drawopenpath',
    'drawrect',
    'drawcircle',
    //'eraseshape',
    customSaveButton,
    {
      name: 'change color',
      icon: Plotly.Icons.camera,
      click: function(gd) {
        const ultima = curvas.length - 1;
        const novaCor = cores[Math.floor(Math.random() * cores.length)];
        Plotly.restyle(gd, { 'line.color': novaCor }, [ultima]);
        curvas[ultima].line.color = novaCor;
      }
    },
  {
  name: 'Adicionar Texto',
  icon: {
    width: 1000,
    height: 1000,
    path: 'M200 800V160h600v80H540v560h-80V240H200z' // √çcone simples em forma de "T"
  },
  click: function(gd) {
    // O clique no bot√£o ativa o modo de anota√ß√£o
    const handler = function(eventData) {
      const x = eventData.points[0].x;
      const y = eventData.points[0].y;
      const texto = prompt("Digite o texto a ser inserido:");
      if (texto) {
        Plotly.relayout(gd, {
          annotations: (gd.layout.annotations || []).concat([{
            x: x,
            y: y,
            text: texto,
            showarrow: true,
            arrowhead: 2
          }])
        });
      }
      gd.removeListener('plotly_click', handler);
    };
    gd.on('plotly_click', handler);
  }
}
  ],
  showEditInChartStudio: true,
  plotlyServerURL: "https://chart-studio.plotly.com",
  displaylogo: false,
  displayModeBar: true,
  responsive: true,
  scrollZoom: true,
  editable: true,
  modeBarButtonsToRemove: [
    'select2d',
    'lasso2d',
    'resetScale2d',
    'zoomOut2d',
    'zoomIn2d',
    'toImage'
  ]
};
 

function executarCodigo() {
    try {
        var codigoUsuario = editor.getValue().trim();
        Plotly.purge('grafico'); 
        eval(codigoUsuario);
    } 

catch (error) {
           
    }
}

function limparGrafico() {
    Plotly.purge('grafico');
}

function carregarEquacaoAuto(event) {
 const file = event.target.files[0];
 if (file) {
   const reader = new FileReader();
         reader.onload = function(e) {
         editor.setValue(e.target.result, -1);
                 };
         reader.readAsText(file);
                 }
           }

function adicionarCurva() {
  const codigoUsuario = editor.getValue();

  let consoleSaida = [];
  const logOriginal = console.log;
  console.log = (...args) => {
    consoleSaida.push(args.map(arg => typeof arg === "object" ? JSON.stringify(arg) : String(arg)).join(" "));
  };

  let resultado;
  try {
    const func = new Function(codigoUsuario + "\nreturn typeof output !== 'undefined' ? output : undefined;");
    resultado = func();
  } catch (e1) {
    try {
      const func = new Function(codigoUsuario);
      resultado = func();
    } catch (e2) {
      console.log = logOriginal;
      alert("Erro ao executar o c√≥digo:\n" + e2.message);
      return;
    }
  }

  console.log = logOriginal;
  if (!resultado) return;

  const texto = consoleSaida.map(l => "> " + l).join("<br>");
  const layout = resultado.layout || {};
  layout.annotations = layout.annotations || [];

  if (texto.trim()) {
    layout.annotations.push({
      text: `<div style="font-family: monospace; font-size: 14px; max-height: 200px; overflow-y: auto; background:#f9f9f9; padding:5px; border:1px solid #ccc;">${texto}</div>`,
      showarrow: false,
      xref: 'paper',
      yref: 'paper',
      x: 0,
      y: 1,
      align: 'left',
      xanchor: 'left',
      yanchor: 'top'
    });
  }




  let data = [];
  if (resultado.data) {
    data = resultado.data;
  } else if (resultado.trace) {
    data = [resultado.trace];
  } else if (resultado.traces) {
    data = resultado.traces;
  } else if (resultado.x_values && resultado.y_values) {
    data = [{
      x: resultado.x_values,
      y: resultado.y_values,
      type: 'scatter',
      mode: 'lines+markers',
      name: resultado.title || "Curva"
    }];
    if (resultado.x_range) layout.xaxis = { range: resultado.x_range, title: resultado.x_label || "" };
    if (resultado.y_range) layout.yaxis = { range: resultado.y_range, title: resultado.y_label || "" };
    layout.title = resultado.title || "";
  }

  curvas.push(...data);

  Plotly.newPlot("grafico", curvas, layout, config).then(() => {
    if (resultado.frames && resultado.frames.length > 0) {
      Plotly.addFrames("grafico", resultado.frames);
      Plotly.animate("grafico", null, {
        frame: { duration: 80, redraw: true },
        transition: { duration: 0 }
      });
    }
  });
}




function resetarGrafico() {
            curvas = [];
            corIndex = 0;
            Plotly.newPlot('grafico', [], {xaxis: { title: 'X' }, yaxis: {
          zeroline: true,
          zeroline: true, title: 'Y' } });
        }

function salvarEquacao() {
    var blob = new Blob([editor.getValue()], { type: "text/javascript" });
    var a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "script.js";
        document.body.appendChild(a);
        a.click();
            document.body.removeChild(a);
       }

        

function salvarHTML() {
    var plotlyData = JSON.parse(JSON.stringify(curvas));
    var plotlyLayout = document.getElementById('grafico').layout;
    var htmlContent = '<!DOCTYPE html>\n' +
                '<html>\n' +
                '<head>\n' +
                '    <meta charset="UTF-8">\n' +
                '    <title>Gr√°fico Salvo</title>\n' +
                '    <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.20.0/plotly.min.js"><\/script>\n' +
                '</head>\n' +////
                '<body>\n' +
                '    <div id="grafico" style="width: 100%; height: 600px;"></div>\n' +
                '    <script>\n' +
                '        var data = ' + JSON.stringify(plotlyData) + ';\n' +
                '        var layout = ' + JSON.stringify(plotlyLayout) + ';\n' +
                '        Plotly.newPlot("grafico", data, layout);\n' +
                '    <\/script>\n' +
                '</body>\n' +
                '</html>';

function salvarAppCompleto() {
  const htmlBase = document.documentElement.outerHTML;
  const blob = new Blob([htmlBase], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "jsplotly_completo.html";
  a.click();
}


var blob = new Blob([htmlContent], { type: 'text/html' });
var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
//    a.download = 'grafico_interativo.html';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
        }

function limparEditor() {
    editor.setValue("", -1); 
    }

function removerUltimaCurva() {
    if (curvas.length > 0) {
    curvas.pop(); 
    atualizarGrafico(); 
        } else {
        alert("No curves to remove!");
      }
    }


function atualizarGrafico() {
    Plotly.newPlot('grafico', curvas, {
        title: 'Gr√°fico Interativo',
        xaxis: { title: 'X' },
        yaxis: {
          zeroline: true,
          zeroline: true, title: 'Y' },
        showlegend: true
    });
}

function abrirPopup() {
    document.getElementById('popup').style.display = 'block';
}

function fecharPopup() {
    document.getElementById('popup').style.display = 'none';
}

function salvarImagem(formato) {
    Plotly.downloadImage('grafico', {format: formato, filename: 'plot'});
    fecharPopup();
}


function limparTudo() {
   editor.setValue("", -1);
     let graficoDiv = document.getElementById("grafico");
     if (graficoDiv) {
            Plotly.newPlot("grafico", [], {
            xaxis: { title: "Eixo X" },
            yaxis: {
          zeroline: true,
          zeroline: true, title: "Eixo Y" }
        });
        graficoDiv.data = [];
    }
}


// Definir a equa√ß√£o quadr√°tica padr√£o
var codigoPadrao = `
/* ===== Diagrama overlay v3.7.6 ===== */
(function(){
  var UI_TOP_PX = 28; // altura da barra

  // ---------- localizar host ----------
  var host = document.querySelector('.js-plotly-plot');
  if (!host) {
    var ids = ['saida','plot','plotArea','graficoArea','visorPlot','appArea','conteudo','root'];
    for (var i=0;i<ids.length && !host;i++){
      var el = document.getElementById(ids[i]);
      if (el && el.querySelector && el.querySelector('.js-plotly-plot')) host = el.querySelector('.js-plotly-plot');
      else if (!host && el) host = el;
    }
  }
  if (!host) host = document.body;
  if (getComputedStyle(host).position === 'static') host.style.position = 'relative';
  if (!host.id) host.id = 'plot_'+Math.random().toString(36).slice(2);

  // ---------- esconder eixos/grades Plotly ----------
  (function hideAxesForever(){
    var styleId = 'hideAxesForever_'+host.id;
    if (!document.getElementById(styleId)){
      var st = document.createElement('style');
      st.id = styleId;
      st.textContent =
        '#'+host.id+' .xtick, #'+host.id+' .ytick,'+
        '#'+host.id+' .gridlayer, #'+host.id+' .zerolinelayer,'+
        '#'+host.id+' .xaxislayer-above, #'+host.id+' .yaxislayer-above,'+
        '#'+host.id+' .xaxislayer-below, #'+host.id+' .yaxislayer-below,'+
        '#'+host.id+' .overaxes-above, #'+host.id+' .overaxes-below{display:none!important;}';
      document.head.appendChild(st);
    }
    try{ Plotly.relayout(host, {'xaxis.visible': false, 'yaxis.visible': false, 'showlegend': false, 'margin':{l:0,r:0,t:0,b:0}}); }catch(_){}
  })();

  // ---------- remover overlay antigo ----------
  var old = document.getElementById('diagramStageOverlay');
  if (old && old.parentNode) old.parentNode.removeChild(old);

  // ---------- overlay base ----------
  var stage = document.createElement('div');
  stage.id = 'diagramStageOverlay';
  stage.style.cssText = 'position:absolute;left:0;top:0;right:0;bottom:0;pointer-events:auto;z-index:1000;background:transparent;user-select:none';
  host.appendChild(stage);

  // grid
  var grid = document.createElement('div');
  grid.id = 'diagramGridOverlay';
  grid.style.cssText = 'position:absolute;inset:0;pointer-events:none;z-index:900;background:transparent';
  stage.appendChild(grid);
  function setGrid(on){
    grid.style.background = on
      ? 'repeating-linear-gradient(0deg, rgba(0,0,0,.06) 0 1px, transparent 1px 24px),repeating-linear-gradient(90deg, rgba(0,0,0,.06) 0 1px, transparent 1px 24px),repeating-linear-gradient(0deg, rgba(0,0,0,.10) 0 1px, transparent 1px 120px),repeating-linear-gradient(90deg, rgba(0,0,0,.10) 0 1px, transparent 1px 120px)'
      : 'transparent';
  }
  setGrid(false);

  // ---------- barra ----------
  var bar = document.createElement('div');
  bar.id = 'diagramUI';
  bar.style.cssText = [
    'position:fixed;left:12px;top:'+UI_TOP_PX+'px;z-index:2147483000',
    'display:flex;flex-wrap:wrap;align-items:center;gap:8px',
    'max-width:calc(100vw - 24px)'
  ].join(';');
  document.body.appendChild(bar);
  ['click','mousedown','mouseup','dblclick','contextmenu'].forEach(function(evt){
    bar.addEventListener(evt, function(e){ e.stopPropagation(); }, false);
  });

  function mkBtn(txt){ var b=document.createElement('button'); b.textContent=txt;
    b.style.cssText='padding:4px 8px;border:1px solid #bbb;border-radius:6px;background:#f6f6f6;cursor:pointer;font:13px system-ui, Arial'; return b; }

  var banner = document.createElement('div');
  banner.textContent = 'ESQ: criar n√≥ ‚Ä¢ DblClick: editar ‚Ä¢ DIREITO/SHIFT: ORIGEM ‚Üí DESTINO';
  banner.style.cssText = 'background:#e7ffe7;border:1px solid #9cd39c;border-radius:8px;padding:6px 10px;font:14px/1.3 system-ui, Arial';
  bar.appendChild(banner);

  // paleta
  var palette = ['#ef4444','#f59e0b','#22c55e','#3b82f6','#8b5cf6','#06b6d4','#111827'];
  var currentColor = '#3b82f6';
  var paletteWrap = document.createElement('div');
  paletteWrap.style.cssText = 'display:flex;gap:6px';
  bar.appendChild(paletteWrap);
  function mkSwatch(c){
    var d = document.createElement('div'); d.className='sw'; d.title=c;
    d.style.cssText = 'width:18px;height:18px;border-radius:4px;border:2px solid #fff;box-shadow:0 0 0 1px rgba(0,0,0,.25);cursor:pointer;background:'+c;
    d.addEventListener('click', function(){
      currentColor = c;
      var all = paletteWrap.querySelectorAll('.sw');
      for (var i=0;i<all.length;i++) all[i].style.outline='none';
      d.style.outline='3px solid '+c;
      banner.textContent = 'Cor ativa: '+c+'.';
    });
    return d;
  }
  for (var i=0;i<palette.length;i++) paletteWrap.appendChild(mkSwatch(palette[i]));
  setTimeout(function(){
    var sws = paletteWrap.querySelectorAll('.sw');
    for (var i=0;i<sws.length;i++){ if (sws[i].title===currentColor){ sws[i].style.outline='3px solid '+currentColor; break; } }
  },0);

  var br1 = document.createElement('div'); br1.style.cssText='flex-basis:100%;height:0'; bar.appendChild(br1);

  var btnExport = mkBtn('export');
  var btnImport = mkBtn('import');
  var btnHTML   = mkBtn('save html');
  var btnGrid   = mkBtn('grid on');
  var btnClear  = mkBtn('clear');
  var btnClose  = mkBtn('close');
  [btnExport,btnImport,btnHTML,btnGrid,btnClear,btnClose].forEach(function(b){bar.appendChild(b);});

  // formas
  var shapeWrap = document.createElement('div');
  shapeWrap.style.cssText = 'display:flex;gap:6px;margin-left:6px';
  bar.appendChild(shapeWrap);
  function mkShapeBtn(txt, shapeName){
    var b = mkBtn(txt);
    b.title = 'Aplicar forma: '+shapeName;
    b.addEventListener('click', function(e){
      e.stopPropagation();
      if (selSet.size===0){ banner.textContent='Selecione um n√≥ e tente de novo.'; return; }
      nodes.forEach(function(nd){ if (selSet.has(nd.id)) nd.shape = shapeName; });
      renderAll();
    });
    return b;
  }
  shapeWrap.appendChild(mkShapeBtn('T','none'));
  shapeWrap.appendChild(mkShapeBtn('‚óª','square'));
  shapeWrap.appendChild(mkShapeBtn('‚óá','diamond'));
  shapeWrap.appendChild(mkShapeBtn('oval','oval'));

  // curve mode
  var btnCurve = mkBtn('curve off');
  var curveMode = false;
  bar.appendChild(btnCurve);
  btnCurve.addEventListener('click', function(e){
    e.stopPropagation();
    curveMode = !curveMode;
    btnCurve.textContent = curveMode ? 'curve ON' : 'curve off';
    linkSourceId = null; waitingControl = false; tempCP = null;
    banner.textContent = curveMode
      ? 'CURVA: Direito/Shift em ORIGEM ‚Üí clique no palco (ponto da curva) ‚Üí Direito/Shift em DESTINO.'
      : 'Reta: Direito/Shift ORIGEM ‚Üí Direito/Shift DESTINO.';
    drawLinks();
  });

  // ---------- SVGs ----------
  var svgLinks = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svgLinks.setAttribute('width','100%'); svgLinks.setAttribute('height','100%');
  svgLinks.style.cssText = 'position:absolute;left:0;top:0;pointer-events:auto;z-index:950';
  stage.appendChild(svgLinks);
  var defsL = document.createElementNS('http://www.w3.org/2000/svg','defs');
  var marker = document.createElementNS('http://www.w3.org/2000/svg','marker');
  marker.setAttribute('id','diagramArrowhead');
  marker.setAttribute('markerWidth','10'); marker.setAttribute('markerHeight','7');
  marker.setAttribute('refX','10'); marker.setAttribute('refY','3.5'); marker.setAttribute('orient','auto');
  var tri = document.createElementNS('http://www.w3.org/2000/svg','polygon');
  tri.setAttribute('points','0 0, 10 3.5, 0 7'); tri.setAttribute('fill','#222');
  marker.appendChild(tri); defsL.appendChild(marker); svgLinks.appendChild(defsL);

  var svgShapes = document.createElementNS('http://www.w3.org/2000/svg','svg');
  svgShapes.setAttribute('width','100%'); svgShapes.setAttribute('height','100%');
  svgShapes.style.cssText = 'position:absolute;left:0;top:0;pointer-events:none;z-index:960';
  stage.appendChild(svgShapes);

  // ---------- estado ----------
  var nodes = [];     // {id, xPct, yPct, text, color, shape}
  var links = [];     // {fromId, toId, color, type:'line'|'quad', cxPct?, cyPct?}
  var nextId = 1, linkSourceId = null, activeInput = null;
  var draggingNode = null;      // {node, el}
  var draggingGroup = null;     // {startX,startY,rw,rh,list:[...],cps:[...]}  // (fix cp)
  var draggingLink = null;      // {A,B,link,startX,startY,a0,b0,cp0,rw,rh}   // (fix cp)
  var draggingCP   = null;      // {link}
  var waitingControl = false;
  var tempCP = null;
  var selSet = new Set();
  var rubber = null;
  var suppressNextClick = false;
  var gridOn = false;

  // ---------- helpers ----------
  function stageRect(){ return stage.getBoundingClientRect(); }
  function toPx(p){ var r=stageRect(); return {x:p.xPct*r.width, y:p.yPct*r.height}; }
  function clamp(v,min,max){ return v<min?min : v>max?max : v; }

  // ---------- liga√ß√µes ----------
  function linkOnNode(node){
    if (!curveMode){
      if (linkSourceId===null){
        linkSourceId = node.id;
        banner.textContent = 'Origem '+node.id+' escolhida. Agora destino (Direito ou Shift+Clique).';
      } else if (node.id===linkSourceId){
        linkSourceId = null; banner.textContent = 'Liga√ß√£o cancelada.';
      } else {
        links.push({fromId:linkSourceId, toId:node.id, color: currentColor, type:'line'});
        linkSourceId = null; banner.textContent = 'Seta criada.';
      }
      renderAll();
    } else {
      if (linkSourceId===null){
        linkSourceId = node.id; waitingControl = true; tempCP = null;
        banner.textContent = 'Origem '+node.id+' escolhida. Clique no PALCO (ponto da curva).';
        renderNodes();
      } else if (node.id===linkSourceId){
        linkSourceId = null; waitingControl=false; tempCP=null;
        banner.textContent = 'Liga√ß√£o cancelada.'; renderNodes();
      } else {
        if (!tempCP){ banner.textContent = 'Falta o ponto da curvatura: clique no palco.'; return; }
        links.push({fromId:linkSourceId, toId:node.id, color: currentColor, type:'quad', cxPct:tempCP.cxPct, cyPct:tempCP.cyPct});
        linkSourceId = null; waitingControl=false; tempCP=null;
        banner.textContent = 'Seta curva criada.'; renderAll();
      }
    }
  }

  // ---------- desenho de links ----------
  function drawLinks(){
    while (svgLinks.lastChild && svgLinks.lastChild!==defsL) svgLinks.removeChild(svgLinks.lastChild);

    for (var i=0;i<links.length;i++){
      (function(i){
        var L=links[i], A=nodes.find(function(n){return n.id===L.fromId;}), B=nodes.find(function(n){return n.id===L.toId;});
        if (!A||!B) return;
        var a=toPx(A), b=toPx(B);

        if (L.type==='quad'){
          var rct = stageRect();
          var cx = (L.cxPct!=null?L.cxPct:0.5)*rct.width;
          var cy = (L.cyPct!=null?L.cyPct:0.5)*rct.height;
          var path = document.createElementNS('http://www.w3.org/2000/svg','path');
          path.setAttribute('d', 'M '+a.x+' '+a.y+' Q '+cx+' '+cy+' '+b.x+' '+b.y);
          path.setAttribute('fill','none');
          path.setAttribute('stroke', L.color || '#222');
          path.setAttribute('stroke-width','2');
          path.setAttribute('marker-end','url(#diagramArrowhead)');
          path.style.cursor='grab';
          path.addEventListener('mousedown', function(ev){
            if (ev.button!==0) return; ev.stopPropagation();
            var r = stageRect();
            draggingLink = {
              A:A, B:B, link:L,
              startX:ev.clientX, startY:ev.clientY,
              a0:{xPct:A.xPct, yPct:A.yPct},
              b0:{xPct:B.xPct, yPct:B.yPct},
              cp0:{cxPct:(L.cxPct!=null?L.cxPct:0.5), cyPct:(L.cyPct!=null?L.cyPct:0.5)}, // (fix cp)
              rw:r.width, rh:r.height
            };
          });
          svgLinks.appendChild(path);

          if (curveMode){
            var h = document.createElementNS('http://www.w3.org/2000/svg','circle');
            h.setAttribute('cx', cx); h.setAttribute('cy', cy); h.setAttribute('r', 6);
            h.setAttribute('fill', '#fff'); h.setAttribute('stroke', L.color || '#222');
            h.setAttribute('stroke-width', '2'); h.style.cursor='grab';
            h.addEventListener('mousedown', function(ev){
              if (ev.button!==0) return; ev.stopPropagation();
              draggingCP = {link: L};
            });
            svgLinks.appendChild(h);
          }

        } else {
          var line=document.createElementNS('http://www.w3.org/2000/svg','line');
          line.setAttribute('x1',a.x); line.setAttribute('y1',a.y);
          line.setAttribute('x2',b.x); line.setAttribute('y2',b.y);
          line.setAttribute('stroke', L.color || '#222');
          line.setAttribute('stroke-width', '2');
          line.setAttribute('marker-end','url(#diagramArrowhead)');
          line.style.cursor = 'grab';
          line.addEventListener('mousedown', function(ev){
            if (ev.button!==0) return;
            ev.stopPropagation();
            var r = stageRect();
            draggingLink = {
              A:A, B:B, link:L,
              startX:ev.clientX, startY:ev.clientY,
              a0:{xPct:A.xPct, yPct:A.yPct},
              b0:{xPct:B.xPct, yPct:B.yPct},
              cp0:null, // reta
              rw:r.width, rh:r.height
            };
          });
          svgLinks.appendChild(line);
        }
      })(i);
    }
  }

  // ---------- formas ----------
  function renderShapes(){
    while (svgShapes.lastChild) svgShapes.removeChild(svgShapes.lastChild);
    for (var k=0;k<nodes.length;k++){
      var n = nodes[k];
      if (!n.shape || n.shape==='none') continue;
      var p = toPx(n);
      var el = stage.querySelector('.diagram-node[data-id="'+n.id+'"] .label');
      var w = el ? el.offsetWidth : 40;
      var h = el ? el.offsetHeight : 18;
      var padX = 12, padY = 8;
      var W = w + 2*padX, H = h + 2*padY;
      if (n.shape==='oval' || n.shape==='square'){
        var rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute('x', p.x - W/2);
        rect.setAttribute('y', p.y - H/2);
        rect.setAttribute('width', W);
        rect.setAttribute('height', H);
        rect.setAttribute('rx', n.shape==='oval' ? (H/2) : 8);
        rect.setAttribute('ry', n.shape==='oval' ? (H/2) : 8);
        rect.setAttribute('fill', '#fff');
        rect.setAttribute('stroke', n.color || '#3b82f6');
        rect.setAttribute('stroke-width', '2');
        svgShapes.appendChild(rect);
      } else if (n.shape==='diamond'){
        var pts = [
          (p.x)+','+(p.y - H/2),
          (p.x + W/2)+','+(p.y),
          (p.x)+','+(p.y + H/2),
          (p.x - W/2)+','+(p.y)
        ].join(' ');
        var poly = document.createElementNS('http://www.w3.org/2000/svg','polygon');
        poly.setAttribute('points', pts);
        poly.setAttribute('fill', '#fff');
        poly.setAttribute('stroke', n.color || '#3b82f6');
        poly.setAttribute('stroke-width', '2');
        svgShapes.appendChild(poly);
      }
    }
  }

  // ---------- n√≥s ----------
  function renderNodes(){
    var olds = stage.querySelectorAll('.diagram-node');
    for (var k=0;k<olds.length;k++) olds[k].remove();
    for (var i=0;i<nodes.length;i++){
      (function(node){
        var p=toPx(node);
        var el=document.createElement('div');
        el.className='diagram-node';
        el.dataset.id=String(node.id);
        el.style.cssText = 'position:absolute;left:'+p.x+'px;top:'+p.y+'px;transform:translate(-50%,-50%);cursor:pointer;z-index:1002';
        var lab=document.createElement('span');
        lab.className='label';
        lab.textContent = node.text || ('N'+node.id);
        lab.style.cssText = 'font:14px/1.25 system-ui, Arial; color:'+(node.color||'#3b82f6')+'; background:transparent; display:inline-block;';
        el.appendChild(lab);

        if (selSet.has(node.id)){ el.style.outline='2px dashed #9aa0a6'; el.style.outlineOffset='3px'; }

        el.addEventListener('click', function(e){
          e.stopPropagation();
          var toggle = e.ctrlKey || e.metaKey;
          if (toggle){
            if (selSet.has(node.id)) selSet.delete(node.id); else selSet.add(node.id);
          } else {
            selSet.clear(); selSet.add(node.id);
          }
          renderNodes(); renderShapes();
        });

        el.addEventListener('dblclick', function(e){ e.preventDefault(); openEditor(node); });

        el.addEventListener('contextmenu', function(e){
          e.preventDefault(); e.stopPropagation();
          if (e.ctrlKey || e.metaKey){
            nodes = nodes.filter(function(n){ return n.id !== node.id; });
            links = links.filter(function(L){ return L.fromId !== node.id && L.toId !== node.id; });
            selSet.delete(node.id);
            if (linkSourceId === node.id) linkSourceId = null;
            waitingControl=false; tempCP=null;
            banner.textContent = 'N√≥ removido.'; renderAll(); return;
          }
          linkOnNode(node);
        });

        el.addEventListener('mousedown', function(e){
          if (e.button===0 && e.shiftKey){
            e.preventDefault(); e.stopPropagation();
            linkOnNode(node);
            return;
          }
          if (e.button!==0) return;

          if (selSet.size>0 && selSet.has(node.id)){
            var r = stageRect();
            var xs = [];
            nodes.forEach(function(n){
              if (selSet.has(n.id)) xs.push({n:n, x0:n.xPct, y0:n.yPct});
            });
            // (fix cp) capturar cp0 das curvas cujo par de n√≥s est√° selecionado
            var cps = [];
            links.forEach(function(L){
              if (L.type==='quad' && selSet.has(L.fromId) && selSet.has(L.toId)){
                cps.push({ L:L, cx0:(L.cxPct!=null?L.cxPct:0.5), cy0:(L.cyPct!=null?L.cyPct:0.5) });
              }
            });
            draggingGroup = {startX:e.clientX, startY:e.clientY, rw:r.width, rh:r.height, list:xs, cps:cps};
          } else {
            selSet.clear(); selSet.add(node.id); renderNodes();
            draggingNode = { node: node, el: el };
          }
        });

        stage.appendChild(el);
      })(nodes[i]);
    }
  }

  // ---------- editor ----------
  function closeEditor(){ if (activeInput && activeInput.parentNode) activeInput.parentNode.removeChild(activeInput); activeInput=null; }
  function openEditor(node){
    closeEditor();
    var r=stageRect(), p=toPx(node);
    var inp=document.createElement('input');
    inp.type='text'; inp.value=node.text||''; inp.placeholder='digite...';
    inp.style.cssText='position:fixed;left:'+(Math.round(r.left+p.x+8))+'px;top:'+(Math.round(r.top+p.y-6))+'px;min-width:220px;padding:6px 10px;border:1px solid #888;border-radius:6px;background:#fff;box-shadow:0 2px 6px rgba(0,0,0,.15);z-index:2147483647';
    function commit(){
      var v=(inp.value||'').trim();
      if (v===''){
        nodes = nodes.filter(function(n){return n.id!==node.id;});
        links = links.filter(function(L){return L.fromId!==node.id && L.toId!==node.id;});
        selSet.delete(node.id);
      } else node.text=v;
      closeEditor(); renderAll();
    }
    function cancel(){ closeEditor(); renderAll(); }
    inp.addEventListener('keydown', function(e){ if (e.key==='Enter'){ e.preventDefault(); commit(); } else if (e.key==='Escape'){ e.preventDefault(); cancel(); } });
    inp.addEventListener('blur', commit);
    document.body.appendChild(inp); activeInput=inp; inp.focus(); inp.select();
  }

  // ---------- intera√ß√µes globais ----------
  stage.addEventListener('click', function(e){
    if (activeInput) return;
    if (e.target && e.target.closest('#diagramUI')) return;

    if (suppressNextClick){ suppressNextClick=false; return; }

    if (curveMode && linkSourceId !== null && waitingControl){
      var r = stageRect(), px = e.clientX - r.left, py = e.clientY - r.top;
      tempCP = { cxPct: px / r.width, cyPct: py / r.height };
      waitingControl = false;
      banner.textContent = 'Ponto da curva definido. Agora Direito/Shift no destino.';
      drawLinks();
      return;
    }

    var tn = (e.target && e.target.tagName) || '';
    if (e.target && e.target.closest('.diagram-node')) return;
    if (tn === 'LINE' || tn === 'PATH' || tn === 'CIRCLE') return;

    var r2 = stageRect();
    var px2 = e.clientX - r2.left, py2 = e.clientY - r2.top;
    var node = { id: nextId++, xPct: px2 / r2.width, yPct: py2 / r2.height, text: '', color: currentColor, shape: 'none' };
    nodes.push(node);
    selSet.clear(); selSet.add(node.id);
    renderAll();
    openEditor(node);
  });

  // sele√ß√£o por caixa (Shift/Alt)
  stage.addEventListener('mousedown', function(e){
    if (e.button!==0 || !(e.shiftKey || e.altKey)) return;
    if (e.target && e.target.closest('.diagram-node')) return;
    var r = stageRect();
    var x0 = e.clientX - r.left, y0 = e.clientY - r.top;
    var el = document.createElement('div');
    el.style.cssText = 'position:absolute;border:1px dashed #999;background:rgba(150,150,150,.08);pointer-events:none;z-index:980';
    stage.appendChild(el);
    rubber = {el:el,x0:x0,y0:y0};
  });

  function renderAll(){ drawLinks(); renderNodes(); renderShapes(); }

  function onMove(e){
    if (rubber){
      var r = stageRect(); var x = Math.max(0, Math.min(r.width, e.clientX-r.left));
      var y = Math.max(0, Math.min(r.height, e.clientY-r.top));
      var x0=rubber.x0, y0=rubber.y0;
      var x1=Math.min(x0,x), y1=Math.min(y0,y), x2=Math.max(x0,x), y2=Math.max(y0,y);
      rubber.el.style.left=x1+'px'; rubber.el.style.top=y1+'px';
      rubber.el.style.width=(x2-x1)+'px'; rubber.el.style.height=(y2-y1)+'px';
      return;
    }

    if (draggingNode){
      var r1 = stage.getBoundingClientRect();
      var px = Math.max(0, Math.min(r1.width,  e.clientX - r1.left));
      var py = Math.max(0, Math.min(r1.height, e.clientY - r1.top));
      draggingNode.node.xPct = px / r1.width;
      draggingNode.node.yPct = py / r1.height;
      draggingNode.el.style.left = px + 'px';
      draggingNode.el.style.top  = py + 'px';
      drawLinks(); renderShapes();
    }
    if (draggingGroup){
      var dx = (e.clientX - draggingGroup.startX) / draggingGroup.rw;
      var dy = (e.clientY - draggingGroup.startY) / draggingGroup.rh;

      draggingGroup.list.forEach(function(it){
        it.n.xPct = clamp(it.x0 + dx, 0, 1);
        it.n.yPct = clamp(it.y0 + dy, 0, 1);
      });

      // (fix cp) usar valor inicial do cp
      draggingGroup.cps.forEach(function(it){
        it.L.cxPct = clamp(it.cx0 + dx, 0, 1);
        it.L.cyPct = clamp(it.cy0 + dy, 0, 1);
      });

      renderAll();
    }
    if (draggingLink){
      var dx2 = (e.clientX - draggingLink.startX) / draggingLink.rw;
      var dy2 = (e.clientY - draggingLink.startY) / draggingLink.rh;
      draggingLink.A.xPct = clamp(draggingLink.a0.xPct + dx2, 0, 1);
      draggingLink.A.yPct = clamp(draggingLink.a0.yPct + dy2, 0, 1);
      draggingLink.B.xPct = clamp(draggingLink.b0.xPct + dx2, 0, 1);
      draggingLink.B.yPct = clamp(draggingLink.b0.yPct + dy2, 0, 1);
      // (fix cp) mover cp relativo ao cp0
      if (draggingLink.cp0){
        draggingLink.link.cxPct = clamp(draggingLink.cp0.cxPct + dx2, 0, 1);
        draggingLink.link.cyPct = clamp(draggingLink.cp0.cyPct + dy2, 0, 1);
      }
      renderAll();
    }
    if (draggingCP){
      var r3 = stageRect();
      var cx = Math.max(0, Math.min(r3.width,  e.clientX - r3.left));
      var cy = Math.max(0, Math.min(r3.height, e.clientY - r3.top));
      draggingCP.link.cxPct = cx / r3.width;
      draggingCP.link.cyPct = cy / r3.height;
      drawLinks();
    }
  }
  function onUp(e){
    if (rubber){
      var r = stageRect(); var x = Math.max(0, Math.min(r.width, e.clientX-r.left));
      var y = Math.max(0, Math.min(r.height, e.clientY-r.top));
      var x0=rubber.x0,y0=rubber.y0; var x1=Math.min(x0,x), y1=Math.min(y0,y), x2=Math.max(x0,x), y2=Math.max(y0,y);
      stage.removeChild(rubber.el); rubber=null;
      selSet.clear();
      nodes.forEach(function(n){
        var p = toPx(n);
        if (p.x>=x1 && p.x<=x2 && p.y>=y1 && p.y<=y2) selSet.add(n.id);
      });
      suppressNextClick = true;
      renderNodes();
    }
    draggingNode = null; draggingGroup=null; draggingLink = null; draggingCP = null;
  }
  window.addEventListener('mousemove', onMove);
  window.addEventListener('mouseup', onUp);
  window.addEventListener('resize', renderAll);

  // ---------- export/import ----------
  btnExport.addEventListener('click', function(e){
    e.stopPropagation();
    var payload = { nodes: nodes, links: links };
    var blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
    var a = document.createElement('a'); document.body.appendChild(a);
    a.style.display='none'; a.href = URL.createObjectURL(blob); a.download = 'diagram.json'; a.click();
    setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  });

  btnImport.addEventListener('click', function(e){
    e.stopPropagation();
    var inp = document.createElement('input');
    inp.type = 'file'; inp.accept = 'application/json';
    inp.onchange = function(){
      var f = inp.files && inp.files[0]; if (!f) return;
      var r = new FileReader();
      r.onload = function(){
        try{
          var obj = JSON.parse(r.result);
          nodes = Array.isArray(obj.nodes) ? obj.nodes : [];
          links = Array.isArray(obj.links) ? obj.links : [];
          for (var i=0;i<nodes.length;i++){ if (!nodes[i].color) nodes[i].color = '#3b82f6'; if (!nodes[i].shape) nodes[i].shape='none'; }
          for (var j=0;j<links.length;j++){ if (!links[j].color) links[j].color = '#222'; if (!links[j].type) links[j].type='line'; }
          nextId = (nodes.reduce(function(m,n){ return Math.max(m, n.id||0); }, 0) || 0) + 1;
          linkSourceId=null; waitingControl=false; tempCP=null; selSet.clear();
          banner.textContent = 'Diagrama importado.'; renderAll();
        }catch(err){ banner.textContent = 'Falha ao importar JSON.'; }
      };
      r.readAsText(f);
    };
    inp.click();
  });

  // ---------- HTML stand-alone (SEM GRID) ----------
  function buildStandaloneHTML(){
    function b64(s){ try{ return btoa(unescape(encodeURIComponent(s))); }catch(_){ return btoa(s); } }
    var dataB64 = b64(JSON.stringify({nodes:nodes, links:links}));
    var html = [
'<!doctype html><html lang="pt-BR"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Diagrama</title>',
'<style>html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}#host{position:relative;height:100%;background:linear-gradient(#fff,#fafafa)}#grid{position:absolute;inset:0;pointer-events:none;z-index:0;background:transparent}#ui{position:fixed;left:12px;top:12px;display:flex;gap:8px;flex-wrap:wrap;z-index:9}#ui .tag{background:#e7ffe7;border:1px solid #9cd39c;border-radius:8px;padding:6px 10px}</style></head><body>',
'<div id="ui"><div class="tag"></div></div><div id="host"><div id="grid"></div></div>',
'<script>(function(){',
'var RAW="'+dataB64+'";function u8(s){try{return decodeURIComponent(escape(atob(s)));}catch(_){return atob(s);}}',
'var obj=JSON.parse(u8(RAW)),nodes=obj.nodes||[],links=obj.links||[];',
'var host=document.getElementById("host");var stage=document.createElement("div");stage.style.cssText="position:absolute;inset:0;pointer-events:auto;user-select:none;";host.appendChild(stage);',
'var grid=document.getElementById("grid");function setGrid(on){grid.style.background=on?"repeating-linear-gradient(0deg, rgba(0,0,0,.06) 0 1px, transparent 1px 24px),repeating-linear-gradient(90deg, rgba(0,0,0,.06) 0 1px, transparent 1px 24px),repeating-linear-gradient(0deg, rgba(0,0,0,.10) 0 1px, transparent 1px 120px),repeating-linear-gradient(90deg, rgba(0,0,0,.10) 0 1px, transparent 1px 120px)":"transparent";}setGrid(false);',
'var svgL=document.createElementNS("http://www.w3.org/2000/svg","svg");svgL.setAttribute("width","100%");svgL.setAttribute("height","100%");svgL.style.cssText="position:absolute;inset:0;pointer-events:auto;";stage.appendChild(svgL);var dL=document.createElementNS("http://www.w3.org/2000/svg","defs");var m=document.createElementNS("http://www.w3.org/2000/svg","marker");m.setAttribute("id","arrow");m.setAttribute("markerWidth","10");m.setAttribute("markerHeight","7");m.setAttribute("refX","10");m.setAttribute("refY","3.5");m.setAttribute("orient","auto");var t=document.createElementNS("http://www.w3.org/2000/svg","polygon");t.setAttribute("points","0 0, 10 3.5, 0 7");t.setAttribute("fill","#222");m.appendChild(t);dL.appendChild(m);svgL.appendChild(dL);',
'var svgS=document.createElementNS("http://www.w3.org/2000/svg","svg");svgS.setAttribute("width","100%");svgS.setAttribute("height","100%");svgS.style.cssText="position:absolute;inset:0;pointer-events:none;";stage.appendChild(svgS);',
'function rect(){return stage.getBoundingClientRect();}function tp(p){var r=rect();return{x:p.xPct*r.width,y:p.yPct*r.height};}',
'function drawLinks(){while(svgL.lastChild&&svgL.lastChild!==dL)svgL.removeChild(svgL.lastChild);for(var i=0;i<links.length;i++){(function(i){var L=links[i],A=null,B=null,j;for(j=0;j<nodes.length;j++){if(nodes[j].id===L.fromId){A=nodes[j];break;}}for(j=0;j<nodes.length;j++){if(nodes[j].id===L.toId){B=nodes[j];break;}}if(!A||!B)return;var a=tp(A),b=tp(B);if(L.type==="quad"){var c={x:(L.cxPct||.5)*rect().width,y:(L.cyPct||.5)*rect().height};var path=document.createElementNS("http://www.w3.org/2000/svg","path");path.setAttribute("d","M "+a.x+" "+a.y+" Q "+c.x+" "+c.y+" "+b.x+" "+b.y);path.setAttribute("fill","none");path.setAttribute("stroke",L.color||"#222");path.setAttribute("stroke-width","2");path.setAttribute("marker-end","url(#arrow)");svgL.appendChild(path);}else{var ln=document.createElementNS("http://www.w3.org/2000/svg","line");ln.setAttribute("x1",a.x);ln.setAttribute("y1",a.y);ln.setAttribute("x2",b.x);ln.setAttribute("y2",b.y);ln.setAttribute("stroke",L.color||"#222");ln.setAttribute("stroke-width","2");ln.setAttribute("marker-end","url(#arrow)");svgL.appendChild(ln);}})(i);} }',
'function renderShapes(){while(svgS.lastChild)svgS.removeChild(svgS.lastChild);for(var i=0;i<nodes.length;i++){var n=nodes[i];if(!n.shape||n.shape==="none")continue;var p=tp(n);var W=80,H=32;if(n.shape==="oval"||n.shape==="square"){var r=document.createElementNS("http://www.w3.org/2000/svg","rect");r.setAttribute("x",p.x-W/2);r.setAttribute("y",p.y-H/2);r.setAttribute("width",W);r.setAttribute("height",H);r.setAttribute("rx",n.shape==="oval"?H/2:8);r.setAttribute("ry",n.shape==="oval"?H/2:8);r.setAttribute("fill","#fff");r.setAttribute("stroke",n.color||"#3b82f6");r.setAttribute("stroke-width","2");svgS.appendChild(r);}else if(n.shape==="diamond"){var pts=[(p.x)+","+(p.y-H/2),(p.x+W/2)+","+(p.y),(p.x)+","+(p.y+H/2),(p.x-W/2)+","+(p.y)].join(" ");var poly=document.createElementNS("http://www.w3.org/2000/svg","polygon");poly.setAttribute("points",pts);poly.setAttribute("fill","#fff");poly.setAttribute("stroke",n.color||"#3b82f6");poly.setAttribute("stroke-width","2");svgS.appendChild(poly);}}}',
'function renderNodes(){var olds=stage.querySelectorAll(".diagram-node");for(var k=0;k<olds.length;k++)olds[k].remove();for(var i=0;i<nodes.length;i++){(function(node){var p=tp(node),el=document.createElement("div");el.className="diagram-node";el.dataset.id=String(node.id);el.style.cssText="position:absolute;left:"+p.x+"px;top:"+p.y+"px;transform:translate(-50%,-50%)";var lab=document.createElement("span");lab.className="label";lab.textContent=node.text||("N"+node.id);lab.style.cssText="font:14px/1.25 system-ui, Arial;color:"+(node.color||"#3b82f6")+";background:transparent;display:inline-block";el.appendChild(lab);stage.appendChild(el);})(nodes[i]);}}',
'function paint(){drawLinks();renderNodes();renderShapes();}paint();',
'})();<\/script></body></html>'
    ].join('');
    return html;
  }

  btnHTML.addEventListener('click', function(e){
    e.stopPropagation();
    var html = buildStandaloneHTML();
    var blob = new Blob([html], {type:'text/html'});
    var a = document.createElement('a'); document.body.appendChild(a);
    a.style.display='none'; a.href = URL.createObjectURL(blob); a.download = 'diagram.html'; a.click();
    setTimeout(function(){ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  });

  // limpar / fechar
  btnClear.addEventListener('click', function(e){ e.stopPropagation(); nodes = []; links = []; nextId = 1; linkSourceId = null; waitingControl=false; tempCP=null; selSet.clear(); banner.textContent = 'Diagrama limpo.'; renderAll(); });
  btnClose.addEventListener('click', function(e){ e.stopPropagation(); if (stage && stage.parentNode) stage.parentNode.removeChild(stage); });

  // grid toggle
  btnGrid.addEventListener('click', function(e){
    e.stopPropagation();
    gridOn = !gridOn; setGrid(gridOn);
    btnGrid.textContent = gridOn ? 'grid off' : 'grid on';
  });

  // primeira pintura
  renderAll();
})();

`;


window.onload = function() {
    editor.setValue(codigoPadrao, -1);
    resetarGrafico();
};

   
</script>


<div class="license-info">
  <p>
    Licence under 
    <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank" style="color: gray; text-decoration: none;">
      CC BY-NC-SA 4.0
    </a>
    ¬© 2025 Jos√© Maur√≠cio Schneedorf FS
  </p>
</div>


</div>

<script>
  function alternarTema() {
  document.body.classList.toggle("dark-mode");

  const isDark = document.body.classList.contains("dark-mode");
  const botao = document.getElementById("toggleTheme");
  botao.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
  editor.setTheme(isDark ? "ace/theme/monokai" : "ace/theme/github");
  const layoutEscuro = {
    plot_bgcolor: "#1e1e1e",
    paper_bgcolor: "#1e1e1e",
    font: { color: "#e0e0e0" },
    xaxis: { color: "#e0e0e0", gridcolor: "#444" },
    yaxis: {
          zeroline: true,
          zeroline: true, color: "#e0e0e0", gridcolor: "#444" }
  };

  const layoutClaro = {
    plot_bgcolor: "#ffffff",
    paper_bgcolor: "#ffffff",
    font: { color: "#000000" },
    xaxis: { color: "#000", gridcolor: "#ccc" },
    yaxis: {
          zeroline: true,
          zeroline: true, color: "#000", gridcolor: "#ccc" }
  };

  const layoutNovo = isDark ? layoutEscuro : layoutClaro;

  Plotly.relayout("grafico", layoutNovo);
}

</script>

<script>
function salvarAppCompleto() {
  const gd = document.getElementById("grafico");
  const curvasAtuais = JSON.stringify(gd.data);
  const layoutAtual = JSON.stringify(gd.layout || {});

  let htmlCompleto = document.documentElement.outerHTML;

  // Script que ser√° injetado no HTML salvo para redesenhar o gr√°fico
  const scriptPlotly = `
    <script>
      document.addEventListener("DOMContentLoaded", function() {
        const data = ${curvasAtuais};
        const layout = ${layoutAtual};
        Plotly.newPlot("grafico", data, layout);
      });
    <\\/script>
  `;

</script>


<script>
function salvarProjetoCompleto() {
  const gd = document.getElementById("grafico");
  const curvasStr = JSON.stringify(gd.data);
  const layoutStr = JSON.stringify(gd.layout || {});
  const codigoStr = JSON.stringify(editor.getValue());
  const temaEscuro = document.body.classList.contains("dark-mode");

  let htmlContent = ''
    + '<!DOCTYPE html>\n'
    + '<html lang="pt">\n'
    + '<head>\n'
    + '  <meta charset="UTF-8">\n'
    + '  <title>JSPlotly Projeto Salvo</title>\n'
    + '  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"><\/script>\n'
    + '  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"><\/script>\n'
    + '  <style>\n'
    + '    body { font-family: Arial, sans-serif; margin: 20px; }\n'
    + '    .container { display: flex; justify-content: space-between; align-items: flex-start; }\n'
    + '    #grafico { width: 55%; height: 500px; }\n'
    + '    #editor-container { width: 40%; }\n'
    + '    #editor { width: 100%; height: 350px; border: 1px solid #ccc; }\n'
    + '  </style>\n'
    + '</head>\n'
    + '<body>\n'
    + '  <h2>JSPlotly - Projeto Salvo</h2>\n'
    + '  <div class="container">\n'
    + '    <div id="grafico"></div>\n'
    + '    <div id="editor-container">\n'
    + '      <div id="editor"></div>\n'
    + '    </div>\n'
    + '  </div>\n'
    + '  <script>\n'
    + '    const curvas = ' + curvasStr + ';\n'
    + '    const layout = ' + layoutStr + ';\n'
    + '    const codigo = ' + codigoStr + ';\n'
    + '    const temaEscuro = ' + JSON.stringify(temaEscuro) + ';\n'
    + '    const editor = ace.edit("editor");\n'
    + '    editor.setTheme(temaEscuro ? "ace/theme/monokai" : "ace/theme/github");\n'
    + '    editor.session.setMode("ace/mode/javascript");\n'
    + '    editor.setValue(codigo, -1);\n'
    + '    layout.editable = true;\n'
    + '    Plotly.newPlot("grafico", curvas, layout);\n'
    + '    document.body.classList.toggle("dark-mode", temaEscuro);\n'
    + '    document.getElementById("grafico").on("plotly_click", function(data) {\n'
    + '      const y = data.points[0].y;\n'
    + '      const ctx = new (window.AudioContext || window.webkitAudioContext)();\n'
    + '      const osc = ctx.createOscillator();\n'
    + '      const gain = ctx.createGain();\n'
    + '      osc.type = "sine";\n'
    + '      osc.frequency.setValueAtTime(y, ctx.currentTime);\n'
    + '      osc.connect(gain);\n'
    + '      gain.connect(ctx.destination);\n'
    + '      osc.start();\n'
    + '      osc.stop(ctx.currentTime + 0.4);\n'
    + '    });\n'
    + '  <\/script>\n'
    + '</body>\n'
    + '</html>';

  const blob = new Blob([htmlContent], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "jsplotly_projeto.html";
  a.click();
}
</script>

<script>
function salvarProjetoSomenteGrafico() {
  const gd = document.getElementById("grafico");
  const curvasStr = JSON.stringify(gd.data);
  const layoutStr = JSON.stringify(gd.layout || {});
  const framesData = gd._transitionData && gd._transitionData._frames;
  const framesStr = JSON.stringify(framesData || []);
  const temaEscuro = document.body.classList.contains("dark-mode");

  let htmlContent = ''
    + '<!DOCTYPE html>\n'
    + '<html lang="pt">\n'
    + '<head>\n'
    + '  <meta charset="UTF-8">\n'
    + '  <title>JSPlotly Gr√°fico Exportado</title>\n'
    + '  <script src="https://cdn.plot.ly/plotly-2.20.0.min.js"><\/script>\n'
    + '  <style>\n'
    + '    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background-color: ' + (temaEscuro ? '#1e1e1e' : '#ffffff') + '; color: ' + (temaEscuro ? '#e0e0e0' : '#000000') + '; }\n'
    + '    #grafico { width: 100vw; height: 100vh; }\n'
    + '  </style>\n'
    + '</head>\n'
    + '<body>\n'
    + '  <div id="grafico"></div>\n'
    + '  <script>\n'
    + '    const data = ' + curvasStr + ';\n'
    + '    const layout = ' + layoutStr + ';\n'
    + '    const frames = ' + framesStr + ';\n'
    + '    layout.editable = false;\n'
    + '    Plotly.newPlot("grafico", data, layout).then(function() {\n'
    + '      if (frames && frames.length > 0) {\n'
    + '        Plotly.addFrames("grafico", frames);\n'
    + '        Plotly.animate("grafico", null, { frame: { duration: 500, redraw: true }, transition: { duration: 300 } });\n'
    + '      }\n'
    + '    });\n'
    + '    document.getElementById("grafico").on("plotly_click", function(data) {\n'
    + '      const y = data.points[0].y;\n'
    + '      const ctx = new (window.AudioContext || window.webkitAudioContext)();\n'
    + '      const osc = ctx.createOscillator();\n'
    + '      const gain = ctx.createGain();\n'
    + '      osc.type = "sine";\n'
    + '      osc.frequency.setValueAtTime(y, ctx.currentTime);\n'
    + '      osc.connect(gain);\n'
    + '      gain.connect(ctx.destination);\n'
    + '      osc.start();\n'
    + '      osc.stop(ctx.currentTime + 0.4);\n'
    + '    });\n'
    + '  <\/script>\n'
    + '</body>\n'
    + '</html>';

  const blob = new Blob([htmlContent], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "play.html";
  a.click();
}
</script>




<script>
function salvarCloneJSPlotly() {
  // Captura o c√≥digo do usu√°rio e escapa com seguran√ßa
  const codigoNovo = editor.getValue()
    .replace(/\\/g, '\\\\')
    .replace(/`/g, '\\`')
    .replace(/\$/g, '\\$');

  // Substitui diretamente o valor da vari√°vel codigoPadrao na string
  const novaDefinicao = 'var codigoPadrao = `' + codigoNovo + '`;';
  
  // Extrai o HTML original em partes
  const htmlOriginal = document.documentElement.outerHTML;

  const htmlAtualizado = htmlOriginal.replace(
    /var codigoPadrao = `([\s\S]*?)`;/,
    novaDefinicao
  );

  const blob = new Blob([htmlAtualizado], { type: "text/html" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "JSPlotly.html";
  a.click();
}

function abrirNoChartStudio() {
  const gd = document.getElementById('grafico');
  if (!gd || !gd.data || gd.data.length === 0) {
    alert("N√£o h√° gr√°fico para enviar. Clique em 'add' primeiro.");
    return;
  }

  const dataStr   = JSON.stringify(gd.data || []);
  const layoutStr = JSON.stringify(gd.layout || {});

  // Tenta GET quando o payload √© pequeno (URLs muito grandes podem falhar)
  const urlBase = "https://chart-studio.plotly.com/create/";
  const urlGET  = urlBase
    + "?plotlyData="   + encodeURIComponent(dataStr)
    + "&plotlyLayout=" + encodeURIComponent(layoutStr);

  if ((dataStr.length + layoutStr.length) < 1500) {
    window.open(urlGET, "_blank");
    return;
  }

  // Fallback: POST via form oculto (evita limite de URL)
  const form = document.createElement("form");
  form.method = "POST";
  form.action = urlBase;     // Editor do Chart Studio
  form.target = "_blank";

  const inpData = document.createElement("input");
  inpData.type = "hidden";
  inpData.name = "plotlyData";
  inpData.value = dataStr;

  const inpLayout = document.createElement("input");
  inpLayout.type = "hidden";
  inpLayout.name = "plotlyLayout";
  inpLayout.value = layoutStr;

  form.appendChild(inpData);
  form.appendChild(inpLayout);
  document.body.appendChild(form);
  form.submit();
  document.body.removeChild(form);
}


</script>



</body>
</html>


